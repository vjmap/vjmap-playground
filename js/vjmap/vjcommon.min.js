(function(p,B){typeof exports=="object"&&typeof module<"u"?B(exports,require("vjmap")):typeof define=="function"&&define.amd?define(["exports","vjmap"],B):(p=typeof globalThis<"u"?globalThis:p||self,B(p.vjcommon={},p.vjmap))})(this,function(p,B){"use strict";var _r=Object.defineProperty;var Zr=(p,B,J)=>B in p?_r(p,B,{enumerable:!0,configurable:!0,writable:!0,value:J}):p[B]=J;var L=(p,B,J)=>(Zr(p,typeof B!="symbol"?B+"":B,J),J);const u=(o=>o&&typeof o=="object"&&"default"in o?o:{default:o})(B),rt=Object.freeze(Object.defineProperty({__proto__:null,get MapApp(){return lt},get providerLayers(){return Se},get LayerBase(){return I},get exportDwg(){return ct},get setFeatureProperty(){return R},get cancelDraw(){return Je},get drawPoint(){return yt},get drawLineSting(){return mt},get drawPolygon(){return pt},get drawFillExrusion(){return At},get polygonToPolyline(){return oe},get drawCircle(){return bt},get drawRectangle(){return wt},get drawSlantRectangle(){return Lt},get selectRotate(){return vt},get toBezierCurve(){return Dt},get drawEllipseFill(){return Ct},get drawEllipseEdge(){return St},get drawEllipseFillArc(){return xt},get drawEllipseArc(){return kt},get getGeoJsonBounds(){return Le},get interactiveCreateGeom(){return q},get drawArrow(){return It},get createLineTypePolyline(){return Tt},get createLineTypeCurve(){return Ft},get createHatch(){return Et},get getQueryGeomData(){return Ye},get createOutSymbol(){return Pt},get drawText(){return Qe},get addFeaturesToDraw(){return H},get getPointOnePixelDrawStyleOption(){return Mt},get getTextRefCo(){return We},get modifyDrawText(){return ut},get isTrackFeature(){return te},get setTrackFeatureProperty(){return Ue},get getTrackFeatureProperty(){return N},get addExportRefInfoInText(){return re},get editCadEntity(){return ie},get deleteCadEntity(){return dt},get modifyCadEntity(){return ft},get copyCadEntity(){return gt},get createGeomData(){return z},get loadDataToDraw(){return ht},get CacheDbStorage(){return Ie},get cacheStorage(){return Q},get TsIndexDb(){return W},get initIndexDb(){return xe},get getInstance(){return ke},get switchCadLayers(){return Bt},get switchVectorLayers(){return qe},get setLayerOpacity(){return Ot},get setLayerToLowest(){return Rt},get queryMapData(){return $},get toProperties(){return G},get ProcessDataToFeatureCollection(){return ce},get requestChangeData(){return U},get convertArrayToGeoJson(){return de},get evalDataConvert(){return Te},get runMeasureCmd(){return Vt},get addHighLightSourceLayer(){return _e},get clearHighLightSourceLayer(){return se},get getHighlightEntities(){return Ze},get clearHighlight(){return pe},get selectFeatures(){return Ke},get getMapSnapPoints(){return be},get createUpdateMapStyleObj(){return Gt},get createUpdateMapStyleRasterObj(){return et},get createUpdateMapStyleVectorObj(){return tt},get listenKeyEvent(){return fe},get WmsOverlayMapType(){return Me},get createMapStyleLayerName(){return ee},get getWmsMapsBounds(){return Be},get getWmsDirectTileUrl(){return Re},get getWmsAutoWebBaseMapTileUrl(){return Ve},get getWmsAutoCadBaseMapTileUrl(){return je},get getWmsParamTileUrl(){return Ne},get getWmsTileUrl(){return He},get cad2webCoordinate(){return Ge},get web2cadCoordinate(){return ot},get overlay2BaseCoordinate(){return ze},get base2OverlayCoordinate(){return at},get getEpsgRange(){return nt},get osmProviderTiles(){return it},get tiandituProviderTiles(){return Fe},get gaodeProviderTiles(){return Ee},get loadWebMap(){return Pe},get toMapLayer(){return P},get sleep(){return ne},get execProgram(){return ve},get getShardsTileUrl(){return le},get getTileShards(){return De},get isAlphanumeric(){return ue},get isWebBaseMap(){return j},get getEntityObjectId(){return Y},get transformGeoJsonData(){return O},get transformFourParam(){return Ce}},Symbol.toStringTag,{value:"Module"}));function P(o,s){return{layerId:o.layerId,sourceId:o.sourceId,tag:o.tag,type:o.type,before:o.before,visibleOff:o.visibleOff,...s}}function ne(o){return new Promise(s=>setTimeout(s,o!=null?o:100))}async function ve(o,s,t,e){const r=Object.getPrototypeOf(async function(){}).constructor;return await new r("vjmap","map","mapApp","context","vjcommon",o)(u.default,s,t,e,rt)}const le=(o,s)=>{if(!o)return[o];if(s){let c=s.getService();o=o.replace("{serviceUrl}",c.serverUrl),o=o.replace("{accessToken}",c.accessToken)}let e=/{(\d+-\d+)}/g.exec(o);if(!e)return[o];let r=e[0];if(!r)return[o];r=r.replace("{",""),r=r.replace("}","");let i=r.split("-");if(i.length!=2)return[o];let a=+i[0],n=+i[1];if(n<=a)return[o];let l=[];for(let c=a;c<=n;c++)l.push(o.replace(e[0],c+""));return l},De=o=>{if(!o)return{tileUrl:o,tileShards:""};let t=/{(\d+-\d+)}/g.exec(o);if(!t)return{tileUrl:o,tileShards:""};let e=t[0];if(!e)return{tileUrl:o,tileShards:""};const r=o.replace(e,"{s}");e=e.replace("{",""),e=e.replace("}","");let i=e.split("-");if(i.length!=2)return{tileUrl:o,tileShards:""};let a=+i[0],n=+i[1];if(n<=a)return{tileUrl:o,tileShards:""};let l=[];for(let c=a;c<=n;c++)l.push(c);return{tileUrl:r,tileShards:l.join(",")}},ue=o=>/^[a-zA-Z0-9]+$/.test(o),j=o=>!(o==""||o=="CAD"||o===void 0),Y=o=>{let s="",t=0;for(t=0;t<o.length&&ue(o[t]);t++)s+=o[t];return s},O=(o,s,t,e,r=1,i=0,a=!1)=>u.default.transform.convert(s,n=>{let l=a===!0?u.default.geoPoint(n):o.fromLngLat(u.default.geoPoint(n));return l.transform(t,e,r,i),a===!0?[l.x,l.y]:o.toLngLat(l)}),Ce=(o,s,t,e=!1)=>u.default.transform.convert(s,r=>{let i=e===!0?u.default.geoPoint(r):o.fromLngLat(u.default.geoPoint(r)),a=u.default.coordTransfromByFourParamter(i,t);return e===!0?[a.x,a.y]:o.toLngLat(a)});class I{constructor(){L(this,"map");L(this,"mapLayer");L(this,"visibleOff")}async addLayer(s,t){this.map=s,this.mapLayer=t}setLayerStyle(s,t,e,r){this.mapLayer=P(r,e),this.removeLayer(s,t),this.addLayer(s,P(r,e))}setVisible(s,t,e){this.visibleOff=e}removeLayer(s,t){}getLayerId(){return this.mapLayer.layerId}onSourceDataChange(s,t,e,r){!this.mapLayer||!this.map||t&&this.mapLayer.sourceId!=t||this.mapLayer.disableTimerUpdate||this.visibleOff!==!0&&(this.removeLayer(s,this.mapLayer.layerId),this.addLayer(s,this.mapLayer))}async loadUrlImage(s){return new Promise((t,e)=>{const r=new Image;r.src=s,r.onload=()=>{t(r)},r.onerror=()=>{e(`load image ${s} error`)}})}evalValue(s,t,e){if(typeof s=="string")try{return new Function("props","map","vjmap",s)(t,e,u.default)}catch{}else{let r={};for(let i in s){let a=s[i];if(typeof a=="string"&&a.indexOf("return ")>=0)try{a=new Function("props","map","vjmap",a)(t,e,u.default)}catch{}r[i]=a}return r}}async createAnimateImages(s,t){var a;let e,r=Object.keys(t).filter(n=>n.indexOf("animateImages_")==0),i={};for(let n of r)i[n.replace("animateImages_","")]=t[n];if(t.animateImagesType=="arrow")e=u.default.createArrowAnimateImages(i);else if(t.animateImagesType=="antpath")e=u.default.createAntPathAnimateImages(i);else if(t.animateImagesType=="customImage"){let n=await this.loadUrlImage(t.customImageUrl),l={...i,draw:(c,g,h,f)=>{f.fillColor&&(c.fillStyle=f.fillColor,c.fillRect(0,0,g,h)),c.drawImage(n,0,0,n.width,n.height,0,h/2-n.height/2,g,n.height)}};e=u.default.createAntPathAnimateImages(l)}else if(t.animateImagesType=="animateImages"){e=[];for(let n=0;n<((a=t.animateImageUrls)==null?void 0:a.length);n++){let l=`image_animate_${t.layerId}_${n}`;s.hasImage(l)&&s.removeImage(l),await s.loadImageEx(l,t.animateImageUrls[n]),e.push(l)}}else if(t.animateImagesType=="imageSprites"){let n=await this.loadUrlImage(t.imageSpriteUrl);e=u.default.createAntPathAnimateImages({fromImage:n,...i})}else e=u.default.createAnimateImages(i);return e}setMarkerOptions(s,t){(t==null?void 0:t.minZoom)!==void 0&&s.setMinZoom(t==null?void 0:t.minZoom),(t==null?void 0:t.maxZoom)!==void 0&&s.setMaxZoom(t==null?void 0:t.maxZoom),(t==null?void 0:t.scaleMaxZoom)!==void 0&&s.setScaleMaxZoom(t==null?void 0:t.scaleMaxZoom),(t==null?void 0:t.height)!==void 0&&s.setHeight(t==null?void 0:t.height),(t==null?void 0:t.removeWhenNoInMapView)!==void 0&&s.setRemoveWhenNoInMapView(t==null?void 0:t.removeWhenNoInMapView,t==null?void 0:t.removeWhenNoInMapViewPadding),(t==null?void 0:t.rotation)!==void 0&&s.setRotation(t==null?void 0:t.rotation),(t==null?void 0:t.animationType)!==void 0&&s.setAnimation(t==null?void 0:t.animationType),(t==null?void 0:t.draggable)!==void 0&&s.setDraggable(t==null?void 0:t.draggable),(t==null?void 0:t.rotationAlignment)!==void 0&&s.setRotationAlignment(t==null?void 0:t.rotationAlignment),(t==null?void 0:t.pitchAlignment)!==void 0&&s.setPitchAlignment(t==null?void 0:t.pitchAlignment)}}class Zt extends I{constructor(){super();L(this,"polyline")}async addLayer(t,e){super.addLayer(t,e),this.polyline=new u.default.Polyline(e),this.polyline.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.polyline.hide():this.polyline.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Kt extends I{constructor(){super();L(this,"polygon")}async addLayer(t,e){super.addLayer(t,e),this.polygon=new u.default.Polygon(e),this.polygon.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.polygon.hide():this.polygon.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Jt extends I{constructor(){super();L(this,"symbol")}async addLayer(t,e){super.addLayer(t,e),this.symbol=new u.default.Symbol(e),this.symbol.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.symbol.hide():this.symbol.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Yt extends I{constructor(){super();L(this,"circle")}async addLayer(t,e){super.addLayer(t,e),this.circle=new u.default.Circle(e),this.circle.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.circle.hide():this.circle.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Qt extends I{constructor(){super();L(this,"fillExtrusion")}async addLayer(t,e){super.addLayer(t,e),this.fillExtrusion=new u.default.FillExtrusion(e),this.fillExtrusion.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.fillExtrusion.hide():this.fillExtrusion.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class qt extends I{constructor(){super();L(this,"heatmap")}async addLayer(t,e){super.addLayer(t,e),this.heatmap=new u.default.Heatmap(e),this.heatmap.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.heatmap.hide():this.heatmap.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Xt extends I{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){var n,l,c;if(r=this.evalValue(r,e,i),r.customHtml){let g=this.evalValue(r.customHtml,e,i);r.element=g}else if(r.customImage){let g=document.createElement("div");g.className="marker",r.customImage.toLowerCase().indexOf("<svg")==0&&(r.customImage="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(r.customImage)))),g.style.backgroundImage=`url("${r.customImage}")`,g.style.width=((n=r.customImageWidth)!=null?n:40)+"px",g.style.height=((l=r.customImageHeight)!=null?l:40)+"px",g.style.backgroundSize="100%",r.element=g}let a=u.default.createMarker(r);if(a.setLngLat(t).addTo(i),r.animationType&&a.setAnimation(r.animationType),r.popupHtml){let g=new u.default.Popup({offset:(c=r.popupOffset)!=null?c:[0,0],anchor:r.popupAnchor,closeButton:r.closeButton,closeOnClick:r.closeOnClick,closeOnMove:r.closeOnMove,focusAfterOpen:r.focusAfterOpen,className:r.className,maxWidth:r.maxWidth}),h=r.popupHtml,f=this.evalValue("return `"+h+"`",e,i);g.setHTML(f),a.setPopup(g)}this.markers=this.markers||[],this.markers.push(a)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class $t extends I{constructor(){super();L(this,"popups")}createPopup(t,e,r,i){var c;let a=new u.default.Popup({offset:(c=r.offset)!=null?c:[0,0],anchor:r.anchor,closeButton:r.closeButton,closeOnClick:r.closeOnClick,closeOnMove:r.closeOnMove,focusAfterOpen:r.focusAfterOpen,className:r.className,maxWidth:r.maxWidth}),n=r.html,l=this.evalValue("return `"+n+"`",e,i);a.setHTML(l).setLngLat(t).addTo(i),this.popups=this.popups||[],this.popups.push(a)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createPopup(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createPopup(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.popups)i.getElement().style.display=r?"none":""}removeLayer(t,e){if(!!this.popups){for(let r of this.popups)r.remove();this.popups=[],super.removeLayer(t,e)}}}class er extends I{constructor(){super();L(this,"animateLine")}async addLayer(t,e){var n;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=await this.createAnimateImages(t,e),a={...e};delete a.layerId,delete a.sourceId,this.animateLine=u.default.createAnimateLineLayer(t,r,{animateImages:i,speed:(n=e.speed)!=null?n:1,...a})}getLayerId(){return this.animateLine.layerId}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.animateLine.stopAnimation(),this.animateLine.polyline.hide()):(this.animateLine.polyline.show(),this.animateLine.startAnimation())}removeLayer(t,e){this.animateLine.remove(),super.removeLayer(t,e)}}class tr extends I{constructor(){super();L(this,"animateSymbol")}async addLayer(t,e){var n;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=await this.createAnimateImages(t,e),a={...e};delete a.layerId,delete a.sourceId,this.animateSymbol=u.default.createAnimateSymbolLayer(t,r,{animateImages:i,speed:(n=e.speed)!=null?n:1,...a})}getLayerId(){return this.animateSymbol.layerId}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.animateSymbol.stopAnimation(),this.animateSymbol.symbol.hide()):(this.animateSymbol.symbol.show(),this.animateSymbol.startAnimation())}removeLayer(t,e){this.animateSymbol.remove(),super.removeLayer(t,e)}}class rr extends I{constructor(){super();L(this,"animateFill")}async addLayer(t,e){var n;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=await this.createAnimateImages(t,e),a={...e};delete a.layerId,delete a.sourceId,this.animateFill=u.default.createAnimateFillLayer(t,r,{animateImages:i,speed:(n=e.speed)!=null?n:1,...a})}getLayerId(){return this.animateFill.layerId}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.animateFill.stopAnimation(),this.animateFill.polygon.hide()):(this.animateFill.polygon.show(),this.animateFill.startAnimation())}removeLayer(t,e){this.animateFill.remove(),super.removeLayer(t,e)}}class sr extends I{constructor(){super();L(this,"sourceId");L(this,"events");this.events=[]}async createCluster(t,e){var g,h,f,d,m;this.sourceId="cluster-points"+u.default.RandomID();let r=t.getSourceData(e.sourceId);t.addSource(this.sourceId,{type:"geojson",data:r,cluster:!0,clusterMaxZoom:(g=e.clusterMaxZoom)!=null?g:10,clusterRadius:(h=e.clusterRadius)!=null?h:60});let i=(f=e.outerColors)!=null?f:[[1e3,"rgba(253, 156, 115, 0.6)"],[100,"rgba(241, 211, 87, 0.6)"],[0,"rgba(181, 226, 140, 0.6)"]];i.forEach((y,b)=>{var A;t.addLayer({id:"point-outer-cluster-"+this.sourceId+b,type:"circle",source:this.sourceId,paint:{"circle-color":y[1],"circle-radius":(A=e.outerCircleRadius)!=null?A:20},filter:b===0?[">=","point_count",y[0]]:["all",[">=","point_count",y[0]],["<","point_count",i[b-1][0]]]})});let a=(d=e.innerColors)!=null?d:[[1e3,"rgba(241, 128, 23, 0.6)"],[100,"rgba(240, 194, 12, 0.6)"],[0,"rgba(110, 204, 57, 0.6)"]];a.forEach((y,b)=>{var A;t.addLayer({id:"point-inner-cluster-"+this.sourceId+b,type:"circle",source:this.sourceId,paint:{"circle-color":y[1],"circle-radius":(A=e.innerCircleRadius)!=null?A:15},filter:b===0?[">=","point_count",y[0]]:["all",[">=","point_count",y[0]],["<","point_count",a[b-1][0]]]})}),t.addLayer({id:"cluster-count"+this.sourceId,type:"symbol",source:this.sourceId,filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["simsun"],"text-size":(m=e.clusterTextSize)!=null?m:12}}),t.addLayer({...t.properties({...e}),id:"unclustered-point"+this.sourceId,type:"symbol",source:this.sourceId,filter:["!",["has","point_count"]]});for(let y=0;y<i.length;y++){let b="point-outer-cluster-"+this.sourceId+y;const A=D=>{var x;let w=t.queryRenderedFeatures(D.point,{layers:[b]}),C=w[0].properties.cluster_id;(x=t.getSource(this.sourceId))==null||x.getClusterExpansionZoom(C,(k,T)=>{k||t.easeTo({center:w[0].geometry.coordinates,zoom:T})})};t.on("click",b,A),this.events.push(["click",b,A]);const v=D=>{t.getCanvas().style.cursor="pointer"};t.on("mouseenter",b,v),this.events.push(["mouseenter",b,v]);const S=D=>{t.getCanvas().style.cursor=""};t.on("mouseleave",b,S),this.events.push(["mouseleave",b,S])}const n=y=>{var A;let b=y.features[0].geometry.coordinates.slice();if(y.features[0].properties.index,e.popupHtml){let v=new u.default.Popup({offset:(A=e.popupOffset)!=null?A:[0,0],anchor:e.popupAnchor,closeButton:e.closeButton,closeOnClick:e.closeOnClick,closeOnMove:e.closeOnMove,focusAfterOpen:e.focusAfterOpen,className:e.className,maxWidth:e.maxWidth});v.setLngLat(b);let S=e.popupHtml,D=this.evalValue("return `"+S+"`",y.features[0].properties,this.map);v.setHTML(D).addTo(t)}};t.on("click","unclustered-point"+this.sourceId,n),this.events.push(["click","unclustered-point"+this.sourceId,n]);const l=()=>{t.getCanvas().style.cursor="pointer"};t.on("mouseenter","unclustered-point"+this.sourceId,l),this.events.push(["mouseenter","unclustered-point"+this.sourceId,l]);const c=()=>{t.getCanvas().style.cursor=""};t.on("mouseleave","unclustered-point"+this.sourceId,c),this.events.push(["mouseleave","unclustered-point"+this.sourceId,c])}async addLayer(t,e){super.addLayer(t,e),this.createCluster(t,e)}setVisible(t,e,r){super.setVisible(t,e,r),r?t.hideSource(this.sourceId):t.showSource(this.sourceId)}removeLayer(t,e){if(this.events){for(let r of this.events)t.off(r[0],r[1],r[1]);this.events=[]}t.removeSourceEx(this.sourceId),super.removeLayer(t,e)}}class ir extends I{constructor(){super();L(this,"markerCluster");L(this,"popupInfo");this.popupInfo=null}getColor(t,e,r){t=t!=null?t:[[0,"#00FFFF","#00FFFF"],[5,"#F0F","#80FF00"],[10,"#00F","#FFFF00"],[1e3,"#FFF","#FF3D3D"]];for(let i=0;i<t.length;i++)if(e<=t[i][0])return r?t[i][1]:t[i][2];return t.length==0?"#00FFFF":r?t[t.length-1][1]:t[t.length-1][2]}async addLayer(t,e){var c,g,h,f;super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features,a=[];for(let d=0;d<i.length;d++){let m=i[d].geometry;if(m.type=="Point"&&a.push({point:t.fromLngLat(m.coordinates),properties:{...i[d].properties}}),e.isDrawLinePoint){let y=[];m.type=="LineString"?y=m.coordinates:m.type=="Polygon"&&(y=m.coordinates[0]);for(let b of y)a.push({point:t.fromLngLat(b),properties:{...i[d].properties}})}}const n=(d,m)=>{if(m.length<=1){let y={...e};y=this.evalValue(y,d.properties,this.map);let b=new u.default.Marker({...e,color:this.getColor(y.textColors,m.length)}).setLngLat(this.map.toLngLat(d.point));return y.popupHtml&&b.on("click",A=>{var D;this.popupInfo?this.popupInfo.remove():this.popupInfo=new u.default.Popup({offset:(D=y.popupOffset)!=null?D:[0,0],anchor:y.popupAnchor,closeButton:y.closeButton,closeOnClick:y.closeOnClick,closeOnMove:y.closeOnMove,focusAfterOpen:y.focusAfterOpen,className:y.className,maxWidth:y.maxWidth});let v=y.popupHtml,S=this.evalValue("return `"+v+"`",b.clusterMarkersData[0].properties,this.map);this.popupInfo.setHTML(S),this.popupInfo.setLngLat(b.getLngLat()).addTo(this.map)}),b}else{let y=new u.default.Text({text:m.length+"",anchor:"center",offset:[0,0],style:{"background-color":this.getColor(e.textColors,m.length),color:this.getColor(e.textColors,m.length,!0),...e.textStyle}});return y.setLngLat(this.map.toLngLat(d.point)).addTo(this.map),y.on("click",b=>{if(y.clusterMarkersData.length===1)return;let A=y.clusterMarkersData.map(D=>D.point),v=u.default.geoBounds();v.update(A);let S=this.map.toLngLat(v);this.map.fitBounds(S,{padding:40})}),y}},l=(d,m,y)=>{if(y instanceof u.default.Text)if(m.length>1)y.setText(m.length+"");else return y.remove(),n(d,m);else if(m.length>1)return y.remove(),n(d,m)};this.markerCluster=new u.default.MarkerCluster({data:a,createMarker:n,updateMarker:l,allowOverlap:(c=e.allowOverlap)!=null?c:!1,allowOverlapMaxZoom:(g=e.allowOverlapMaxZoom)!=null?g:4,markerWidth:(h=e.markerWidth)!=null?h:28,markerHeight:(f=e.markerHeight)!=null?f:40}),this.markerCluster.addTo(t)}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?this.markerCluster.hide():this.markerCluster.show()}removeLayer(t,e){this.markerCluster.remove(),this.popupInfo&&(this.popupInfo.remove(),this.popupInfo=null),super.removeLayer(t,e)}}class or extends I{constructor(){super();L(this,"texts")}createText(t,e,r,i){var c;r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.Text({...r,text:n});if(this.setMarkerOptions(l,r),l.setLngLat(t).addTo(i),r.animationType&&l.setAnimation(r.animationType),r.popupHtml){let g=new u.default.Popup({offset:(c=r.popupOffset)!=null?c:[0,0],anchor:r.popupAnchor,closeButton:r.closeButton,closeOnClick:r.closeOnClick,closeOnMove:r.closeOnMove,focusAfterOpen:r.focusAfterOpen,className:r.className,maxWidth:r.maxWidth}),h=r.popupHtml,f=this.evalValue("return `"+h+"`",e,i);g.setHTML(f),l.setPopup(g)}this.texts=this.texts||[],this.texts.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createText(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createText(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.texts)r?i.hide():i.show()}removeLayer(t,e){if(!!this.texts){for(let r of this.texts)r.remove();this.texts=[],super.removeLayer(t,e)}}}class ar extends I{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.BreathingApertureMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class nr extends I{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.RotatingApertureMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class lr extends I{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.HaloRingMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class ur extends I{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.DiffusedApertureMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class cr extends I{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.RotatingTextBorderMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class dr extends I{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.FluorescenceMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class fr extends I{constructor(){super();L(this,"polyline")}async addLayer(t,e){super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=[],a=r.features;for(let l=0;l<a.length;l++){let c=a[l].geometry;if(c.type!="LineString")continue;let g=c.coordinates;if(c.coordinates.length>2){const h=u.default.polylineToBezierCurve(t.fromLngLat(c.coordinates).map(f=>[f.x,f.y]));g=u.default.bezierCurveToPolyline(h),i.push({points:t.toLngLat(g),properties:c.properties})}else i.push({points:g,properties:c.properties})}let n={...e};delete n.layerId,delete n.sourceId,this.polyline=new u.default.Polyline({data:i,...n}),this.polyline.addTo(t,e.before)}getLayerId(){return this.polyline.layerId}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?this.polyline.hide():this.polyline.show()}removeLayer(t,e){this.polyline&&this.polyline.remove(),super.removeLayer(t,e)}}class gr extends I{constructor(){super();L(this,"fillExtrusion");L(this,"anim")}async addLayer(t,e){var l,c;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=[],a=r.features;for(let g=0;g<a.length;g++){let h=a[g].geometry,f=[];if(h.type=="LineString")f.push(h.coordinates);else if(h.type=="MultiLineString")f.push(...h.coordinates);else continue;if(e.isBreakLine){let d=[];for(let m of f){for(let y=0;y<m.length-1;y++)d.push([m[y],m[y+1]]);f=d}}for(const d of f){let m=t.fromLngLat(d),y=u.default.polylineMarginToPolygon(m,{offset:(l=e.offsetLine)!=null?l:10});i.push({points:t.toLngLat(y),properties:{...a[g].properties,path:y}})}}let n={...e};if(delete n.layerId,delete n.sourceId,this.fillExtrusion=new u.default.FillExtrusion({data:i,...n}),this.fillExtrusion.addTo(t,e.before),e.anmiDuration){const g=u.default.cloneDeep(this.fillExtrusion.getData());this.anim=u.default.createAnimation({from:0,to:1,repeatType:(c=e.anmiRepeatType)!=null?c:"reverse",repeat:e.anmiRepeat||1/0,duration:e.anmiDuration*1e3,ease:u.default.linear,onUpdate:h=>{var d;const f=this.fillExtrusion.getData();for(let m=0;m<f.features.length;m++){const y=h,b=g.features[m].properties,A=u.default.interpolatePointsByRatio(b.path,y);if(A.length>1){const v=u.default.polylineMarginToPolygon(A,{offset:(d=e.offsetLine)!=null?d:10}),S=u.default.createPolygonGeoJson(t.toLngLat(v));S.features[0]&&S.features[0].geometry&&(f.features[m].geometry.coordinates=S.features[0].geometry.coordinates)}}this.fillExtrusion.setData(f)}})}}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.fillExtrusion.hide(),this.anim&&this.anim.stop()):(this.fillExtrusion.show(),this.anim&&this.anim.start())}removeLayer(t,e){this.fillExtrusion&&this.fillExtrusion.remove(),this.anim&&(this.anim.stop(),this.anim=null),super.removeLayer(t,e)}}class hr extends I{constructor(){super();L(this,"polylineArrows")}async addLayer(t,e){super.addLayer(t,e),this.polylineArrows=this.polylineArrows||[];let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type!="LineString")continue;await t.onLoad(!0);let l=n.coordinates,c=this.evalValue(e,i[a].properties,t);delete c.layerId,delete c.sourceId;let g=new u.default.PolylineArrow({...c,path:l});g.addTo(t,e.before),this.polylineArrows.push(g)}}getLayerId(){return this.polylineArrows.map(t=>t.id)}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){if(super.setVisible(t,e,r),this.polylineArrows&&this.polylineArrows.length)for(let i of this.polylineArrows)r?i.hide():i.show()}removeLayer(t,e){if(this.polylineArrows&&this.polylineArrows.length){for(let r of this.polylineArrows)r.remove();this.polylineArrows=[]}super.removeLayer(t,e)}}class yr extends I{constructor(){super();L(this,"polylineArrows");L(this,"symbolSourcedIds");L(this,"anims")}async addLayer(t,e){super.addLayer(t,e),this.polylineArrows=this.polylineArrows||[],this.symbolSourcedIds=this.symbolSourcedIds||[],this.anims=this.anims||[];let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type!="LineString")continue;await t.onLoad(!0);let l=n.coordinates,c=this.evalValue(e,i[a].properties,t);delete c.layerId,delete c.sourceId;let g=new u.default.PolylineArrow({...c,path:l});g.addTo(t,e.before),this.polylineArrows.push(g);let h;if(e.iconImage){let m=Object.keys(e).filter(A=>A.indexOf("symbol")==0||A.indexOf("icon")==0||A.indexOf("text")==0),y={};for(let A of m)y[A]=e[A];let b=u.default.RandomID();h="path_animi_source_"+b,t.addGeoJSONSource(h),t.addSymbolLayer("path_animi_layer_"+b,h,{iconRotate:["get","bearing"],iconRotationAlignment:"map",iconAllowOverlap:!0,iconIgnorePlacement:!0,...y}),this.symbolSourcedIds.push(h)}let f=c.fps||10;const d=g.animate(100,f,!0,m=>{},(m,y)=>{if(m!==u.default.FrameAnimationStatus.Run||!h)return;const b=u.default.geoPoint(y.endPnt).angleTo(u.default.geoPoint(y.startPnt)),A=u.default.createPointGeoJson({point:y.endPnt,properties:{...i[a].properties,bearing:u.default.radToDeg(-b)}});t.setData(h,A)});this.anims.push(d)}}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){if(super.setVisible(t,e,r),this.anims&&this.anims.length)for(let i of this.anims)r?i.stop():i.start();if(this.polylineArrows&&this.polylineArrows.length){for(let i of this.polylineArrows)r?i.hide():i.show();for(let i of this.symbolSourcedIds)r?t.hideSource(i):t.showSource(i)}}removeLayer(t,e){if(this.anims&&this.anims.length){for(let r of this.anims)r.stop();this.anims=[]}if(this.polylineArrows&&this.polylineArrows.length){for(let r of this.polylineArrows)r.remove();this.polylineArrows=[]}if(this.symbolSourcedIds&&this.symbolSourcedIds.length){for(let r of this.symbolSourcedIds)t.removeSourceEx(r);this.symbolSourcedIds=[]}super.removeLayer(t,e)}}class mr extends I{constructor(){super();L(this,"line");L(this,"symbol");L(this,"anim")}async addLayer(t,e){var f;super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features,a=[],n=[];for(let d=0;d<i.length;d++){let m=i[d].geometry;if(m.type!="LineString")continue;let y=t.fromLngLat(m.coordinates);e.drawPath&&n.push({points:t.toLngLat(y),properties:{...i[d].properties}});const b=u.default.geoPoint(y[1]).angleTo(u.default.geoPoint(y[0]));a.push({point:t.toLngLat(y[0]),properties:{...i[d].properties,bearing:u.default.radToDeg(-b),path:y}})}if(n.length>0){let d=Object.keys(e).filter(y=>y.indexOf("line")==0),m={};for(let y of d)m[y]=e[y];this.line=new u.default.Polyline({data:n,...m}),this.line.addTo(t)}let l=Object.keys(e).filter(d=>d.indexOf("symbol")==0||d.indexOf("icon")==0||d.indexOf("text")==0),c={};for(let d of l)c[d]=e[d];this.symbol=new u.default.Symbol({data:a,iconAllowOverlap:!0,iconRotationAlignment:"map",...c,iconRotate:["get","bearing"]}),this.symbol.addTo(t,e.before);const g=u.default.cloneDeep(this.symbol.getData());let h=0;this.anim=u.default.createAnimation({from:0,to:1,repeatType:(f=e.anmiRepeatType)!=null?f:"reverse",repeat:e.anmiRepeat||1/0,duration:e.anmiDuration*1e3,ease:u.default.linear,onUpdate:d=>{let m=h>d;h=d;const y=this.symbol.getData();for(let b=0;b<y.features.length;b++){const A=d,v=g.features[b].properties,S=u.default.interpolatePointsByRatio(v.path,A);if(S.length>1){let D=S[S.length-2],w=S[S.length-1],C=0;m?C=u.default.geoPoint(D).angleTo(u.default.geoPoint(w)):C=u.default.geoPoint(w).angleTo(u.default.geoPoint(D)),y.features[b].properties.bearing=u.default.radToDeg(-C);const x=u.default.createPointGeoJson(t.toLngLat(w));x.features[0]&&x.features[0].geometry&&(y.features[b].geometry.coordinates=x.features[0].geometry.coordinates)}}this.symbol.setData(y)}})}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.anim.stop(),this.symbol.hide(),this.line&&this.line.hide()):(this.line&&this.line.show(),this.symbol.show(),this.anim.start())}removeLayer(t,e){this.anim.stop(),this.symbol.remove(),this.line&&this.line.remove(),super.removeLayer(t,e)}}class pr extends I{constructor(){super();L(this,"fillExtrusion");L(this,"anim")}async addLayer(t,e){var l;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=[],a=r.features;for(let c=0;c<a.length;c++){let g=a[c].geometry;g.type=="Polygon"&&i.push({points:g.coordinates,properties:{...g.properties}})}let n={...e};if(delete n.layerId,delete n.sourceId,this.fillExtrusion=new u.default.FillExtrusion({data:i,...n,fillExtrusionHeight:["get","height"]}),this.fillExtrusion.addTo(t,e.before),e.anmiDuration){const c=u.default.cloneDeep(this.fillExtrusion.getData()),g=h=>u.default.interpolate([0,1],[{height:0},{height:c.features[h].properties.height||5e5}]);this.anim=u.default.createAnimation({from:0,to:1,repeatType:(l=e.anmiRepeatType)!=null?l:"loop",repeat:e.anmiRepeat||1/0,duration:e.anmiDuration*1e3,onUpdate:h=>{const f=this.fillExtrusion.getData();for(let d=0;d<f.features.length;d++){const m=g(d)(h);f.features[d].properties.height=m.height}this.fillExtrusion.setData(f)}})}}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.fillExtrusion.hide(),this.anim&&this.anim.stop()):(this.fillExtrusion.show(),this.anim&&this.anim.start())}removeLayer(t,e){this.fillExtrusion&&this.fillExtrusion.remove(),this.anim&&(this.anim.stop(),this.anim=null),super.removeLayer(t,e)}}class Ar extends I{constructor(){super();L(this,"sourceId")}async addLayer(t,e){super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i="geojson_source_"+u.default.RandomID();this.sourceId=i,t.addGeoJSONSource(i,r);let a=Object.keys(e).filter(f=>f.indexOf("fill")==0),n={};for(let f of a)n[f]=e[f];t.addFillLayer(i+"-layer-polygons",i,{source:i,...n,filter:["==",["geometry-type"],"Polygon"]});let l=Object.keys(e).filter(f=>f.indexOf("line")==0),c={};for(let f of l)c[f]=e[f];t.addLineLayer(i+"-layer-lines",i,{source:i,...c,filter:["==",["geometry-type"],"LineString"]});let g=Object.keys(e).filter(f=>f.indexOf("circle")==0),h={};for(let f of g)h[f]=e[f];t.addCircleLayer(i+"-layer-points",i,{source:i,...h,filter:["==",["geometry-type"],"Point"]})}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),this.sourceId&&(r?t.hideSource(this.sourceId):t.showSource(this.sourceId))}removeLayer(t,e){this.sourceId&&(t.removeSourceEx(this.sourceId),this.sourceId=void 0),super.removeLayer(t,e)}}class br extends I{constructor(){super();L(this,"draw");L(this,"sourceID")}async addLayer(t,e){super.addLayer(t,e),this.sourceID=e.sourceId;let r=t.getSourceData(e.sourceId);e.entColorToHtmlColor&&r&&r.features&&r.features.forEach(a=>{a.properties&&typeof a.properties.color=="number"&&(a.properties.color=t.entColorToHtmlColor(a.properties.color))});const i=u.default.cloneDeep(u.default.Draw.defaultOptions());i.isActionDrawMode=!0,this.draw=new u.default.Draw.Tool(i),t.addControl(this.draw,"top-right"),this.draw.set(r)}setVisible(t,e,r){if(super.setVisible(t,e,r),!!this.draw)if(r)this.draw.set({type:"FeatureCollection",features:[]});else{let i=t.getSourceData(this.sourceID);this.draw.set(i)}}removeLayer(t,e){this.draw&&(this.map.removeControl(this.draw),this.draw=null),super.removeLayer(t,e)}}class wr extends I{constructor(){super()}async addLayer(s,t){super.addLayer(s,t),s.addRasterLayer(t.layerId,t.sourceId,t,t.before)}setVisible(s,t,e){super.setVisible(s,t,e),e?s.hide(t):s.show(t)}removeLayer(s,t){s.removeLayerEx(t),super.removeLayer(s,t)}}class Lr extends I{constructor(){super();L(this,"layers")}async addLayer(t,e){super.addLayer(t,e);const r=t.getService().vectorStyle();this.layers=r.layers;for(let i of this.layers)i.source=e.sourceId,i.id=i.id.replace("vector-",e.layerId+"-"),t.addLayer(i)}setVisible(t,e,r){if(super.setVisible(t,e,r),r)for(let i of this.layers)t.hide(i.id);else for(let i of this.layers)t.show(i.id)}removeLayer(t,e){for(let r of this.layers)t.removeLayerEx(r.id);super.removeLayer(t,e)}}class vr extends I{constructor(){super();L(this,"overlay")}createDivOverlay(t,e,r){let i=this.evalValue(e,t,r);if(!!i.bounds&&!!i.width&&!!i.height){if(Array.isArray(i.bounds)&&i.bounds.length==2&&(i.bounds=new u.default.GeoBounds(u.default.geoPoint(i.bounds[0]),u.default.geoPoint(i.bounds[1]))),i.customHtml){let a=this.evalValue(e.customHtml,t,r);i.element=a}else if(i.customImage){i.customImage.toLowerCase().indexOf("<svg")==0&&(i.customImage="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(e.customImage))));const a=document.createElement("img");a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.width=i.width+"px",a.style.height=i.height+"px",a.src=i.customImage,a.style.pointerEvents="none",i.element=a}!i.element||(this.overlay=new u.default.DivOverlay(i),this.overlay.addTo(r))}}async addLayer(t,e){super.addLayer(t,e),this.createDivOverlay({},e,t)}setVisible(t,e,r){super.setVisible(t,e,r),this.overlay&&this.overlay.setVisible(!r)}removeLayer(t,e){this.overlay&&this.overlay.remove(),super.removeLayer(t,e)}}class Dr extends I{constructor(){super();L(this,"overlay")}async addLayer(t,e){super.addLayer(t,e),this.overlay=new u.default.SvgOverlay(e),this.overlay.addTo(t)}setVisible(t,e,r){super.setVisible(t,e,r),this.overlay&&this.overlay.divOverlay&&this.overlay.divOverlay.setVisible(!r)}removeLayer(t,e){this.overlay&&this.overlay.remove(),super.removeLayer(t,e)}}class Cr extends I{constructor(){super();L(this,"background")}async addLayer(t,e){super.addLayer(t,e),this.background=new u.default.BackgroundLayer(e),this.background.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.background.hide():this.background.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}}class Sr extends I{constructor(){super();L(this,"sky")}async addLayer(t,e){super.addLayer(t,e),this.sky=new u.default.SkyLayer(e),this.sky.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.sky.hide():this.sky.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}}const Se={line:Zt,fill:Kt,symbol:Jt,marker:Xt,popup:$t,circle:Yt,fillExtrusion:Qt,heatmap:qt,animateLine:er,animateSymbol:tr,animateFill:rr,symbolCluster:sr,markerCluster:ir,text:or,breathingMarker:ar,rotatingMarker:nr,haloRingMarker:lr,diffusedMarker:ur,textBorderMarker:cr,fluorescenceMarker:dr,curve:fr,lineExtrusions:gr,arrowLine:hr,pathAnimate:yr,symbolPathAnimate:mr,fillExtrusionsAnimate:pr,geojson:Ar,draw:br,raster:wr,vector:Lr,divOverlay:vr,svgOverlay:Dr,background:Cr,sky:Sr},V=class{constructor({dbName:s,version:t,tables:e}){L(this,"dbName","");L(this,"version",1);L(this,"tableList",[]);L(this,"db",null);L(this,"queue",[]);this.dbName=s,this.version=t,this.tableList=e}static getInstance(s){var e,r;V._instance=(e=V._instance)!=null?e:{};const t=(r=s==null?void 0:s.dbName)!=null?r:"";return V._instance[t]||(V._instance[t]=new V(s)),V._instance[t]}queryAll({tableName:s}){const t=[];return this.commitDb(s,e=>e.openCursor(),"readonly",(e,r)=>{this.cursor_success(e,{condition:()=>!0,handler:({currentValue:i})=>t.push(i),success:()=>r(t)})})}query({tableName:s,condition:t}){const e=[];return this.commitDb(s,r=>r.openCursor(),"readonly",(r,i)=>{this.cursor_success(r,{condition:t,handler:({currentValue:a})=>e.push(a),success:()=>i(e)})})}query_by_keyValue({tableName:s,key:t,value:e}){return this.commitDb(s,r=>r.index(t).get(e),"readonly",(r,i)=>{i(r.target.result||null)})}query_by_primaryKey({tableName:s,value:t}){return this.commitDb(s,e=>e.get(t),"readonly",(e,r)=>{r(e.target.result||null)})}update({tableName:s,condition:t,handle:e}){const r=[];return this.commitDb(s,i=>i.openCursor(),"readwrite",(i,a)=>{this.cursor_success(i,{condition:t,handler:({currentValue:n,cursor:l})=>{const c=e(n);r.push(c),l.update(c)},success:()=>{a(r)}})})}update_by_primaryKey({tableName:s,value:t,handle:e}){return this.commitDb(s,r=>r.get(t),"readwrite",(r,i,a)=>{const n=r.target.result;if(!n){i(null);return}const l=e(n);a.put(l),i(l)})}insert({tableName:s,data:t}){return this.commitDb(s,void 0,"readwrite",(e,r,i)=>{t instanceof Array?t.forEach(a=>i.put(a)):i.put(t),r()})}delete({tableName:s,condition:t}){const e=[];return this.commitDb(s,r=>r.openCursor(),"readwrite",(r,i)=>{this.cursor_success(r,{condition:t,handler:({currentValue:a,cursor:n})=>{e.push(a),n.delete()},success:()=>{i(e)}})})}delete_by_primaryKey({tableName:s,value:t}){return this.commitDb(s,e=>e.delete(t),"readwrite",(e,r)=>{r()})}open_db(){return new Promise((s,t)=>{const e=window.indexedDB.open(this.dbName,this.version);e.onerror=r=>{t(r)},e.onsuccess=r=>{this.db=r.target.result;let i;for(;i=this.queue.pop();)i();s(this)},e.onupgradeneeded=r=>{this.tableList.forEach(i=>{this.create_table(r.target.result,i)})}})}close_db(){return new Promise((s,t)=>{try{if(!this.db){s("\u8BF7\u5F00\u542F\u6570\u636E\u5E93");return}this.db.close(),this.db=null,V._instance&&delete V._instance[this.dbName],s(!0)}catch(e){t(e)}})}delete_db(s){return new Promise((t,e)=>{const r=indexedDB.deleteDatabase(s);r.onerror=i=>{e(i)},r.onsuccess=i=>{t(i)}})}delete_table(s){return this.commitDb(s,t=>t.clear(),"readwrite",(t,e)=>{e()})}create_table(s,{tableName:t,option:e,indexs:r=[]}){if(!s.objectStoreNames.contains(t)){const i=s.createObjectStore(t,e);for(const{key:a,option:n}of r)i.createIndex(a,a,n)}}commitDb(s,t,e="readwrite",r){return new Promise((i,a)=>{const n=()=>{try{if(this.db){const l=this.db.transaction(s,e).objectStore(s);if(!t){r(null,i,l);return}const c=t(l);c.onsuccess=g=>{r?r(g,i,l):i(g)},c.onerror=g=>{a(g)}}else a(new Error("\u8BF7\u5F00\u542F\u6570\u636E\u5E93"))}catch(l){a(l)}};this.db?n():this.queue.push(n)})}cursor_success(s,{condition:t,handler:e,success:r}){const i=s.target.result;if(i){const a=i.value;t(a)&&e({cursor:i,currentValue:a}),i.continue()}else r()}};let W=V;L(W,"_instance",null);const xe=({dbName:o,version:s=1,tables:t=[]})=>W.getInstance({dbName:o,version:s,tables:t}).open_db(),ke=o=>W.getInstance({dbName:o,version:1,tables:[]});class Ie{constructor(){L(this,"dbName");L(this,"tableName");L(this,"isInitDb");this.dbName="vjmapCache",this.tableName="cache",this.isInitDb=!1}async init(){this.isInitDb||(await xe({dbName:this.dbName,version:1,tables:[{tableName:this.tableName,option:{keyPath:"id",autoIncrement:!0},indexs:[{key:"id",option:{unique:!0}},{key:"key"},{key:"value"}]}]}),this.isInitDb=!0)}getInst(){return ke(this.dbName)}async getAll(){return await this.init(),await this.getInst().queryAll({tableName:this.tableName})}async getRecordByKey(s){return await this.init(),await this.getInst().query({tableName:this.tableName,condition:t=>t.key===s})}async getValueByKey(s,t){const e=await this.getRecordByKey(s);if(e.length!=0)return t===!0?JSON.parse(e[0].value):e[0].value}async setValueByKey(s,t,e){return await this.upsert({key:s,value:e===!0?JSON.stringify(t,null,0):t})}async upsert(s){return await this.init(),(await this.getRecordByKey(s.key)).length==0?await this.getInst().insert({tableName:this.tableName,data:s}):await this.getInst().update({tableName:this.tableName,condition:e=>e.key===s.key,handle:e=>(e.value=s.value,e)})}async deleteRecord(s){return await this.init(),await this.getInst().delete({tableName:this.tableName,condition:t=>t.key===s})}async deleteTable(){return await this.init(),await this.getInst().delete_table(this.tableName)}async deleteDb(){return await this.init(),await this.getInst().delete_db(this.dbName)}toStringKey(s,t){return t=t!=null?t:"",t+JSON.stringify(s,null,0)}}const Q=new Ie;async function $(o,s,t){var h,f,d,m;let e=o.getService();const r={mapId:(h=e.currentMapParam())==null?void 0:h.mapid,version:(f=e.currentMapParam())==null?void 0:f.version,workspace:e.getCurWorkspaceName(),layername:(d=e.currentMapParam())==null?void 0:d.layer,...s,...t};if(s.disableCacheData===!0){let y=await Q.getValueByKey(Q.toStringKey(r,"query_"),!0);if(y)return y}let i;const a=[];let n=0;const l=5e4;let c;for(s.bounds&&(c=u.default.GeoBounds.fromString(s.bounds).toArray());;){const y=await e.conditionQueryFeature({condition:(m=s.condition)!=null?m:"",bounds:c,fields:"",includegeom:s.coordType==1,realgeom:s.coordType==1,isContains:s.isContains,beginpos:n,limit:l,...s});if(!y.result||(n+=l,a.push(...y.result||[]),a.length>=y.recordCount))break}i={result:a,recordCount:a.length};let g=ce(o,i,s.coordType==1);return s.disableCacheData===!0&&await Q.setValueByKey(Q.toStringKey(r,"query_"),g,!0),g}const G=o=>{const s=new Set(["id","isEnvelop","envelop","geojson","geom","isPoint","isline","points"]),t={};for(const e in o)s.has(e)||(t[e]=o[e]);return t};function ce(o,s,t){const e={features:[],type:"FeatureCollection"};if(s&&s.result&&s.result.length>0)for(const i of s.result)if(t){if(i.geom&&i.geom.geometries){let a={id:i.id,type:"Feature",properties:G(i)};i.geom.geometries.length==1?a={...a,geometry:i.geom.geometries[0]}:a={...a,geometry:{geometries:i.geom.geometries,type:"GeometryCollection"}},e.features.push(a)}}else{const a=i.points||i.positon||i.location||i.origin||i.center;if(a){const n=a.split(";"),l=[];for(let c of n)c.indexOf(",")>0&&l.push(o.toLngLat(u.default.GeoPoint.fromString(c)));if(l.length==1){const c={type:"Feature",id:i.id,properties:G(i),geometry:{type:"Point",coordinates:l[0]}};e.features.push(c)}else if(l.length>1){const c={type:"Feature",id:i.id,properties:G(i),geometry:{type:"LineString",coordinates:l}};e.features.push(c)}}}return o.fromLngLat(e)}async function U(o,s,t){let e;if(s.reqType=="SOURCE")s.fromSourceId&&(e=await t.getSourceData(s.fromSourceId));else{s.data&&typeof s.data=="string"&&(s.data=JSON.parse(s.data)),s.header&&typeof s.header=="string"&&(s.header=JSON.parse(s.header));let r={headers:{Accept:"application/json","Content-Type":"application/json",...s.header}};s.url&&(s.reqType=="POST"?e=await u.default.httpHelper.post(s.url,s.data,r):e=await u.default.httpHelper.get(s.url,s.data,r))}return s.processJS&&(e=await Te(e,s.processJS,o,t)),e}const de=o=>{let s={type:"FeatureCollection",features:[]};for(let t=0;t<o.length;t++){let e=o[t];Array.isArray(e)&&e.length==2&&typeof e[0]=="number"?s.features.push({type:"Feature",id:t+1,properties:{index:t+1},geometry:{type:"Point",coordinates:e}}):Array.isArray(e)&&Array.isArray(e[0])&&typeof e[0][0]=="number"?s.features.push({type:"Feature",id:t+1,properties:{index:t+1},geometry:{type:"LineString",coordinates:o[t]}}):Array.isArray(e)&&Array.isArray(e[0])&&Array.isArray(e[0][0])&&typeof e[0][0][0]=="number"&&s.features.push({type:"Feature",id:t+1,properties:{index:t+1},geometry:{type:"Polygon",coordinates:o[t]}})}return s};async function Te(o,s,t,e){Array.isArray(o)&&(o=de(o));const r=Object.getPrototypeOf(async function(){}).constructor,i=new r("data","vjmap","map","mapApp","utils",s),a={ProcessDataToFeatureCollection:ce,convertArrayToGeoJson:de};return await i(o,u.default,t,e,a)}const st={scatterDot:(o,s={})=>{var r;const t=(r=s.size)!=null?r:100;return{width:t,height:t,data:new Uint8Array(t*t*4),onAdd:function(){let i=document.createElement("canvas");i.width=this.width,i.height=this.height,this.context=i.getContext("2d")},render:function(){var h,f;const i=(h=s.duration)!=null?h:1500,a=(f=s.rgb)!=null?f:[0,150,0];let n=performance.now()%i/i,l=t/2*.3,c=t/2*.7*n+l,g=this.context;return g.clearRect(0,0,this.width,this.height),g.beginPath(),g.arc(this.width/2,this.height/2,c,0,Math.PI*2),g.fillStyle="rgba("+a[0]+","+a[1]+","+a[2]+","+(1-n)+" )",g.fill(),g.beginPath(),g.arc(this.width/2,this.height/2,l,0,Math.PI*2),this.data=g.getImageData(0,0,this.width,this.height).data,o.triggerRepaint(),!0}}},pulsingDot:(o,s={})=>{var r;const t=(r=s.size)!=null?r:100;return{width:t,height:t,data:new Uint8Array(t*t*4),onAdd:function(){const i=document.createElement("canvas");i.width=this.width,i.height=this.height,this.context=i.getContext("2d")},render:function(){var f,d,m,y,b,A,v;const i=(f=s.duration)!=null?f:1e3,a=performance.now()%i/i,n=(d=s.outFillRgb)!=null?d:[255,200,200],l=(m=s.innerFillRgb)!=null?m:[255,100,100],c=t/2*((y=s.innerRadiusRatio)!=null?y:.3),g=t/2*((b=s.outerRadiusRatio)!=null?b:.7)*a+c,h=this.context;return h.clearRect(0,0,this.width,this.height),h.beginPath(),h.arc(this.width/2,this.height/2,g,0,Math.PI*2),h.fillStyle="rgba("+n[0]+","+n[1]+","+n[2]+","+(1-a)+" )",h.fill(),h.beginPath(),h.arc(this.width/2,this.height/2,c,0,Math.PI*2),h.fillStyle="rgba("+l[0]+","+l[1]+","+l[2]+",1)",h.strokeStyle=(A=s.innerStrokeStyle)!=null?A:"white",h.lineWidth=2+((v=s.innerLineWidth)!=null?v:4)*(1-a),h.fill(),h.stroke(),this.data=h.getImageData(0,0,this.width,this.height).data,o.triggerRepaint(),!0}}}},it=()=>["https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"],Fe=o=>{const s=["85c9d12d5d691d168ba5cb6ecaa749eb","583e63953a6ed6bf304e68120db4c512","93d1fdef41f93d2211deed6d22780c48","7e2ced6843b376a14f69a9f5885d3d2d","44964a97c8c44e4d04efdf3cba594467","57f1b8146ef867f14189f3f4bb1adc1c"],t=s[u.default.randInt(0,s.length-1)];return[o?"https://t{0-7}.tianditu.gov.cn/DataServer?T=img_w&X={x}&Y={y}&L={z}&tk="+t:"https://t{0-7}.tianditu.gov.cn/DataServer?T=vec_w&X={x}&Y={y}&L={z}&tk="+t,"https://t{0-7}.tianditu.gov.cn/DataServer?T=cva_w&X={x}&Y={y}&L={z}&tk="+t]},Ee=o=>o?["https://webst0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}","https://webst0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"]:["https://webrd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"],Pe=(o,s)=>{let t=s.webMapTiles;if(t||(s.baseMapType=="WGS84"?t=Fe():s.baseMapType=="GCJ02"&&(t=Ee())),!!t)for(let e=0;e<t.length;e++){const r=`${s.baseMapType}_base_webmap_source_${e}`;o.addRasterSource(r,{type:"raster",tiles:le(t[e],o)});const i=`${s.baseMapType}_base_webmap_layer_${e}`;o.addRasterLayer(i,r,{})}},xr={"FullscreenControl.Enter":"\u8FDB\u5165\u5168\u5C4F","FullscreenControl.Exit":"\u9000\u51FA\u5168\u5C4F","NavigationControl.ZoomIn":"\u653E\u5927","NavigationControl.ZoomOut":"\u7F29\u5C0F","NavigationControl.ResetBearing":"\u65B9\u4F4D\u89D2\u590D\u4F4D","ScaleControl.Meters":"","ScaleControl.Kilometers":"K"};var Me=(o=>(o.None="none",o.Direct="direct",o.Auto="auto",o.Param="param",o))(Me||{});const ee=async(o,s,t,e)=>{if(Array.isArray(t)){for await(let r of t)if(!r.layer&&(r.style||(r.style={backcolor:e!=null?e:0}),r.mapid)){let i=await o.createStyle(r.style,r.mapid,r.version);r.layer=i.stylename}}else{if(!t.mapid)return;if(!t.layer){t.style||(t.style={backcolor:e!=null?e:0});let r=await o.createStyle(t.style,t.mapid,t.version);t.layer=r.stylename}}return t},Be=async(o,s,t,e)=>{let r;const i=async a=>{var c,g,h,f,d;if(!a.mapid)return;let n=await o.metadata(a.mapid,a.version),l=u.default.GeoBounds.fromString(n.bounds);if(s=="auto")if(j(t)){let m=a.fourParameterX!==void 0?[(c=a.fourParameterX)!=null?c:0,(g=a.fourParameterY)!=null?g:0,(h=a.fourParameterScale)!=null?h:1,(f=a.fourParameterRotate)!=null?f:0].join(","):void 0,y=l.toPointArray(),b=new u.default.GeoBounds;for await(let A of y){let v=await Ge(o,u.default.geoPoint(A),(d=a.crs)!=null?d:"",m,t=="WGS84");b.update([u.default.geoPoint(v)])}return b}else return;else if(s=="param"){if(j(a.baseMapType))return;let m=l.toPointArray(),y;for(let b of m)if(a.coordinates){let A=ze(u.default.geoPoint(b),a.coordinates,a.isSetRotateZero,j(t));y||(y=new u.default.GeoBounds),y.update([u.default.geoPoint(A)])}return y}return l};if(Array.isArray(e))for await(let a of e){let n=await i(a);if(!n)return;r||(r=new u.default.GeoBounds),r.updateByBounds(n)}else{let a=await i(e);if(!a)return;r||(r=new u.default.GeoBounds),r.updateByBounds(a)}return r},Oe=(o,s,t)=>{const e=r=>{var i,a,n,l,c,g;if(o=="param"){if(!r.coordinates||r.coordinates.length<=1)return;if(j(s.baseMapType)){let h=r.coordinates.map(m=>u.default.geoPoint(u.default.Projection.lngLat2Mercator([m.x1,m.y1]))),f=r.coordinates.map(m=>u.default.geoPoint([m.x2,m.y2])),d=u.default.coordTransfromGetFourParamter(h,f,(i=r.isSetRotateZero)!=null?i:!1,!0);return[d.dx,d.dy,d.scale,d.rotate]}else{let h=r.coordinates.map(m=>u.default.geoPoint([m.x1,m.y1])),f=r.coordinates.map(m=>u.default.geoPoint([m.x2,m.y2])),d=u.default.coordTransfromGetFourParamter(h,f,(a=r.isSetRotateZero)!=null?a:!1,!0);return[d.dx,d.dy,d.scale,d.rotate]}}else return r.fourParameterX!==void 0?[(n=r.fourParameterX)!=null?n:0,(l=r.fourParameterY)!=null?l:0,(c=r.fourParameterScale)!=null?c:1,(g=r.fourParameterRotate)!=null?g:0]:void 0};if(Array.isArray(t)){if(t.length==1)return{mapid:t[0].mapid,version:t[0].version,layers:t[0].layer,crs:t[0].crs,fourParameter:e(t[0])};{let r=[],i=[],a=[],n=[],l=[];for(let c=0;c<t.length;c++)r.push(t[c].mapid),i.push(t[c].version),a.push(t[c].layer),n.push(t[c].crs),l.push(e(t[c]));return{mapid:r,version:i,layers:a,crs:n,fourParameter:l}}}else return{mapid:t.mapid,version:t.version,layers:t.layer,crs:t.crs,fourParameter:e(t)}},Re=async(o,s,t,e,r)=>(await ee(o,s,e),o.wmsTileUrl({...Oe(s,t,e),mapbounds:t.mapbounds,...r})),Ve=async(o,s,t,e,r)=>{await ee(o,s,e);const i=u.default.cloneDeep(Oe(s,t,e));if(i.fourParameter)if(Array.isArray(i.mapid))for(let a=0;a<i.fourParameter.length;a++)typeof i.fourParameter[a][0]=="number"&&(i.fourParameter[a][0]=-i.fourParameter[a][0]),typeof i.fourParameter[a][1]=="number"&&(i.fourParameter[a][1]=-i.fourParameter[a][1]),i.fourParameter[a][0]=i.fourParameter[a][0]||0,i.fourParameter[a][1]=i.fourParameter[a][1]||0,i.fourParameter[a][2]=i.fourParameter[a][2]||1,i.fourParameter[a][3]=i.fourParameter[a][3]||0;else typeof i.fourParameter[0]=="number"&&(i.fourParameter[0]=-i.fourParameter[0]),typeof i.fourParameter[1]=="number"&&(i.fourParameter[1]=-i.fourParameter[1]),i.fourParameter[0]=i.fourParameter[0]||0,i.fourParameter[1]=i.fourParameter[1]||0,i.fourParameter[2]=i.fourParameter[2]||1,i.fourParameter[3]=i.fourParameter[3]||0;return o.wmsTileUrl({...i,srs:"EPSG:3857",webMapType:t.baseMapType,...r})},je=async(o,s,t,e)=>{var a,n,l,c,g,h;let r;if(Array.isArray(t)?r=t.find(f=>j(f.baseMapType)):r=t,!r)return;const i=((a=r.webMapTiles)==null?void 0:a.map(f=>De(f)))||[];return o.webMapUrl({tileCrs:r.baseMapType=="GCJ02"?"gcj02":"wgs84",tileUrl:(n=i==null?void 0:i.map(f=>f.tileUrl))!=null?n:"",tileSize:256,tileRetina:1,tileMaxZoom:18,tileShards:i.length>=0?i[0].tileShards:"",tileToken:"",tileFlipY:!1,mapbounds:s.mapbounds,srs:r.crs,fourParameterBefore:r.fourParameterX!==void 0?[(l=r.fourParameterX)!=null?l:0,(c=r.fourParameterY)!=null?c:0,(g=r.fourParameterScale)!=null?g:1,(h=r.fourParameterRotate)!=null?h:0].join(","):void 0})},Ne=async(o,s,t,e,r)=>{await ee(o,s,e);let i;return j(t.baseMapType)||(i=t.mapbounds,i&&(i=i.replace("[",""),i=i.replace("]",""))),o.wmsTileUrl({...Oe(s,t,e),mapbounds:i,...r})},He=async(o,s,t,e)=>{let r;if(t=="direct"?r=await Re(o,t,s,e.maps,e.layerProps):t=="auto"?j(s.baseMapType)?r=await Ve(o,t,s,e.maps,e.layerProps):r=await je(o,s,e.maps,e.layerProps):t=="param"&&(r=await Ne(o,t,s,e.maps,e.layerProps)),!!r)return[r]},Ge=async(o,s,t,e,r)=>{if(e){let n=e.split(",");s=u.default.coordTransfromByFourParamter(s,{dx:+n[0],dy:+n[1],scale:+n[2],rotate:+n[3]})}let a=(await o.cmdTransform(t,"EPSG:4326",s))[0];return r===!1&&(a=u.default.transform.convert(a,u.default.transform.CRSTypes.EPSG4326,u.default.transform.CRSTypes.AMap)),a},ot=async(o,s,t,e,r)=>{r===!1&&(s=u.default.transform.convert(s,u.default.transform.CRSTypes.AMap,u.default.transform.CRSTypes.EPSG4326));let a=(await o.cmdTransform("EPSG:4326",t,u.default.geoPoint(s)))[0];if(e){let n=e.split(",");a=u.default.coordTransfromByFourParamter(u.default.geoPoint(a),{dx:+n[0],dy:+n[1],scale:+n[2],rotate:+n[3]})}return u.default.geoPoint(a).toArray()},ze=(o,s,t,e)=>{let r;e?r=s.map(l=>u.default.geoPoint(u.default.Projection.lngLat2Mercator([l.x1,l.y1]))):r=s.map(l=>u.default.geoPoint([l.x1,l.y1]));let i=s.map(l=>u.default.geoPoint([l.x2,l.y2]));if(r.length==0||i.length==0)return u.default.geoPoint(o);let a=u.default.coordTransfromGetFourParamter(i,r,t!=null?t:!1,!0),n=u.default.coordTransfromByFourParamter(o,a);return e&&(n=u.default.geoPoint(u.default.Projection.mercator2LngLat(n))),n},at=(o,s,t,e)=>{let r;e?r=s.map(n=>u.default.geoPoint(u.default.Projection.lngLat2Mercator([n.x1,n.y1]))):r=s.map(n=>u.default.geoPoint([n.x1,n.y1]));let i=s.map(n=>u.default.geoPoint([n.x2,n.y2]));if(r.length==0||i.length==0)return u.default.geoPoint(o);let a=u.default.coordTransfromGetFourParamter(r,i,t!=null?t:!1,!0);return e&&(o=u.default.geoPoint(u.default.Projection.lngLat2Mercator(o))),u.default.coordTransfromByFourParamter(o,a)},nt=o=>{let s=[],t=0,e=0;o=="BEIJING54_3"?(t=2401,e=2442):o=="BEIJING54_6"?(t=21413,e=21483):o=="XIAN80_3"?(t=2327,e=2348):o=="XIAN80_6"?(t=2349,e=2390):o=="CGCS2000_3"?(t=4513,e=4554):o=="CGCS2000_6"&&(t=4491,e=4512);for(let r=t;r<=e;r++)s.push(`EPSG:${r}`);return s},fe=()=>{let o;const s=l=>{o=l};document.addEventListener("keydown",s);const t=l=>{o=void 0};return document.addEventListener("keyup",t),{removeEventListener:()=>{document.removeEventListener("keydown",s),document.removeEventListener("keyup",t)},isAltKey:()=>o==null?void 0:o.altKey,isCtrlKey:()=>o==null?void 0:o.ctrlKey,isShiftKey:()=>o==null?void 0:o.shiftKey,curKey:()=>o}};class lt{constructor(s){L(this,"config");L(this,"svc");L(this,"map");L(this,"sources");L(this,"layers");L(this,"controls");L(this,"layersInst");L(this,"projectKey");L(this,"containerId");L(this,"timeMgr");L(this,"isEditorMode");L(this,"isDisableRunProgram");L(this,"context");L(this,"programCleaner");L(this,"oldCacheImages");L(this,"keyEvent");this.config=s||{},this.sources=[],this.layers=[],this.layersInst={},this.timeMgr={},this.config.mapSources=[],this.config.mapLayers=[]}mount(s,t){var a,n,l,c,g,h,f;if(this.svc)return;if(this.keyEvent||(this.keyEvent=fe()),this.containerId=s,(a=this.config)!=null&&a.backgroundColor){const d=document.getElementById(s);d&&(d.style.backgroundColor=(n=this.config)==null?void 0:n.backgroundColor)}this.svc=new u.default.Service((c=(l=this.config.serviceUrl)!=null?l:t==null?void 0:t.serviceUrl)!=null?c:"",(h=(g=this.config.serviceToken)!=null?g:t==null?void 0:t.serviceToken)!=null?h:""),this.config.workspace&&this.svc.switchWorkspace(this.config.workspace),this.config.accessKey&&this.config.accessKey.split(";").map(d=>this.svc.addAccessKey(d));const e=(f=this.config.mapInitBounds)!=null?f:"[-10000,-10000,10000,10000]",r=u.default.GeoBounds.fromString(e),i=new u.default.GeoProjection(r);this.map=new u.default.Map({container:s,style:{version:this.svc.styleVersion(),glyphs:this.svc.glyphsUrl(),sources:{},layers:[]},center:i.toLngLat(r.center()),zoom:2,renderWorldCopies:!1,preserveDrawingBuffer:this.isEditorMode?!0:void 0,doubleClickZoom:!1,locale:xr,...this.config.mapOptions}),this.map.attach(this.svc,i)}attachMap(s){this.map=s,this.svc=this.map.getService(),this.keyEvent||(this.keyEvent=fe())}isWebBaseMap(s){var e;let t=(e=s!=null?s:this.config)!=null?e:{};return!(t.baseMapType==""||t.baseMapType=="CAD"||t.baseMapType===void 0)}async setConfig(s,t){var n,l,c,g,h,f,d,m,y,b,A,v,S,D;if(s||(s=u.default.cloneDeep(this.config)),!this.map)return;if(await this.map.onLoad(),this.clearData(),s&&(this.config=s),(n=this.config)!=null&&n.backgroundColor){const w=this.map.getContainer();w&&(w.style.backgroundColor=(l=this.config)==null?void 0:l.backgroundColor)}const e=[...(c=s==null?void 0:s.mapSources)!=null?c:[]],r=[...(g=s==null?void 0:s.mapLayers)!=null?g:[]];if(this.svc=new u.default.Service((d=(f=this.config.serviceUrl)!=null?f:(h=this.svc)==null?void 0:h.serverUrl)!=null?d:"",(b=(y=this.config.serviceToken)!=null?y:(m=this.svc)==null?void 0:m.accessToken)!=null?b:""),this.isWebBaseMap()){let w=new u.default.LnglatProjection;this.map.attach(this.svc,w),Pe(this.map,this.config)}else{if(!((A=this.config.mapOpenOptions)!=null&&A.mapid)&&this.config.mapInitBounds){const w=this.config.mapInitBounds,C=u.default.GeoBounds.fromString(w),x=new u.default.GeoProjection(C);this.map.setMapProjection(x)}this.map.attach(this.svc,this.map.getMapProjection())}if(this.config.workspace&&this.svc.switchWorkspace(this.config.workspace),this.config.accessKey&&this.config.accessKey.split(";").map(w=>this.svc.addAccessKey(w)),!this.isWebBaseMap()&&(this.config.mapOpenOptions=this.config.mapOpenOptions||{},(v=this.config.mapOpenOptions)!=null&&v.style||(this.config.mapOpenOptions.style=u.default.openMapDarkStyle()),(S=this.config.mapOpenOptions)!=null&&S.mapid)){const w=await this.switchMap(this.config.mapOpenOptions);if(w!=null&&w.error)return{error:w.error}}t||this.setMapOptions((D=this.config.mapOptions)!=null?D:{}),await this.map.onLoad(!0),await this.addMapImages();let i=[],a=[];e.filter(w=>!(w.tag=="change"&&w.change&&w.change.reqType=="SOURCE")).forEach(w=>i.push(this.addSource(w,!0))),await Promise.all(i),e.filter(w=>w.tag=="change"&&w.change&&w.change.reqType=="SOURCE").forEach(w=>a.push(this.addSource(w,!0))),await Promise.all(a);for(let w of r)await this.addLayer(w,!0);this.addControls(),await this.execProgram()}async setMapOpenOptions(s){this.config.mapOpenOptions={...this.config.mapOpenOptions,...s},await this.setConfig()}setMapOptions(s){this.config.mapOptions={...this.config.mapOptions,...s},this.map&&(s.center?this.map.setCenter(s.center):this.isWebBaseMap()&&this.map.setCenter([116.3912,39.9073]),s.zoom!==void 0?this.map.setZoom(s.zoom):this.isWebBaseMap()&&this.map.setZoom(8),s.bearing!==void 0&&this.map.setBearing(s.bearing),s.pitch!==void 0&&this.map.setPitch(s.pitch),s.dragRotate===!1&&this.map.dragRotate.isEnabled()?(this.map.dragRotate.disable(),this.map.touchZoomRotate.disableRotation(),this.map.getCanvasContainer().oncontextmenu=t=>{t.preventDefault()}):s.dragRotate&&!this.map.dragRotate.isEnabled()&&(this.map.dragRotate.enable(),this.map.touchZoomRotate.enableRotation(),this.map.getCanvasContainer().oncontextmenu=()=>{}),s.pitchWithRotate===!1?this.map.setMaxPitch(0):this.map.setMaxPitch(85))}async addMapImages(){try{if(!this.config.mapImages)return;this.oldCacheImages=this.oldCacheImages||{};let s=[...this.config.mapImages];s=s.filter(e=>e.key&&e.value),s=s.filter(e=>{const r=e.value+"_"+e.options;return this.oldCacheImages[e.key]!=r});for(let e of s)this.map.hasImage(e.key)&&this.map.removeImage(e.key);let t=[];for(let e of s){let r;if(this.oldCacheImages[e.key]=e.value+"_"+e.options,typeof e.options=="string")try{r=JSON.parse(e.options)}catch(a){console.error(a)}let i=st[e.value];i?t.push(this.map.addImage(e.key,i(this.map,r),r)):t.push(this.map.loadImageEx(e.key,e.value,r))}await Promise.all(t)}catch(s){console.error(s)}}async clearData(){if(!this.map)return;const{sources:s}=this.map.getStyle();this.removePrograms();for(const t in this.layersInst){const e=this.layersInst[t];e&&e.removeLayer(this.map,t)}for(const t in s)this.map.removeSourceEx(t);this.map.removeMarkers(),this.map.removePopups(),this.removeControls(),this.sources=[],this.layers=[],this.layersInst=[],this.config.mapSources=[],this.config.mapLayers=[],this.oldCacheImages={};for(let t in this.timeMgr)clearInterval(this.timeMgr[t]);this.timeMgr={}}removePrograms(){if(this.programCleaner){for(let s of this.programCleaner)s&&s();this.programCleaner=[]}}async execProgram(){if(!this.isDisableRunProgram&&(this.removePrograms(),this.config.program&&this.config.program.onMapLoaded)){let s=await ve(this.config.program.onMapLoaded,this.map,this,this.context);typeof s=="function"&&(this.programCleaner=this.programCleaner||[],this.programCleaner.push(s))}}async destory(){this.clearData(),this.map&&(this.map.remove(),this.map=null),this.keyEvent&&this.keyEvent.removeEventListener()}async switchMap(s){this.config.mapOpenOptions=s;const t=await this.map.switchMap(s,s.isKeepOldLayers,s.isVectorStyle,s.isSetCenter,s.isFitBounds);return t!=null&&t.error?{error:t.error}:t}async addSource(s,t){var i,a;const e=u.default.cloneDeep(s);if(this.sources.findIndex(n=>n.id===e.id)>=0)return!1;if(this.sources.push(u.default.cloneDeep(e)),t&&((i=this.config.mapSources)==null?void 0:i.findIndex(l=>l.id===e.id))==-1&&((a=this.config.mapSources)==null||a.push(u.default.cloneDeep(e))),e.tag==="query"){let n=await $(this.map,e.query);e.source.data=n}else if(e.tag==="change"){let n=await U(this.map,e.change,this);e.source.data=n,this.addTimer(e)}if(e.source.type==="geojson"){const n=u.default.cloneDeep(e.source);n.data=this.map.toLngLat(n.data);for(let l in e.props)n[l]=e.props[l];this.map.addSourceEx(e.id,n)}else await this.updateSource(e);return!0}async getSourceData(s){const t=this.sources.findIndex(r=>r.id===s);if(t<0)return;const e=this.sources[t];if(e.tag==="query")return await $(this.map,e.query);if(e.tag==="change")return await U(this.map,e.change,this);if(e.source.type==="geojson")return u.default.cloneDeep(e.source).data}async setSourceData(s,t,e){var n,l;const r=this.sources.findIndex(c=>c.id===s);if(r<0)return;let i=-1;e&&(i=(l=(n=this.config.mapSources)==null?void 0:n.findIndex(c=>c.id===s))!=null?l:-1);let a=!0;if(this.sources[r].tag==="query")this.sources[r].query=t,i>=0&&this.config.mapSources&&(this.config.mapSources[i].query=u.default.cloneDeep(t)),t=await $(this.map,this.sources[r].query);else if(this.sources[r].tag==="change")this.sources[r].change=t,i>=0&&this.config.mapSources&&(this.config.mapSources[i].change=u.default.cloneDeep(t)),t=await U(this.map,this.sources[r].change,this),this.addTimer(this.sources[r]);else if(this.sources[r].source.type==="geojson")this.sources[r].source.data=t,i>=0&&this.config.mapSources&&(this.config.mapSources[i].source.data=u.default.cloneDeep(t));else{if(this.sources[r].tag==="wms"){const c=this.sources[r].source.type;this.sources[r].wms=t.wms,this.sources[r].source={...t.source},c&&(this.sources[r].source.type=c),i>=0&&this.config.mapSources&&(this.config.mapSources[i].wms=u.default.cloneDeep(t.wms),this.config.mapSources[i].source={type:this.sources[i].source.type,...t.source},c&&(this.config.mapSources[i].source.type=c))}else{const c=this.sources[r].source.type;this.sources[r].source=u.default.cloneDeep(t),c&&(this.sources[r].source.type=c),i>=0&&this.config.mapSources&&(this.config.mapSources[i].source=u.default.cloneDeep(t),c&&(this.config.mapSources[i].source.type=c))}await this.updateSource(this.sources[r],!0),a=!1}a&&this.map.setData(s,this.map.toLngLat(t)),await this.notifySourceDataChange(s,!a)}async updateSource(s,t){var r,i,a,n,l,c,g,h;let e=u.default.cloneDeep(s);if(t&&this.map.removeSourceEx(e.id),e.source.type==="raster"||e.source.type==="vector"){if(e.source.bounds){const f=this.map.toLngLat([e.source.bounds[0],e.source.bounds[1]]),d=this.map.toLngLat([e.source.bounds[2],e.source.bounds[3]]);e.source.bounds=[f[0],f[1],d[0],d[1]]}if(e.tag=="wms"&&(e.source.tiles=await He(this.svc,{baseMapType:this.config.baseMapType,mapid:(r=this.config.mapOpenOptions)==null?void 0:r.mapid,version:(i=this.config.mapOpenOptions)==null?void 0:i.version,mapbounds:this.map.getGeoBounds(1).toString()},(a=e.wms)==null?void 0:a.overlayType,(n=e.wms)==null?void 0:n.param),!e.source.bounds)){let f=await Be(this.svc,(l=e.wms)==null?void 0:l.overlayType,(c=this.config.baseMapType)!=null?c:"",(h=(g=e.wms)==null?void 0:g.param)==null?void 0:h.maps);if(f){let d=this.map.toLngLat(f).toArray();e.source.bounds=[d[0][0],d[0][1],d[1][0],d[1][1]]}}e.source.tiles||(e.source.tiles=le(e.source.tiles,this.map)),e.source.type==="raster"?this.map.addRasterSource(e.id,e.source):this.map.addVectorSource(e.id,e.source,{})}else e.source.type==="image"||e.source.type==="video"?(e.source.coordinates&&(e.source.coordinates=this.map.toLngLat(e.source.coordinates)),e.source.type==="image"?this.map.addImageSource(e.id,e.source):this.map.addVideoSource(e.id,e.source)):this.map.addSourceEx(e.id,e.source)}removeSource(s,t){var r,i;for(let a=this.layers.length-1;a>=0;a--)this.layers[a].sourceId==s&&this.removeLayer(this.layers[a].layerId,!0);this.map.removeSourceEx(s);const e=this.sources.findIndex(a=>a.id===s);if(e>=0&&this.sources.splice(e,1),t){const a=(r=this.config.mapSources)==null?void 0:r.findIndex(n=>n.id===s);a!==void 0&&a>=0&&((i=this.config.mapSources)==null||i.splice(a,1))}this.clearTimer(s)}async addLayer(s,t){var n,l,c;const e=u.default.cloneDeep(s);if(this.layers.findIndex(g=>g.layerId===e.layerId)<0&&this.layers.push(u.default.cloneDeep(e)),t&&((n=this.config.mapLayers)==null?void 0:n.findIndex(h=>h.layerId===e.layerId))==-1&&((l=this.config.mapLayers)==null||l.push(u.default.cloneDeep(e))),e.visibleOff||this.layersInst[e.layerId])return;let i=Se[e.type];i||console.error(`\u56FE\u5C42\u7C7B\u578B ${e.type} \u672A\u6CE8\u518C`);let a=new i;if(await a.addLayer(this.map,e),this.layersInst[e.layerId]=a,s.isLowest&&a.getLayerId()){let g=this.map.getStyle().layers,h=(c=a.getLayerId())!=null?c:[];Array.isArray(h)||(h=[h]);for(let f=0;f<g.length-1;f++)g.findIndex(d=>d.id==h[f])>=0&&this.map.moveLayer(h[f],g[0].id)}}async setLayerStyle(s,t,e){var i;const r=this.layers.findIndex(a=>a.layerId===s);if(!(r<0)&&(this.layersInst[s]?(this.layersInst[s].setLayerStyle(this.map,s,t,this.layers[r]),this.layers[r]=P(this.layers[r],t)):(this.layers[r]=P(this.layers[r],t),await this.addLayer(this.layers[r],e)),e)){const a=(i=this.config.mapLayers)==null?void 0:i.findIndex(n=>n.layerId===s);a!==void 0&&a>=0&&this.config.mapLayers&&(this.config.mapLayers[a]=u.default.cloneDeep(this.layers[r]))}}async setLayerVisible(s,t,e){var i;const r=this.layers.findIndex(a=>a.layerId===s);if(!(r<0)&&(this.layers[r].visibleOff=t,this.layersInst[s]||await this.addLayer(this.layers[r],e),this.layersInst[s].setVisible(this.map,s,t),e)){const a=(i=this.config.mapLayers)==null?void 0:i.findIndex(n=>n.layerId===s);a!==void 0&&a>=0&&this.config.mapLayers&&(this.config.mapLayers[a].visibleOff=t)}}async setSourceVisible(s,t,e){for(let r of this.layers)r.sourceId==s&&await this.setLayerVisible(r.layerId,t)}removeLayer(s,t){var r,i;if(!this.layersInst[s])return;this.layersInst[s].removeLayer(this.map,s),delete this.layersInst[s];const e=this.layers.findIndex(a=>a.layerId===s);if(e>=0&&this.layers.splice(e,1),t){const a=(r=this.config.mapLayers)==null?void 0:r.findIndex(n=>n.layerId===s);a!==void 0&&a>=0&&((i=this.config.mapLayers)==null||i.splice(a,1))}}addTimer(s){this.clearTimer(s.id),s.change.interval>0&&(this.timeMgr[s.id]=setInterval(async()=>{if(!this.map)return;let t=await U(this.map,s.change,this);this.map.getSource(s.id)!==void 0&&(this.map.setData(s.id,this.map.toLngLat(t)),await this.notifySourceDataChange(s.id,!1,!0))},s.change.interval*1e3))}clearTimer(s){this.timeMgr[s]&&(clearInterval(this.timeMgr[s]),delete this.timeMgr[s])}removeControls(){if(this.controls){for(let s of this.controls)s&&this.map.removeControl(s);this.controls=[]}}addControls(){if(this.removeControls(),!!this.config.controls){this.controls=this.controls||[];for(let s of this.config.controls){let t,e=s.name,r=s.options?JSON.parse(s.options):{};if(e=="DrawTool")t=new u.default.Draw.Tool(r);else{if(e=="Custom"){if(e=r.controlName,!e){console.warn("custom control options need include controlName field "),this.controls.push(null);continue}}else e=="MiniMapControl"&&(r.containerStyle||(r.containerStyle={background:this.config.backgroundColor,transform:"scale(0.6)",transformOrigin:`${s.position.indexOf("left")>=0?"0%":"100%"} ${s.position.indexOf("top")>=0?"0%":"100%"}`}));if(!e)continue;if(!u.default[e]){console.warn(`${e} is not vjmap class`),this.controls.push(null);continue}t=new u.default[e](r)}r!=null&&r.locale&&(this.map._locale={...this.map._locale,...r==null?void 0:r.locale}),this.map.addControl(t,s.position),this.controls.push(t)}}}getConfig(){return this.config}findDepsSourceId(s,t){var e;if(!!s){for(let r=0;r<this.sources.length;r++)if(this.sources[r].tag==="change"&&((e=this.sources[r].change)==null?void 0:e.fromSourceId)==s){let i=this.sources[r].id;i&&!t.has(i)&&(t.add(i),this.findDepsSourceId(i,t))}}}async notifySourceDataChange(s,t,e){var i,a;if(!s)return;let r=new Set;r.add(s),this.findDepsSourceId(s,r);for(let n of r){const l=this.sources.findIndex(c=>c.id===n);if(l>=0&&this.sources[l].tag==="change"&&((i=this.sources[l].change)==null?void 0:i.fromSourceId)){const c=await U(this.map,this.sources[l].change,this);this.map.setData(n,this.map.toLngLat(c))}}for(let n in this.layersInst)for(let l of r)(a=this.layersInst[n])==null||a.onSourceDataChange(this.map,l,t,e)}getSysImages(){return Object.keys(st)}static guid(s=8){return"x".repeat(s).replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}}const ge=(o,s,t,e,r)=>{var a;if(s.symbol&&s.text&&r)return kr(o,s,r);const i=new u.default.DbLine({color:s.color?parseInt(s.color.substring(1),16):0,start:o,end:o,alpha:((a=s.opacity)!=null?a:1)*255});return _(i),[i]},he=(o,s,t)=>{const e=[0,5,9,13,15,18,20,25,30,35,40,50,53,60,70,80,90,100,106,120,140,158,200,211];let r=s.line_width?s.line_width*10:void 0;if(r){for(let n=1;n<e.length;n++)if(r<e[n]){r=e[n-1];break}}let i=t?s.line_opacity:s.opacity;if(s.center&&s.pointInCircle)return Ir(o,s,r,i);const a=new u.default.Db2dPolyline({color:s.color?parseInt(s.color.substring(1),16):0,points:o,lineWidth:r,alpha:(i!=null?i:1)*255,elevation:s.elevation});return _(a),[a]},ye=(o,s,t)=>{var a,n;let e=[],r=t?s.fillColor:s.color,i=new u.default.DbHatch({color:r?parseInt(r.substring(1),16):0,points:o.length==1?o[0]:o,pattern:"SOLID",alpha:((a=s.opacity)!=null?a:1)*255});if(_(i),e.push(i),!t&&!s.noneOutline&&s.color!=s.outlineColor){let l=new u.default.Db2dPolyline({color:s.outlineColor?parseInt(s.outlineColor.substring(1),16):0,points:o,alpha:((n=s.opacity)!=null?n:1)*255});_(l),e.push(l)}return e},kr=(o,s,t)=>{const e=s.text_size_zoom1?t.pixelToGeoLength(s.text_size_zoom1,1):t.getGeoBounds().height()/80;o[1]-=e/2;const r=new u.default.DbMText({color:s.color?parseInt(s.color.substring(1),16):0,location:[o[0],o[1]],attachment:2,contents:s.text,rotation:u.default.degreesToRadians(-parseFloat(s.text_rotate)),textHeight:e});return _(r),[r]},We=o=>{let s,t;if(o.geometry.type=="Polygon")s=o.geometry.coordinates[0][0],t=o.geometry.coordinates[o.geometry.coordinates.length-1][1];else if(o.geometry.type=="MultiPolygon"){s=o.geometry.coordinates[0][0][0];let e=o.geometry.coordinates[o.geometry.coordinates.length-1];t=e[e.length-1][1]}else if(o.geometry.type=="MultiLineString")s=o.geometry.coordinates[0][0],t=o.geometry.coordinates[o.geometry.coordinates.length-1][1];else if(o.geometry.type=="GeometryCollection"){let e=o.geometry.geometries[0];e.type=="LineString"?s=e.coordinates[0]:e.type=="Polygon"&&(s=e.coordinates[0][0]);let r=o.geometry.geometries[o.geometry.geometries.length-1];r.type=="LineString"?t=r.coordinates[1]:r.type=="Polygon"&&(t=r.coordinates[r.coordinates.length-1][1])}return{refCo1:s,refCo2:t}},me=(o,s,t)=>{var d,m;let e=s.export||{};if(!e.refCo1||!e.refCo2||!e.height||!e.position)return;let r,i,a,{refCo1:n,refCo2:l}=We(o);if(!n||!l)return;let c=u.default.coordTransfromGetFourParamter([u.default.geoPoint(e.refCo1),u.default.geoPoint(e.refCo2)],[u.default.geoPoint(n),u.default.geoPoint(l)],!1,!0),g=u.default.coordTransfromByFourParamter(u.default.geoPoint(e.position),c);r=g.x,i=g.y,a=e.height*c.scale;let h,f={...e,rotation:((d=c.rotate)!=null?d:0)+((m=e.textRotate)!=null?m:0),color:s.color?parseInt(s.color.substring(1),16):0};return e.isMText?h=new u.default.DbMText({...f,location:[r,i],textHeight:a}):h=new u.default.DbText({...f,position:[r,i],height:a}),_(h),[h]},Ir=(o,s,t,e)=>{const r=o[0],i=o[o.length/2],a=new u.default.DbCircle({color:s.color?parseInt(s.color.substring(1),16):0,center:[(r[0]+i[0])/2,(r[1]+i[1])/2],radius:u.default.geoPoint(r).distanceTo(u.default.geoPoint(i))/2,lineWidth:t,alpha:(e!=null?e:1)*255});return _(a),[a]},_=o=>((o.color==0||o.color==16777215)&&(o.colorIndex=7,delete o.color),o),ut=async(o,s,t,e)=>{e=e||console.log,e("\u8BF7\u9009\u62E9\u8981\u9009\u62E9\u7684\u7ED8\u5236\u6587\u5B57\uFF0C\u6309\u53F3\u952E\u7ED3\u675F");let r=await u.default.Draw.actionSelect(o,s);if(r.features.length==0)return;if(!(r.features[0].properties.export&&r.features[0].properties.export.contents)){e("\u9009\u62E9\u7684\u4E0D\u662F\u7ED8\u5236\u7684\u6587\u672C\u7C7B\u578B");return}let i=r.features[0].properties.export,a;if(t?a=await t(i.contents):a=prompt("\u8BF7\u8F93\u5165\u8981\u4FEE\u6539\u7684\u6587\u5B57\u5185\u5BB9",i.contents),a==""||a==null||a==i.contents)return;let n=await Qe(o,s,{},{color:r.features[0].properties.color,text:a,height:5},void 0,!0),l=u.default.GeoBounds.fromDataExtent(o.fromLngLat(n));r.features[0];let c=u.default.GeoBounds.fromDataExtent(o.fromLngLat(r)),g=u.default.coordTransfromGetFourParamter([l.min,l.max],[c.min,c.max],!0,!0),h=n,f=Ce(o,u.default.cloneDeep(h),g);f.features[0].id=r.features[0].id,s.delete(r.features[0].id),s.add(f)},ct=async(o,s,t)=>{let e=s.getAll();e=o.fromLngLat(e);const i=o.getGeoBounds().width()/200;let a=[];for(let f=0;f<e.features.length;f++){let d=e.features[f];if(te(d)){const m=N(s,"deleteEntitys");m&&Array.from(new Set(m)).forEach(y=>{a.push({objectid:y,delete:!0})});continue}if(d.geometry.type=="Point")a.push(...ge(d.geometry.coordinates,d.properties,i,!1,o));else if(d.geometry.type=="LineString")a.push(...he(d.geometry.coordinates,d.properties));else if(d.geometry.type=="Polygon"){if(d.properties.export){const m=me(d,d.properties);if(m&&m.length>0){a.push(...m);continue}}a.push(...ye(d.geometry.coordinates,d.properties))}else if(d.geometry.type=="MultiPoint")for(let m of d.geometry.coordinates)a.push(...ge(m,d.properties,i,!1,o));else if(d.geometry.type=="MultiLineString"){if(d.properties.export){const m=me(d,d.properties);if(m&&m.length>0){a.push(...m);continue}}for(let m of d.geometry.coordinates)a.push(...he(m,d.properties))}else if(d.geometry.type=="MultiPolygon"){if(d.properties.export){const m=me(d,d.properties);if(m&&m.length>0){a.push(...m);continue}}for(let m of d.geometry.coordinates)a.push(...ye(m,d.properties))}else if(d.geometry.type=="GeometryCollection"){if(d.properties.export){const m=me(d,d.properties);if(m&&m.length>0){a.push(...m);continue}}for(let m=0;m<d.geometry.geometries.length;m++){let y=d.geometry.geometries[m];if(y.type=="Polygon")a.push(...ye(y.coordinates,d.properties,!0));else if(y.type=="MultiPolygon")for(let b of y.coordinates)a.push(...ye(b,d.properties,!0))}for(let m=0;m<d.geometry.geometries.length;m++){let y=d.geometry.geometries[m];if(y.type=="Point")a.push(...ge(y.coordinates,d.properties,i,!0,o));else if(y.type=="LineString")a.push(...he(y.coordinates,d.properties,!0));else if(y.type=="MultiPoint")for(let b of y.coordinates)a.push(...ge(b,d.properties,i,!0,o));else if(y.type=="MultiLineString")for(let b of y.coordinates)a.push(...he(b,d.properties,!0))}}else console.warn("unknow FeatureCollection type:"+d.geometry.type)}let n=new u.default.DbDocument,l=o.getService(),c=l.currentMapParam();return c!=null&&c.mapid&&(c.maptype||(n.from=`${c==null?void 0:c.mapid}/${c==null?void 0:c.version}`)),n.appendEntity(a),await l.clone().updateMap({mapid:t||u.default.getTempMapId(60,!0),filedoc:n.toDoc(),mapopenway:u.default.MapOpenWay.Memory,style:{backcolor:0}})},te=o=>o?o.id=="__data_track__":!1,Ue=(o,s)=>{let e=o.getAll().features.find(r=>te(r));if(!e)o.add({id:"__data_track__",type:"Feature",properties:{...s,radius_inactive:1,radius_static:1,opacity:0,_hover_opacity:0,isOff:!0,isLocked:!0},geometry:{coordinates:[0,0],type:"Point"}});else if(e!=null&&e.id)for(let r in s)o.setFeatureProperty(e==null?void 0:e.id,r,s[r])},N=(o,s)=>{let e=o.getAll().features.find(r=>te(r));if(e&&e.properties)return s?e.properties[s]:e.properties},re=(o,s)=>{let t={};if(s.features.length>0){let e=s.features[0];if(e.geometry.type=="Polygon"?t.refCo1=o.fromLngLat(e.geometry.coordinates[0][0]):e.geometry.type=="LineString"?t.refCo1=o.fromLngLat(e.geometry.coordinates[0]):e.geometry.type=="MultiPolygon"&&(t.refCo1=o.fromLngLat(e.geometry.coordinates[0][0][0])),e=s.features[s.features.length-1],e.geometry.type=="Polygon")t.refCo2=o.fromLngLat(e.geometry.coordinates[e.geometry.coordinates.length-1][1]);else if(e.geometry.type=="LineString")t.refCo2=o.fromLngLat(e.geometry.coordinates[1]);else if(e.geometry.type=="MultiPolygon"){let r=e.geometry.coordinates[e.geometry.coordinates.length-1];t.refCo2=o.fromLngLat(r[r.length-1][1])}}return t},_e=(o,s,t)=>{const e=s!=null?s:"myhighlight";t=t!=null?t:"#FF8957",o.addGeoJSONSource(`${e}-source`,{type:"FeatureCollection",features:[]}),o.addCircleLayer(`${e}-point-layer`,`${e}-source`,{circleColor:t,circleOpacity:.8,circleRadius:1,filter:["==",["geometry-type"],"Point"]}),o.addLineLayer(`${e}-line-layer`,`${e}-source`,{lineJoin:"round",lineCap:"round",lineColor:t,lineWidth:3,lineOpacity:.8,filter:["==",["geometry-type"],"LineString"]}),o.addFillLayer(`${e}-fill-layer`,`${e}-source`,{fillColor:t,fillOpacity:1,filter:["==",["geometry-type"],"Polygon"]})},se=(o,s)=>{const t=s!=null?s:"myhighlight";o.getSource(`${t}-source`)&&o.getSource(`${t}-source`).setData({type:"FeatureCollection",features:[]})},Tr=async(o,s,t,e)=>{const r=o.getService(),i=s&&u.default.geoPoint([s[0],s[1]]).equals(u.default.geoPoint([s[2],s[3]]));let a;if(i)a=await r.pointQueryFeature({zoom:o.getZoom(),x:s[0],y:s[1],limit:100,...t,fields:"objectid"});else{const h=[];let f=0;const d=5e4;for(;;){const m=await r.conditionQueryFeature({condition:"",bounds:s,fields:"objectid",includegeom:!0,realgeom:!0,isContains:s&&s[0]>s[2],beginpos:f,limit:d,...t});if(!m.result||(f+=d,h.push(...m.result||[]),h.length>=m.recordCount))break}a={result:h,recordCount:h.length}}let n=new Set,l=new Set;if(a.result){for(const h of a.result)if(h.objectid){if(e&&e.has(h.objectid)){l.add("1 != 1");continue}let f="",d=0;for(d=0;d<h.objectid.length&&ue(h.objectid[d]);d++)f+=h.objectid[d];if(f)if(f==h.objectid)n.add(f);else{const m=["_"];for(const y of m)l.add(`objectid like '${f}${y}%'`)}}}let c,g;return n.size>0&&(c=` objectid in (${Array.from(n).map(f=>`"${f}"`).join(",")}) `),l.size>0&&(g=Array.from(l).join(" or ")),c&&g?c+" or "+g:c||(g!=null?g:"")},Ze=async(o,s,t,e,r,i,a,n,l)=>{var b,A,v,S;const c=n!=null?n:"myhighlight",g=o.getService(),h=s&&u.default.geoPoint([s[0],s[1]]).equals(u.default.geoPoint([s[2],s[3]]));let f;r&&(f=await Tr(o,s,e,i));let d;if(h&&!f)d=await g.pointQueryFeature({zoom:o.getZoom(),x:s[0],y:s[1],limit:100,...e});else{let D=[],w=0;const C=5e4;for(;;){let x;if(f?x=await g.conditionQueryFeature({condition:f,fields:"",includegeom:t,realgeom:t,beginpos:w,limit:C,...e}):x=await g.conditionQueryFeature({condition:"",bounds:s,fields:"",includegeom:t,realgeom:t,isContains:s&&s[0]>s[2],beginpos:w,limit:C,...e}),!x.result||(w+=C,D.push(...x.result||[]),D.length>=x.recordCount))break}d={result:D,recordCount:D.length}}i&&d.result&&(d.result=d.result.filter(D=>!i.has(D.objectid)),d.recordCount=d.result.length);const m={features:[],type:"FeatureCollection"},y={features:[],type:"FeatureCollection"};if(d&&d.result&&d.result.length>0){o.getSource(`${c}-source`)||_e(o,n,l);for(const w of d.result){if(w.geom&&w.geom.geometries)for(const C in w.geom.geometries){const x={type:"Feature",id:w.id+"_"+C,properties:G(w),geometry:w.geom.geometries[C]};m.features.push(x)}if(!t){const C=w.points||w.positon||w.location||w.origin||w.center;if(C){const x=C.split(";"),k=[];for(let T of x)T.indexOf(",")>0&&k.push(o.toLngLat(u.default.GeoPoint.fromString(T)));if(k.length==1){const T={type:"Feature",id:w.id,properties:G(w),geometry:{type:"Point",coordinates:k[0]}};y.features.push(T)}else if(k.length>1){const T={type:"Feature",id:w.id,properties:G(w),geometry:{type:"LineString",coordinates:k}};y.features.push(T)}}}}const D=t?m:y;D.features.length>0?!a&&((A=(b=o.getSource(`${c}-source`))==null?void 0:b._data)==null?void 0:A.features)?o.getSource(`${c}-source`).setData({features:[...(S=(v=o.getSource(`${c}-source`))==null?void 0:v._data)==null?void 0:S.features,...D.features],type:"FeatureCollection"}):o.getSource(`${c}-source`).setData(D):a&&se(o,c)}else a&&se(o,c);return o.triggerRepaint(),t?m:y},pe=(o,s)=>{const t=s!=null?s:"myhighlight";se(o,t),o.triggerRepaint()},Ae={},be=async(o,s,t)=>{var l,c;if(t===0){s.features=[];return}const e=o.getService(),r=(l=e.currentMapParam())==null?void 0:l.mapid,i=(c=e.currentMapParam())==null?void 0:c.version;if(!r)return;const a=`${r}_${i}${e.getCurWorkspaceName()}`;if(a in Ae){s.features=[...Ae[a].features];return}else{const g=localStorage.getItem("snap_"+a);if(g)try{const h=JSON.parse(g);if(Array.isArray(h)){s.features=[...h],Ae[a]=s;return}}catch{}}let n=await e.conditionQueryFeature({fields:"s3",condition:"s3 != ''",limit:t!=null?t:1e5});if(!!n.result){n=n.result.map(g=>g.s3.split(";")),s.features=[];for(const g of n){const h=[];for(const f of g){const d=f.split(",");d.length>=2&&h.push(o.toLngLat([+d[0],+d[1]]))}h.length==1?s.features.push({type:"Feature",geometry:{type:"Point",coordinates:h[0]}}):h.length>1&&s.features.push({type:"Feature",geometry:{type:"LineString",coordinates:h}})}Ae[a]=s;try{localStorage.setItem("snap_"+a,JSON.stringify(s.features))}catch{}}},Ke=async(o,s,t,e,r,i)=>{var n;if(((n=o.getService().currentMapParam())==null?void 0:n.mapopenway)==u.default.MapOpenWay.Memory){console.error("\u5185\u5B58\u6253\u5F00\u6A21\u5F0F\u4E0D\u652F\u6301\u9009\u62E9\u5B9E\u4F53\uFF0C\u8BF7\u5207\u6362\u81F3\u51E0\u4F55\u6805\u683C\u6216\u51E0\u4F55\u77E2\u91CF\u65B9\u5F0F\u6253\u5F00\u56FE\u5F62");return}const a={};for(r||be(o,a),o._selectFeatures=[];;){let l;if(e!=null?e:o._isPointSel){const g=await u.default.Draw.actionDrawPoint(o,{api:{getSnapFeatures:a},contextMenu:h=>{o.fire("keyup",{keyCode:13})}});if(g.cancel)break;l=[g.features[0].geometry.coordinates,g.features[0].geometry.coordinates,g.features[0].geometry.coordinates,g.features[0].geometry.coordinates]}else{const g=await u.default.Draw.actionDrawRectangle(o,{api:{getSnapFeatures:a},contextMenu:h=>{o.fire("keyup",{keyCode:13})}});if(g.cancel)break;l=g.features[0].geometry.coordinates[0]}l=o.fromLngLat(l);const c=await Ze(o,[l[0].x,l[0].y,l[2].x,l[1].y],s,void 0,t!=null?t:o._includeWholeEntity,i);o._selectFeatures.push(...c.features)}return o._selectFeatures},ie=async(o,s,t,e,r,i,a,n)=>{const l=e=="delete"?"\u5220\u9664":e=="modify"?"\u4FEE\u6539":"\u590D\u5236";r&&r(`\u8BF7\u9009\u62E9\u8981 ${l} \u7684CAD\u5B9E\u4F53\u5BF9\u8C61\uFF0C\u6309\u53F3\u952E\u7ED3\u675F`),Je(o);const c=N(s,"hideEntityObjectIds"),g=await Ke(o,!0,!0,!a,!0,c?new Set(c):void 0);if(!g||g.length==0)return;const h=new Set,f=new Set,d=new Set;g.forEach(A=>{A.properties.objectid&&f.add(A.properties.objectid),A.id&&d.add(parseInt(A.id));const v=Y(A.properties.objectid);v&&h.add(v)});const m=async(A,v)=>{var S;if(e!="copy"){o.hasVectorLayer()?await t.addHideObjectIds(Array.from(d)):await t.addHideObjectIds(Array.from(f));const D=N(s,"deleteEntitys")||[];D.push(...Array.from(h));const w=N(s,"hideEntityObjectIds")||[];w.push(...Array.from(f));const C=N(s,"hideEntityIds")||[];C.push(...Array.from(d)),Ue(s,{deleteEntitys:Array.from(new Set(D)),hideEntityObjectIds:Array.from(new Set(w)),hideEntityIds:Array.from(new Set(C))})}if(e!="delete"){let D=o.getService().currentMapParam(),w={};v&&A&&(w=A[0]);const C=await z(o,Array.from(h).map(k=>({objectid:k,...w})),t==null?void 0:t.getClipBounds(),null,null,`${D.mapid}/${D.version}`);let x=s.getAll().features.length;if(H(C,s,!0),A){const k=s.getAll().features,T=new Set;for(let E=x;E<k.length;E++){const M=Y((S=k[E].properties)==null?void 0:S.objectid);T.has(M)||T.add(M);let X=T.size-1;if(!A[X])continue;const zt=k[E].id;s.setFeatureProperty(zt,"disableDirectEdit",!0),s.setFeatureProperty(zt,"export",{...A[X].export,...re(o,{features:C.features.filter(Ur=>{var Wt,Ut,_t;return((Wt=Ur.properties)==null?void 0:Wt.objectid)==((_t=(Ut=k[E])==null?void 0:Ut.properties)==null?void 0:_t.objectid)})})})}}if(e=="copy"){let k={type:"FeatureCollection",features:[]};const T=s.getAll().features;for(let M=x;M<T.length;M++)k.features.push(T[M]);s.delete(k.features.map(M=>M.id));let E=await q(k,o,{},r,{drawInitPixelLength:0});E&&s.add(E.feature)}}pe(o)},y=()=>{pe(o)},b=(A,v)=>{let S;const D=new Set;for(let w=0;w<A.length;w++){const C=A[w].properties,x=Y(C.objectid);if(D.has(x)||(D.add(x),!(C.name=="AcDbText"||C.name=="AcDbMText")))continue;const T=C.name=="AcDbText"?{text:v!=null?v:C.text,isText:!0}:{contents:v!=null?v:C.text,isMText:!0};T.export={position:u.default.GeoPoint.fromString(C.location||C.position),height:C.height||C.textHeight,contents:v,cloneObjectId:Y(C.objectid),textRotate:C.rotate||0},S=S!=null?S:{},S[D.size-1]=T}return S};if(e!="delete"&&h.size==1&&(g[0].properties.name=="AcDbText"||g[0].properties.name=="AcDbMText")){let A;if(n?A=await n(g[0].properties.text):A=prompt("\u8BF7\u8F93\u5165\u8981\u4FEE\u6539\u7684\u6587\u5B57\u5185\u5BB9",g[0].properties.text),A==""||A==null){y();return}else await m(b(g,A),!0)}else i?await i(`\u4F60\u786E\u5B9A\u8981${l} \u8FD9 ${h.size} \u4E2Acad\u5B9E\u4F53\u5BF9\u8C61 ?`)?await m(b(g)):y():await m()},dt=async(o,s,t,e,r,i,a)=>{try{await ie(o,s,t,"delete",e,r,i,a)}catch(n){e&&e(n)}},ft=async(o,s,t,e,r,i,a)=>{try{await ie(o,s,t,"modify",e,r,i,a)}catch(n){e&&e(n)}},gt=async(o,s,t,e,r,i,a)=>{try{await ie(o,s,t,"copy",e,r,i,a)}catch(n){e&&e(n)}},z=async(o,s=[],t=null,e=null,r=null,i=null,a)=>{let n,l;if(Array.isArray(s)){n=new u.default.DbDocument,e&&(n.environment=e),r&&(n.linetypes=r);let f=o.getService().currentMapParam();t?i&&(n.from=i,n.pickEntitys=s.map(d=>d.objectid)):(i?n.from=typeof i=="string"?i:`${i.mapid}/${i.version}`:f.mapid&&(n.from=`${f.mapid}/${f.version}`),n.pickEntitys=s.map(d=>d.objectid)),n.appendEntity(s),l=t||f.bounds.toArray(),!n.from&&!t&&(l=void 0)}else n=s,l=t;let g=await o.getService().cmdCreateEntitiesGeomData({filedoc:n.toDoc(),mapBounds:l});if(g.error)throw g.error;const h=[];if(g&&g.result&&g.result.length>0){for(let f of g.result)if(f.geom&&f.geom.geometries){let d=o.entColorToHtmlColor(f.color),m={};f.isPolygon?(m.color=d,m.noneOutline=!0):(m.color=d,m.line_width=f.lineWidth);for(let y=0;y<f.geom.geometries.length;y++)f.geom.geometries[y].type=="Point"&&(f.geom.geometries[y].type="LineString",f.geom.geometries[y].coordinates=[f.geom.geometries[y].coordinates,f.geom.geometries[y].coordinates]);if(a){let y={id:f.id,type:"Feature",properties:{objectid:f.objectid,opacity:f.alpha/255,...m}};f.geom.geometries.length==1?y={...y,geometry:f.geom.geometries[0]}:y={...y,geometry:{geometries:f.geom.geometries,type:"GeometryCollection"}},h.push(y)}else for(let y=0;y<f.geom.geometries.length;y++)h.push({id:u.default.RandomID(10),type:"Feature",properties:{objectid:f.objectid,opacity:f.alpha/255,...m},geometry:f.geom.geometries[y]})}}return{type:"FeatureCollection",features:h}},ht=async(o,s,t,e)=>{if(t=JSON.parse(t),s.set(o.toLngLat(t)),o.hasVectorLayer()){const r=N(s,"hideEntityIds")||[];r&&await e.addHideObjectIds(r)}else{const r=N(s,"hideEntityObjectIds")||[];r&&await e.addHideObjectIds(r)}},R=(o,s)=>{if(!!s)for(let t in s)o.properties[t]=s[t]},Je=o=>{o.fire("keyup",{keyCode:27})},yt=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawPoint(o,t);r.cancel||(R(r.features[0],e),s.add(r.features[0]))},mt=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawLineSting(o,t);r.cancel||(R(r.features[0],e),s.add(r.features[0]))},pt=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawPolygon(o,t);r.cancel||(R(r.features[0],e),s.add(r.features[0]))},At=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawPolygon(o,t);r.cancel||(R(r.features[0],e),s.add(r.features[0]))},oe=o=>{if(o.geometry.type=="Polygon")return o.geometry.type="LineString",o.geometry.coordinates=o.geometry.coordinates[0],o},bt=async(o,s,t,e,r)=>{let i=await u.default.Draw.actionDrawCircle(o,t);i.cancel||(R(i.features[0],e),r||(i.features[0]=oe(i.features[0]),R(i.features[0],{isCircle:void 0})),s.add(i.features[0]))},wt=async(o,s,t,e,r)=>{let i=await u.default.Draw.actionDrawRectangle(o,t);i.cancel||(R(i.features[0],e),r||(i.features[0]=oe(i.features[0])),s.add(i.features[0]))},Lt=async(o,s,t,e,r)=>{let i=await u.default.Draw.actionDrawSlantRectangle(o,t);i.cancel||(R(i.features[0],e),r||(i.features[0]=oe(i.features[0])),s.add(i.features[0]))},vt=async(o,s,t,e)=>{let r=await u.default.Draw.actionSelect(o,s);if(r.features.length==0)return;e&&e("\u8BF7\u6307\u5B9A\u7684\u65CB\u8F6C\u7684\u57FA\u70B9");let i=await u.default.Draw.actionDrawPoint(o,{});if(i.cancel)return;e&&e("\u8BF7\u6307\u5B9A\u8981\u65CB\u8F6C\u7684\u89D2\u5EA6");let a=i.features[0].geometry.coordinates,n=a,l=new u.default.Polyline({data:[a,n],lineColor:"yellow",lineWidth:1,lineDasharray:[2,2]});l.addTo(o);let c=u.default.cloneDeep(r.features),g=await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:h=>{if(!h.lnglat)return;n=h.lnglat,l.setData([a,n]);let f=o.fromLngLat(n).angleTo(o.fromLngLat(a)),d=u.default.cloneDeep(c);for(let m=0;m<d.length;m++){let y=u.default.transform.convert(d[m],b=>{let v=o.fromLngLat(b).roateAround(f,o.fromLngLat(a));return o.toLngLat(v)});s.setFeatureProperty(d[m].id,"coordinates",y)}s.forceRefresh()}});if(l.remove(),g.cancel){for(let h=0;h<c.length;h++)s.setFeatureProperty(c[h].id,"coordinates",c[h]);s.forceRefresh();return}},Dt=(o,s)=>{let t=s.getSelected().features.filter(i=>i.geometry.type=="LineString"||i.geometry.type=="Polygon");if(t.length==0)return;let e=u.default.cloneDeep(t);for(let i=0;i<t.length;i++){let a=t[i];if(a.geometry.type=="LineString"){const n=u.default.polylineToBezierCurve(o.fromLngLat(a.geometry.coordinates).map(c=>[c.x,c.y])),l=u.default.bezierCurveToPolyline(n,100);s.setFeatureProperty(a.id,"coordinates",o.toLngLat(l))}else{let n=[];for(let l=0;l<a.geometry.coordinates.length;l++){const c=u.default.polylineToBezierCurve(o.fromLngLat(a.geometry.coordinates[l]).map(h=>[h.x,h.y])),g=u.default.bezierCurveToPolyline(c,1e3);n.push(o.toLngLat(g))}s.setFeatureProperty(a.id,"coordinates",n)}}let r=s.getSelected().features.filter(i=>i.geometry.type=="LineString"||i.geometry.type=="Polygon");o.fire("draw.update",{action:"toBezierCurve",features:u.default.cloneDeep(r),prevFeatures:e,styleId:s.options.styleId}),s.changeMode("simple_select")},we=async(o,s,t,e,r,i,a)=>{var y,b,A,v,S;let n=await u.default.Draw.actionDrawPoint(o,{...t});if(n.cancel)return;let l=o.fromLngLat(n.features[0].geometry.coordinates),c;if(i?c=new u.default.EllipseFill({center:l,majorAxisRadius:0,minorAxisRadius:0,fillColor:(y=e==null?void 0:e.color)!=null?y:"green",fillOpacity:(b=e==null?void 0:e.opacity)!=null?b:.8,fillOutlineColor:(A=e==null?void 0:e.outlineColor)!=null?A:"#f00"}):c=new u.default.EllipseEdge({center:l,majorAxisRadius:0,minorAxisRadius:0,lineColor:(v=e==null?void 0:e.outlineColor)!=null?v:"red",lineWidth:(S=e==null?void 0:e.line_width)!=null?S:3}),c.addTo(o),(await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:D=>{if(!D.lnglat)return;const w=o.fromLngLat(D.lnglat);c.setMinorAxisRadius(l.distanceTo(w)),c.setMajorAxisRadius(l.distanceTo(w))}})).cancel){c.remove();return}if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:D=>{if(!D.lnglat)return;const w=o.fromLngLat(D.lnglat);c.setMinorAxisRadius(l.distanceTo(w))}})).cancel){c.remove();return}if(a){if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:C=>{if(!C.lnglat)return;const x=o.fromLngLat(C.lnglat);c.setStartAngle(u.default.radiansToDegrees(x.angleTo(l)))}})).cancel){c.remove();return}if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:C=>{if(!C.lnglat)return;const x=o.fromLngLat(C.lnglat);c.setEndAngle(u.default.radiansToDegrees(x.angleTo(l)))}})).cancel){c.remove();return}}let f=c.getData();if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:D=>{if(!D.lnglat)return;let C=o.fromLngLat(D.lnglat).angleTo(l),x=u.default.cloneDeep(f),k;i?k=x.features[0].geometry.coordinates[0]:k=x.features[0].geometry.coordinates;for(let T=0;T<k.length;T++){let E=o.fromLngLat(k[T]);E=E.roateAround(C,l),E=o.toLngLat(E),k[T]=E}c.setData(x)}})).cancel){c.remove();return}let m=c.getData().features[0];m.id=u.default.RandomID(10),m.properties={...e},s.add(m),c.remove()},Ct=(o,s,t,e,r)=>{we(o,s,t,e,r,!0)},St=(o,s,t,e,r)=>{we(o,s,t,e,r,!1)},xt=(o,s,t,e,r)=>{we(o,s,t,e,r,!0,!0)},kt=(o,s,t,e,r)=>{we(o,s,t,e,r,!1,!0)},Le=o=>{let s=[];u.default.transform.convert(o,e=>(s.push(u.default.geoPoint(e)),e));let t=new u.default.GeoBounds;return t.update(s),t},q=async(o,s,t,e,r)=>{var n,l,c,g,h;const i=s.createDrawLayer();r=r!=null?r:{};const a=()=>{i&&s.removeDrawLayer(i),s.setIsInteracting(!1)};try{let f=Le(o),d,m;if(r.keepGeoSize!==!0){let C=s.fromLngLat(s.getCenter()),x=s.pixelToGeoLength((n=r.drawInitPixelLength)!=null?n:100,s.getZoom()),k=s.fromLngLat(f),T=x/k.width(),E=x/k.height(),M=Math.min(T,E);u.default.isZero(M)&&(M=1);let X=f.center();r.baseAlign=="leftBottom"?X=f.min:r.baseAlign=="leftTop"&&(X=u.default.geoPoint([f.min.x,f.max.y])),m=O(s,u.default.cloneDeep(o),s.fromLngLat(X),C,M)}else m=o;d=s.fromLngLat(Le(m));let y=d.center();r.baseAlign=="leftBottom"?y=d.min:r.baseAlign=="leftTop"&&(y=u.default.geoPoint([d.min.x,d.max.y])),r.unCombineFeature?i.set(m):H(m,i);let b=u.default.cloneDeep(i.getAll()),A;if(r.position){i.deleteAll();const C=r.position;let x=O(s,u.default.cloneDeep(b),y,C);i.set(x),A=r.position}else{e&&e("\u8BF7\u79FB\u52A8\u9F20\u6807\u81F3\u6307\u5B9A\u4F4D\u7F6E\u70B9\u51FB\u8FDB\u884C\u7ED8\u5236"),s.setIsInteracting(!0);let C=await u.default.Draw.actionDrawPoint(s,{...t,updatecoordinate:x=>{if(!x.lnglat)return;i.deleteAll();const k=s.fromLngLat(x.lnglat);let T=O(s,u.default.cloneDeep(b),y,k);i.set(T)}});if(C.cancel){a();return}A=s.fromLngLat(C.features[0].geometry.coordinates)}let v;(!r.disableScale||!r.disableRotate)&&(v=new u.default.Polyline({data:s.toLngLat([A,A]),lineColor:(l=r.tempLineColor)!=null?l:"yellow",lineWidth:1,lineDasharray:[2,2]}),v.addTo(s));let S=1;if(r.disableScale){S=(c=r.scaleValue)!=null?c:1,i.deleteAll();let C=O(s,u.default.cloneDeep(b),y,A,S);i.set(C)}else{let C=await u.default.Draw.actionDrawPoint(s,{...t,updatecoordinate:x=>{if(i.deleteAll(),!x.lnglat)return;const k=s.fromLngLat(x.lnglat);let E=k.distanceTo(A)/(d.width()/2),M=O(s,u.default.cloneDeep(b),y,A,E);i.set(M),v.setData(s.toLngLat([A,k]))}});if(C.cancel)if(C.isEnterKey)S=1;else{a(),v.remove();return}else S=s.fromLngLat(C.features[0].geometry.coordinates).distanceTo(A)/(d.width()/2),S<1e-4&&(S=.1);v.setData(s.toLngLat([A,A]))}let D=0;if(r.disableRotate){D=(g=r.angleValue)!=null?g:0,i.deleteAll();let C=O(s,u.default.cloneDeep(b),y,A,S,D);i.set(C)}else{let C=await u.default.Draw.actionDrawPoint(s,{...t,updatecoordinate:x=>{if(i.deleteAll(),!x.lnglat)return;const k=s.fromLngLat(x.lnglat);D=k.angleTo(A)*180/Math.PI;let T=O(s,u.default.cloneDeep(b),y,A,S,D);i.set(T),v.setData(s.toLngLat([A,k]))}});if(v.remove(),C.cancel){if(!C.isEnterKey){a();return}D=0;let x=O(s,u.default.cloneDeep(b),y,A,S,D);i.set(x)}}s.setIsInteracting(!1);let w=i.getAll();return s.removeDrawLayer(i),{feature:w,rotation:D}}catch(f){a(),e&&e((h=f==null?void 0:f.message)!=null?h:f)}},It=async(o,s,t,e,r,i)=>{var A,v,S,D,w,C,x,k;i=i||{};let a=new u.default.DbLineType;a.name="my_arrow_dash",a.comments="\u865A\u7EBF",a.style=[{method:"numDashes",parameter:4},{method:"patternLength",parameter:1},{method:"dashLengthAt",parameter:[0,.5]},{method:"dashLengthAt",parameter:[1,-.2]},{method:"dashLengthAt",parameter:[2,.1]},{method:"dashLengthAt",parameter:[3,-.2]}];let n=[],l=(A=i.arrowShape)!=null?A:[[10,60],[150,20],[140,40],[190,0],[140,-40],[150,-20],[10,-40],[10,60]],g=u.default.getGeoBounds(l.map(T=>u.default.geoPoint(T))).scale(3).toArray(),h=new u.default.DbPolyline;h.lineWidth=(v=i.lineWidth)!=null?v:50,h.points=l,i.noLineType||(h.linetype="my_arrow_dash",h.linetypeScale=30),h.color=o.htmlColorToEntColor((S=e==null?void 0:e.outlineColor)!=null?S:u.default.randomColor());let f=(D=e==null?void 0:e.color)!=null?D:u.default.randomColor(),d=new u.default.DbHatch;if(d.pattern="SOLID",d.color=o.htmlColorToEntColor(f),d.points=l,d.alpha=100*((w=e==null?void 0:e.opacity)!=null?w:1),n.push(h,d),!i.noText){let T=new u.default.DbText({position:(C=i.textPositon)!=null?C:[100,70],contents:(x=i.contents)!=null?x:"\u7BAD\u5934",color:o.htmlColorToEntColor(f),horizontalMode:4,height:(k=i.textHeight)!=null?k:20});n.push(T)}let y=await z(o,n,g,{LWDISPLAY:!0},[a]),b=await q(y,o,t,r);!b||s.add(b==null?void 0:b.feature)},Tt=async(o,s,t,e,r,i)=>{var l;i=i||{};let a;if(i.coordinates)a=i.coordinates;else{let c=await u.default.Draw.actionDrawLineSting(o,{...t});if(c.cancel)return;a=o.fromLngLat(c.features[0].geometry.coordinates)}let n={};if(n.objectid=i.objectid,e!=null&&e.color&&(n.color=u.default.htmlColorToEntColor(e==null?void 0:e.color)),i.linetypeScale&&(n.linetypeScale=i.linetypeScale),i.isCurve?i.curveUseControlPoints?n.controlPoints=a.map(c=>[c.x,c.y]):n.fitPoints=a.map(c=>[c.x,c.y]):n.points=a.map(c=>[c.x,c.y]),n){let c=await z(o,[n],null,null,null,{mapid:i.mapid,version:(l=i.version)!=null?l:"v1"});H(c,s)}},Fr=(o,s,t)=>{let e=null,r=new Date;return function(){let i=this,a=arguments,n=new Date;clearTimeout(e),n-r>=t?(o.apply(i,a),r=n):e=setTimeout(function(){o.apply(i,a)},s)}},Ft=async(o,s,t,e,r,i)=>{var f;i=i!=null?i:{};let a=u.default.htmlColorToEntColor((f=e==null?void 0:e.color)!=null?f:u.default.randomColor());const n=async(d,m)=>{var b,A,v,S;let y={};if(y.objectid=(b=i==null?void 0:i.objectid)!=null?b:"40E",y.color=m,y.linetypeScale=(A=i==null?void 0:i.linetypeScale)!=null?A:100,y.fitPoints=d.map(D=>[D.x,D.y]),y)return await z(o,[y],null,null,null,{mapid:(v=i==null?void 0:i.mapid)!=null?v:"sys_symbols",version:(S=i==null?void 0:i.version)!=null?S:"v1"})};let l=o.createDrawLayer(),c=await u.default.Draw.actionDrawLineSting(o,{...t,updatecoordinate:Fr(async d=>{let m=o.fromLngLat(d.feature.coordinates),y=await n(m,a);l&&l.set(y)},200,300)});if(o.removeDrawLayer(l),l=null,c.cancel)return;let g=o.fromLngLat(c.features[0].geometry.coordinates),h=await n(g,a);h&&H(h,s)},Et=async(o,s,t,e,r,i)=>{var l,c,g;i=i!=null?i:{};let a;if(i.coordinates)a=i.coordinates;else{let h=await u.default.Draw.actionDrawPolygon(o,{...t});if(h.cancel)return;a=o.fromLngLat(h.features[0].geometry.coordinates[0])}let n=new u.default.DbHatch;if(n.objectid=(l=i.objectid)!=null?l:"42F",e!=null&&e.color&&(n.color=u.default.htmlColorToEntColor(e==null?void 0:e.color)),i.patternScale&&(n.patternScale=i.patternScale),n.points=a.map(h=>[h.x,h.y]),n){let h=await z(o,[n],null,null,null,{mapid:(c=i.mapid)!=null?c:"sys_symbols",version:(g=i.version)!=null?g:"v1"});H(h,s)}},Ye=async(o,s,t)=>{t=t!=null?t:{};let e=await o.getService().conditionQueryFeature({fields:"",includegeom:!0,realgeom:!0,limit:1e4,...s});const r=[];if(e&&e.result&&e.result.length>0){for(let i of e.result)if(i.geom&&i.geom.geometries){let a=o.entColorToHtmlColor(i.color);for(let n=0;n<i.geom.geometries.length;n++)r.push({id:u.default.RandomID(10),type:"Feature",properties:{objectid:i.objectid+"_"+n,color:a,alpha:i.alpha/255,opacity:i.alpha/255,lineWidth:1,name:i.name,isline:i.isline,layerindex:i.layerindex,...t},geometry:i.geom.geometries[n]})}}return{type:"FeatureCollection",features:r}},Pt=async(o,s,t,e,r,i)=>{var d,m,y;i=i!=null?i:{},r&&r("\u8BF7\u79FB\u52A8\u9F20\u6807\u5C06\u8981\u7ED8\u5236\u7684\u7B26\u53F7\u79FB\u52A8\u81F3\u6307\u5B9A\u4F4D\u7F6E\u70B9\u51FB\u8FDB\u884C\u7ED8\u5236");let a=(d=i.mapid)!=null?d:"sys_symbols",n=(m=i.version)!=null?m:"v1",c=await o.getService().getStyleLayerName(a,n,!0),g=await Ye(o,{mapid:a,version:n,layer:c,condition:(y=i.condition)!=null?y:"layerindex=1",simplifyTolerance:i.simplifyTolerance},{symbolId:u.default.RandomID()}),h=await q(g,o,t,r,{...e,baseAlign:"center",position:i.position,angleValue:i.angleValue,scaleValue:i.scaleValue});if(!h)return;let f=new Set(["disableScale","disableRotate","drawInitPixelLength","tempLineColor","baseAlign","keepGeoSize","position","scaleValue","angleValue","unCombineFeature"]);if(e!=null&&e.unCombineFeature){let b=[];for(let A=0;A<h.feature.features.length;A++){let v=h.feature.features[A].id;b.push(v),s.add(h.feature.features[A]);for(let S in e)f.has(S)||s.setFeatureProperty(v,S,e[S])}return b}else{H(h.feature,s);let b=s.getAll().features,A=b[b.length-1].id;for(let v in e)f.has(v)||s.setFeatureProperty(A,v,e[v]);return[A]}},Qe=async(o,s,t,e,r,i,a)=>{var y,b,A;if(e=e||{},!e.text)return;a=a!=null?a:[-1e3,-1e3,1e3,1e3];let n=[],l={position:[0,0],contents:e.text,color:o.htmlColorToEntColor(e.color),horizontalMode:u.default.DbTextHorzMode.kTextLeft,verticalMode:u.default.DbTextVertMode.kTextBottom,height:e.height||50},c=new u.default.DbText(l);n.push(c);let g=await z(o,n,a);const h=new u.default.GeoProjection(u.default.GeoBounds.fromArray(a));let f=re(h,g),d=re(o,g);if(l={...l,...f,mapRefCo1:d.refCo1,mapRefCo2:d.refCo2},i===!0){const v=o.createDrawLayer();H(g,v);let S=v.getAll(),D=S.features;return o.removeDrawLayer(v),D.length>0&&(D[0].properties=(y=D[0].properties)!=null?y:{},D[0].properties.export=l),S}let m=await q(g,o,t,r,{...e,baseAlign:"leftBottom",drawInitPixelLength:(b=e.height)!=null?b:50,disableRotate:e==null?void 0:e.disableRotate,disableScale:e==null?void 0:e.disableScale});!m||(m.feature.features[0].properties=(A=m.feature.features[0].properties)!=null?A:{},m.feature.features[0].properties.export=l,s.add(m.feature))},H=(o,s,t)=>{const e=new Set;if(t&&o.features.forEach(r=>{r&&r.properties&&r.properties.objectid&&e.add(r.properties.objectid)}),!t||e.size==0){let r=[];o.features.forEach(i=>{r.push(...s.add(i))}),s.changeMode("simple_select",{featureIds:r});try{s.combineFeatures()}catch{}return r.length}else{let r=s.getAll().features.length;for(let n of e){let l=[];if(o.features.forEach(c=>{c.properties.objectid==n&&l.push(...s.add(c))}),l.length!=0){s.changeMode("simple_select",{featureIds:l});try{s.combineFeatures()}catch{}}}let i=[],a=s.getAll().features;for(let n=r;n<a.length;n++)i.push(a[n].id);return s.changeMode("simple_select",{featureIds:i}),e.size}},Mt=()=>{const o=u.default.Draw.defaultOptions();let s=o.styles.findIndex(t=>t.id==="gl-draw-point-point-stroke-inactive");return s>=0&&(o.styles[s].paint["circle-radius"][3][3]=0),s=o.styles.findIndex(t=>t.id==="gl-draw-point-inactive"),s>=0&&(o.styles[s].paint["circle-radius"][3][3]=1),s=o.styles.findIndex(t=>t.id==="gl-draw-point-stroke-active"),s>=0&&(o.styles[s].paint["circle-radius"][3]=0),s=o.styles.findIndex(t=>t.id==="gl-draw-point-active"),s>=0&&(o.styles[s].paint["circle-radius"][3]=1),o},Bt=async(o,s,t)=>{let e=o.getService();if(t){let r=s.reduce((i,a)=>(a.isOff||i.push(a.name),i),[]);qe(o,r)}else await o.switchLayers(e,s.reduce((r,i)=>(i.isOff||r.push(i.name),r),[]))},qe=(o,s)=>{const t=c=>i.getMapLayers().findIndex(g=>g.name===c),e=(c,g)=>{Array.isArray(c)||(c=[c]);let h=[];return g||(h=c.map(f=>t(f))),h.length==0&&(h=[-1]),["match",["get","layer"],h,!0,!1]};let r=o.getStyle(),i=o.getService(),n=i.vectorStyle().layers.map(c=>c.id),l=e(s,!1);for(let c=0;c<r.layers.length;c++)n.includes(r.layers[c].id)&&(r.layers[c].filter=l);o.setStyle(r)},Ot=(o,s,t)=>{if(o.hasVectorLayer()){const e=o.layersBySource("vector-source");for(let r of e){const i=o.getLayer(r);i.type=="fill"?o.setFillOpacity(r,s):i.type=="line"?o.setLineOpacity(r,s):i.type=="circle"&&o.setCircleOpacity(r,s)}}if(t){const r=o.getStyle().layers.filter(i=>i.id.indexOf(t)>=0);for(let i of r)o.setRasterOpacity(i.id,s)}else{const e=o.getService().rasterLayerId();o.getLayer(e)&&o.setRasterOpacity(o.getService().rasterLayerId(),s)}},Rt=(o,s)=>{const t=o.getStyle().layers;t.length!=0&&o.moveLayer(s,t[0].id)};let Z,ae;async function Vt(o,s){switch(ae=s,s!="measureCancel"&&(await jt(o),Z||(Z={},be(o,Z))),s){case"measureDist":Er(o,Z);break;case"measureArea":Or(o,Z);break;case"measureAngle":jr(o,Z);break;case"measureCoordinate":Gr(o,Z);break;case"measureCancel":await jt(o);break}}const jt=async o=>{o.fire("keyup",{keyCode:27}),await ne(100),o.fire("keyup",{keyCode:27}),await ne(100),o.setIsInteracting(!1)};let K;const F=(o,s)=>{o?K?K.setHTML(o):K=new u.default.Popup({className:"my-custom-popup",closeOnClick:!1,closeButton:!1}).setHTML(o).setMaxWidth("500px").trackPointer().addTo(s):K&&(K.setLngLat([0,0]),K.remove(),K=null)},Er=async(o,s)=>{for(;!((await Pr(o,s)).exit===!0||ae!="measureDist"););},Pr=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawLineSting(o,{api:{getSnapFeatures:s},updatecoordinate:a=>{if(!a.lnglat)return;t=!0;const n=o.fromLngLat(a.feature.coordinates[a.feature.coordinates.length-1]);let l=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u8DDD\u79BB\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${n.x.toFixed(2)}, ${n.y.toFixed(2)}</span>`;if(a.feature.coordinates.length==1)l+="<br/>\u8BF7\u6307\u5B9A\u8981\u6D4B\u91CF\u7684\u7B2C\u4E00\u70B9\u7684\u5750\u6807\u4F4D\u7F6E";else{let c=a.feature.coordinates.length;l+="<br/>\u6309Alt\u952E\u53D6\u6355\u6349; Ctrl\u952E\u542F\u7528\u6B63\u4EA4; \u9000\u683C\u952E\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",l+=`<br/>\u8DDD\u4E0A\u4E00\u70B9\u8DDD\u79BB: <span style="color: #ff0000">${Xe(o,[a.feature.coordinates[c-2],a.feature.coordinates[c-1]])}</span>`,l+=`;  \u5F53\u524D\u603B\u7684\u8DDD\u79BB: <span style="color: #ff0000">${Xe(o,a.feature.coordinates)}</span></span>`}F(l,o)},contextMenu:a=>{new u.default.ContextMenu({event:a.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",onClick:()=>{o.fire("keyup",{keyCode:8})}},{label:"\u7ED3\u675F\u6D4B\u8DDD",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});if(e.cancel)return F("",o),{cancel:!0,exit:t===!1};let r=u.default.randomColor(),i=new u.default.Polyline({data:e.features[0].geometry.coordinates,lineColor:r,lineWidth:2});return i.addTo(o),Mr(o,e.features[0].geometry.coordinates,r,i.sourceId||"",s),{polyline:i}},Mr=(o,s,t,e,r)=>{let i=[];for(let c=1;c<s.length;c++){let g=new u.default.Text({text:Xe(o,s.slice(0,c+1)),anchor:"left",offset:[3,0],style:{cursor:"pointer",opacity:.8,padding:"6px","border-radius":"12px","background-color":t,"border-width":0,"box-shadow":"0px 2px 6px 0px rgba(97,113,166,0.2)","text-align":"center","font-size":"14px",color:`#${t.substring(1).split("").map(h=>(15-parseInt(h,16)).toString(16)).join("")}`}});g.setLngLat(s[c]).addTo(o),i.push(g)}const a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let n=document.createElement("div");n.className="marker",n.style.backgroundImage=`url(${a})`,n.style.width="20px",n.style.height="20px",n.style.backgroundSize="100%",n.style.cursor="pointer",n.addEventListener("click",function(c){o.removeSourceEx(e),i.forEach(g=>g.remove()),i=[],o.fire("keyup",{keyCode:8})});let l=new u.default.Marker({element:n,anchor:"right"});l.setLngLat(s[0]).setOffset([-5,0]).addTo(o),i.push(l),$e(r,s)},Xe=(o,s)=>{let t=u.default.Math2D.lineDist(o.fromLngLat(s)),e="m";return t>=1e3?(t/=1e3,e="km"):t<.01&&(t*=100,e="cm"),t.toFixed(2)+" "+e},$e=(o,s)=>{o.features.push({type:"Feature",geometry:{type:"LineString",coordinates:[...s]}})},Br=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawPolygon(o,{api:{getSnapFeatures:s},updatecoordinate:a=>{if(!a.lnglat)return;t=!0;const n=o.fromLngLat(a.feature.coordinates[0][a.feature.coordinates.length-1]);let l=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u9762\u79EF\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${n.x.toFixed(2)}, ${n.y.toFixed(2)}</span>`;a.feature.coordinates[0].length==1?l+="<br/>\u8BF7\u6307\u5B9A\u8981\u6D4B\u91CF\u7684\u7B2C\u4E00\u70B9\u7684\u5750\u6807\u4F4D\u7F6E":(l+="<br/>\u6309Alt\u952E\u53D6\u6355\u6349; Ctrl\u952E\u542F\u7528\u6B63\u4EA4; \u9000\u683C\u952E\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",l+=`<br/>\u5F53\u524D\u9762\u79EF: <span style="color: #ff0000">${Nt(o,a.feature.coordinates[0])}</span></span>`),F(l,o)},contextMenu:a=>{new u.default.ContextMenu({event:a.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",onClick:()=>{o.fire("keyup",{keyCode:8})}},{label:"\u7ED3\u675F\u6D4B\u9762\u79EF",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});if(e.cancel)return F("",o),{cancel:!0,exit:t===!1};let r=u.default.randomColor(),i=new u.default.Polygon({data:e.features[0].geometry.coordinates[0],fillColor:r,fillOpacity:.4,fillOutlineColor:r});return i.addTo(o),Rr(o,e.features[0].geometry.coordinates[0],r,i.sourceId||"",s),{polygon:i}},Or=async(o,s)=>{for(;!((await Br(o,s)).exit===!0||ae!="measureArea"););},Rr=(o,s,t,e,r)=>{let i=[];const a=u.default.polygonCentroid(o.fromLngLat(s));let n=new u.default.Text({text:Nt(o,s),anchor:"center",offset:[0,0],style:{cursor:"pointer",opacity:.8,padding:"6px","border-radius":"12px","background-color":`#${t.substring(1).split("").map(h=>(15-parseInt(h,16)).toString(16)).join("")}`,"border-width":0,"box-shadow":"0px 2px 6px 0px rgba(97,113,166,0.2)","text-align":"center","font-size":"14px",color:t}});n.setLngLat(o.toLngLat(a)).addTo(o),i.push(n);const l="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let c=document.createElement("div");c.className="marker",c.style.backgroundImage=`url(${l})`,c.style.width="20px",c.style.height="20px",c.style.backgroundSize="100%",c.style.cursor="pointer",c.addEventListener("click",function(h){o.removeSourceEx(e),i.forEach(f=>f.remove()),i=[]});let g=new u.default.Marker({element:c,anchor:"right"});g.setLngLat(s[0]).setOffset([-5,0]).addTo(o),i.push(g),$e(r,s)},Nt=(o,s)=>{let t=u.default.calcPolygonArea(o.fromLngLat(s)),e="m\xB2";return t>=1e6?(t/=1e6,e="km\xB2"):t<1/1e4&&(t*=1e4,e="cm\xB2"),t.toFixed(2)+" "+e},Vr=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawLineSting(o,{pointCount:3,api:{getSnapFeatures:s},updatecoordinate:a=>{if(!a.lnglat)return;t=!0;const n=o.fromLngLat(a.feature.coordinates[a.feature.coordinates.length-1]);let l=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u89D2\u5EA6\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${n.x.toFixed(2)}, ${n.y.toFixed(2)}</span>`;a.feature.coordinates.length==1?l+="<br/>\u8BF7\u6307\u5B9A\u8981\u6D4B\u91CF\u7684\u7B2C\u4E00\u70B9\u7684\u5750\u6807\u4F4D\u7F6E":(a.feature.coordinates.length,l+="<br/>\u6309Alt\u952E\u53D6\u6355\u6349; Ctrl\u952E\u542F\u7528\u6B63\u4EA4; \u9000\u683C\u952E\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",l+=`<br/>\u5F53\u524D\u89D2\u5EA6: <span style="color: #ff0000">${Ht(o,a.feature.coordinates).angle}</span></span>`),F(l,o)},contextMenu:a=>{new u.default.ContextMenu({event:a.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",onClick:()=>{o.fire("keyup",{keyCode:8})}},{label:"\u7ED3\u675F\u6D4B\u89D2\u5EA6",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});if(e.cancel)return F("",o),{cancel:!0,exit:t===!1};let r=u.default.randomColor(),i=new u.default.Polyline({data:e.features[0].geometry.coordinates,lineColor:r,lineWidth:2});return i.addTo(o),Nr(o,e.features[0].geometry.coordinates,r,i.sourceId||"",s),{polyline:i}},jr=async(o,s)=>{for(;!((await Vr(o,s)).exit===!0||ae!="measureAngle"););},Nr=(o,s,t,e,r)=>{if(s.length<3)return;let i=[],a=o.fromLngLat(s);s[1];let n=Ht(o,s);const l=u.default.getCirclePolygonCoordinates(a[1],a[1].distanceTo(a[0])/4,36,n.startAngle,n.endAngle,!1);let c=new u.default.Polyline({data:o.toLngLat(l),lineColor:t,lineWidth:2});c.addTo(o),i.push(c);let g=c.getData().features[0].geometry.coordinates,h=g[Math.ceil(g.length/2)],f=u.default.radiansToDegrees(-o.fromLngLat(h).angleTo(a[1]))+90;f>90?f+=180:f>270&&(f-=180);let d=new u.default.Text({text:n.angle,anchor:"center",rotation:f,offset:[0,0],style:{cursor:"pointer",opacity:.8,padding:"6px","border-radius":"12px","background-color":t,"border-width":0,"box-shadow":"0px 2px 6px 0px rgba(97,113,166,0.2)","text-align":"center","font-size":"14px",color:`#${t.substring(1).split("").map(A=>(15-parseInt(A,16)).toString(16)).join("")}`}});d.setLngLat(h).addTo(o),i.push(d);const m="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let y=document.createElement("div");y.className="marker",y.style.backgroundImage=`url(${m})`,y.style.width="20px",y.style.height="20px",y.style.backgroundSize="100%",y.style.cursor="pointer",y.addEventListener("click",function(A){o.removeSourceEx(e),i.forEach(v=>v.remove()),i=[]});let b=new u.default.Marker({element:y,anchor:"right"});b.setLngLat(s[1]).setOffset([-5,0]).addTo(o),i.push(b),$e(r,s)},Ht=(o,s)=>{let t=o.fromLngLat(s);if(t.length<3)return{angle:0};let e=t[0].angleTo(t[1]),r=t[2].angleTo(t[1]),i=e-r,a=u.default.radiansToDegrees(i),n=!0;a<0&&(a=-a,n=!n),a>180&&(a=360-a,n=!n);let l=n?u.default.radiansToDegrees(r):u.default.radiansToDegrees(e),c=n?u.default.radiansToDegrees(e):u.default.radiansToDegrees(r);return l=l<0?360+l:l,c=c<0?360+c:c,c<l&&(c+=360),{angle:a.toFixed(2)+"\xB0",dir:n,startAngle:l,endAngle:c}},Hr=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawPoint(o,{api:{getSnapFeatures:s},updatecoordinate:r=>{if(!r.lnglat)return;t=!0;const i=o.fromLngLat(r.lnglat);let a=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u5750\u6807\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${i.x.toFixed(2)}, ${i.y.toFixed(2)}</span></span>`;F(a,o)},contextMenu:r=>{new u.default.ContextMenu({event:r.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u7ED3\u675F\u6D4B\u5750\u6807",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});return e.cancel?(F("",o),{cancel:!0,exit:t===!1}):(zr(o,e.features[0].geometry.coordinates),{point:e})},Gr=async(o,s)=>{for(;!((await Hr(o,s)).exit===!0||ae!="measureCoordinate"););},zr=(o,s)=>{let t=[],e=o.fromLngLat(s),r=`X: ${e.x.toFixed(2)}, Y: ${e.y.toFixed(2)}`,i=Wr(o,s,r);t.push(i);const a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let n=document.createElement("div");n.className="marker",n.style.backgroundImage=`url(${a})`,n.style.width="20px",n.style.height="20px",n.style.backgroundSize="100%",n.style.cursor="pointer",n.addEventListener("click",function(c){t.forEach(g=>g.remove()),t=[]});let l=new u.default.Marker({element:n,anchor:"right"});l.setLngLat(s).setOffset([-5,0]).addTo(o),t.push(l)},Wr=(o,s,t)=>{let e=document.createElement("div");e.className="marker",e.style.position="absolute";let r=document.createElement("div");r.style.backgroundImage='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAB4AAAAAlCAYAAACj1PQVAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTJFMTU1RjExN0UzMTFFOTg3RTBFODdGNTY0NThGQkUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTJFMTU1RjIxN0UzMTFFOTg3RTBFODdGNTY0NThGQkUiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMkUxNTVFRjE3RTMxMUU5ODdFMEU4N0Y1NjQ1OEZCRSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMkUxNTVGMDE3RTMxMUU5ODdFMEU4N0Y1NjQ1OEZCRSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pj97JFoAAAV9SURBVHja7N1faJ1nHQfw33nzpuekaZfWNFmbLHXWdf7DWgvebF4M0SEZhTG8mKvFyzG9UJFKh9peVGnd0DkE/10Ic6s6BBEGbshggho3BVGnRnC2s1n/ras2J2uzc05PXp+3yZzSm7XJkvfi84HveZ9z3ve8F7/bL8/71oqiiMs8NhCLsCllfcpfAwAAAAAAAIDlsXM68jfgtl9K2Z3Sa8IAAAAAAAAAb7hjKW8uF9kS3/jdKR9PaZkxAAAAAAAAwPJa6h3A96X0pBxK+bLxAgAAAAAAACyfpSyAP5jy4ZQXUh747687p00ZAAAAAAAAYBlkS3if+xfW+1MuGC0AAAAAAADA8lqqAnh3yvaUZ1MeMlYAAAAAAACA5bcUBXBfyoGF9edSusYKAAAAAAAAsPyWogD+VMpYypMpTxgpAAAAAAAAwMpYbAG8IWVvylzKHuMEAAAAAAAAWDmLLYC/mDKQ8nDKH4wTAAAAAAAAYOUspgC+IeWelNmYL4IBAAAAAAAAWEGLKYAPpfSmfD1lyigBAAAAAAAAVtbVFsA3pdyR8lLMF8EAAAAAAAAArLCrKYBrKfcvHA+kNI0RAAAAAAAAYOVdTQFc7vwtdwA/l/ItIwQAAAAAAACohistgMt3/h5cWO9N6RghAAAAAAAAQDVcaQF8d8rWlImUnxgfAAAAAAAAQHVcSQF8Tcq+lCJlz8IRAAAAAAAAgIq4kgK4fOTzUMzv/J0wOgAAAAAAAIBqeb0F8FjKp2P+nb97jQ0AAAAAAACgel5vAXwgpS/l2ynPGRsAAAAAAABA9eSjd370sh+P7/q/r9tTdqc0Y74IBgAAAAAAAKCC8v9Zl7uB6yn9o4fHG+lYS2n/867Hv5bXivLcoZQzRgYAAAAAAABQTfnw5nvjxWMHe9N6cP+OyVtv2nj2ruFG6209WbGqM5c181rx9m5RO/ngn2/4zlf/tLV2fNfPCmMDAAAAAAAAqJ68LH+HGq2xRz7wu2+8a31zvCgiLs5FlC3vqp4YKS8638mzqZf7tqXlb1MuGBsAAAAAAABA9ZSPdh58tfyd7UScOh9xYjqLszNZlGVwN6U/71z7hR1/e/g9g9NbRg+P9xobAAAAAAAAQPVk+3ZMfujV8vf0TC3WXWzE9ZveHyNjt0UxOxCnp7NotiPWr2pfl67dk/6zxtgAAAAAAAAAqie7eePZXeVO33OtiOGsHqtvfjDi1scibnkkesafipHVI3HuQi3a3Yh3rpsZT/+5ZvTweM3oAAAAAAAAAKolH2q0byzf+dtuZ9G/8b0RW+587ezat0a84xPR+8z+aHU7MVDvbLhl05lrf3FyaGr08Hj5muA4/qMfmiIAAAAAAABABWS1KPJLTW75UR+8/Ir6uksvCi6K+a/Dfa26sQEAAAAAAABUT/ZyJz+Z19IiL6J7eiLi/NRrZ4tuxNEfRzvmorcnoj2XvfL41MZTMV8XAwAAAAAAAFAh2eS5tU9kWcRAo4ipC9MRP98ZMfnNiH/8IOLJO+LMC7+ORl83Gj0RR5r9z8x08nOhAAYAAAAAAAConPyzT2976H1D//7YYL21ZW5NN442n4/ep/ddeuxzK+air68bb2pEdCN75dEj192Xfp4xNgAAAAAAAIDqyWY6+akHnt16d7Oz6uRAPWJkoIi1azuxek0nhge6MdQXUatlrZ8+P/L5706+ZSLKXhgAAAAAAACAyik3+s5+/++bJ+751fbbfv/S+kc7c/l0WQSva0TUe2rtIzNrJr7yxxs/8pnfbPteurY5vPlej38GAAAAAAAAqKC8LHRfPHZw9penNvwl5ZP1nrmB268/MdafX+x96sTQ8aMz/f9K102ntJS/AAAAAAAAANX1HwEGAM75MhcANnAkAAAAAElFTkSuQmCC")',r.style.backgroundRepeat="no-repeat",r.style.height="37px",r.style.width="100px",r.style.position="absolute",r.style.left="-3px",r.style.bottom="-3px",r.style.right="0px",e.appendChild(r);let i=document.createElement("div");i.style.height="50px",i.style.width="350px",i.style.position="absolute",i.style.left="97px",i.style.top="-60px",i.style.border="solid 1px #8E0EFF",i.style.background="linear-gradient(#00ffff, #00ffff) left top,  linear-gradient(#00ffff, #00ffff) left top,     linear-gradient(#00ffff, #00ffff) right bottom,    linear-gradient(#00ffff, #00ffff) right bottom",i.style.backgroundRepeat="no-repeat",i.style.backgroundColor="rgba(87,255,255, 0.3)",i.style.backgroundSize="1px 6px, 6px 1px",i.style.fontSize="18px",i.style.color="#ffffff",i.innerHTML=`<div style='margin: 15px 5px 15px 5px'>${t}</div>`,e.appendChild(i);let a=new u.default.Marker({element:e,anchor:"bottom-left"});return a.setLngLat(s).addTo(o),a},Gt=(o,s)=>o.hasVectorLayer()?tt(o,s):et(o,s),et=(o,s)=>{s=s||{};const t=o.getService(),e=new Set;let r="",i={};const a=f=>{var d,m;i={backcolor:(d=t.currentMapParam())!=null&&d.darkMode?0:16777215,expression:r,...f,...s==null?void 0:s.style},o.updateStyle(t,{name:(m=s==null?void 0:s.styleName)!=null?m:"myCustomStyle_temp",...i})},n=f=>{let d="";return f!==void 0&&(d+=`gOutVisible:=${f?1:0};`),d},l=f=>(Array.isArray(f)||(f=[f]),`gInObjectId  in  '${f.join("||")}'`),c=async()=>{if(e.size==0)r="",await a();else{let f=l(Array.from(e)),d=n(!1);r=`if(${f}) {${d} } `,await a()}};return{addHideObjectIds:async(f,d,m)=>{m&&e.clear(),f.forEach(y=>e.add(y)),d||await c()},refresh:c,hideObjectIds:e,getClipBounds:()=>{var f,d;if((f=s==null?void 0:s.style)!=null&&f.clipbounds)return(d=s==null?void 0:s.style)==null?void 0:d.clipbounds}}},tt=(o,s)=>{const t=o.getService(),e=new Set,r=l=>(Array.isArray(l)||(l=[l]),["match",["id"],l,!0,!1]),i=async()=>{let l=t.vectorStyle().layers.map(g=>g.id),c=Array.from(e);o.setFilterEx(l,["!",r(c)])};return{addHideObjectIds:async(l,c,g)=>{g&&e.clear(),l.forEach(h=>e.add(h)),c||await i()},refresh:i,hideObjectIds:e,getClipBounds:()=>{var l,c;if((l=s==null?void 0:s.style)!=null&&l.clipbounds)return(c=s==null?void 0:s.style)==null?void 0:c.clipbounds}}};p.CacheDbStorage=Ie,p.LayerBase=I,p.MapApp=lt,p.ProcessDataToFeatureCollection=ce,p.TsIndexDb=W,p.WmsOverlayMapType=Me,p.addExportRefInfoInText=re,p.addFeaturesToDraw=H,p.addHighLightSourceLayer=_e,p.base2OverlayCoordinate=at,p.cacheStorage=Q,p.cad2webCoordinate=Ge,p.cancelDraw=Je,p.clearHighLightSourceLayer=se,p.clearHighlight=pe,p.convertArrayToGeoJson=de,p.copyCadEntity=gt,p.createGeomData=z,p.createHatch=Et,p.createLineTypeCurve=Ft,p.createLineTypePolyline=Tt,p.createMapStyleLayerName=ee,p.createOutSymbol=Pt,p.createUpdateMapStyleObj=Gt,p.createUpdateMapStyleRasterObj=et,p.createUpdateMapStyleVectorObj=tt,p.default=rt,p.deleteCadEntity=dt,p.drawArrow=It,p.drawCircle=bt,p.drawEllipseArc=kt,p.drawEllipseEdge=St,p.drawEllipseFill=Ct,p.drawEllipseFillArc=xt,p.drawFillExrusion=At,p.drawLineSting=mt,p.drawPoint=yt,p.drawPolygon=pt,p.drawRectangle=wt,p.drawSlantRectangle=Lt,p.drawText=Qe,p.editCadEntity=ie,p.evalDataConvert=Te,p.execProgram=ve,p.exportDwg=ct,p.gaodeProviderTiles=Ee,p.getEntityObjectId=Y,p.getEpsgRange=nt,p.getGeoJsonBounds=Le,p.getHighlightEntities=Ze,p.getInstance=ke,p.getMapSnapPoints=be,p.getPointOnePixelDrawStyleOption=Mt,p.getQueryGeomData=Ye,p.getShardsTileUrl=le,p.getTextRefCo=We,p.getTileShards=De,p.getTrackFeatureProperty=N,p.getWmsAutoCadBaseMapTileUrl=je,p.getWmsAutoWebBaseMapTileUrl=Ve,p.getWmsDirectTileUrl=Re,p.getWmsMapsBounds=Be,p.getWmsParamTileUrl=Ne,p.getWmsTileUrl=He,p.initIndexDb=xe,p.interactiveCreateGeom=q,p.isAlphanumeric=ue,p.isTrackFeature=te,p.isWebBaseMap=j,p.listenKeyEvent=fe,p.loadDataToDraw=ht,p.loadWebMap=Pe,p.modifyCadEntity=ft,p.modifyDrawText=ut,p.osmProviderTiles=it,p.overlay2BaseCoordinate=ze,p.polygonToPolyline=oe,p.providerLayers=Se,p.queryMapData=$,p.requestChangeData=U,p.runMeasureCmd=Vt,p.selectFeatures=Ke,p.selectRotate=vt,p.setFeatureProperty=R,p.setLayerOpacity=Ot,p.setLayerToLowest=Rt,p.setTrackFeatureProperty=Ue,p.sleep=ne,p.switchCadLayers=Bt,p.switchVectorLayers=qe,p.tiandituProviderTiles=Fe,p.toBezierCurve=Dt,p.toMapLayer=P,p.toProperties=G,p.transformFourParam=Ce,p.transformGeoJsonData=O,p.web2cadCoordinate=ot,Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=vjcommon.min.js.map
