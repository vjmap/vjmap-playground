(function(p,M){typeof exports=="object"&&typeof module<"u"?M(exports,require("vjmap")):typeof define=="function"&&define.amd?define(["exports","vjmap"],M):(p=typeof globalThis<"u"?globalThis:p||self,M(p.vjcommon={},p.vjmap))})(this,function(p,M){"use strict";var zr=Object.defineProperty;var Wr=(p,M,J)=>M in p?zr(p,M,{enumerable:!0,configurable:!0,writable:!0,value:J}):p[M]=J;var L=(p,M,J)=>(Wr(p,typeof M!="symbol"?M+"":M,J),J);const u=(o=>o&&typeof o=="object"&&"default"in o?o:{default:o})(M),Xe=Object.freeze(Object.defineProperty({__proto__:null,get MapApp(){return it},get providerLayers(){return De},get LayerBase(){return x},get exportDwg(){return ot},get setFeatureProperty(){return B},get cancelDraw(){return _e},get drawPoint(){return ct},get drawLineSting(){return dt},get drawPolygon(){return ft},get drawFillExrusion(){return ht},get polygonToPolyline(){return se},get drawCircle(){return gt},get drawRectangle(){return yt},get drawSlantRectangle(){return mt},get selectRotate(){return pt},get toBezierCurve(){return At},get drawEllipseFill(){return wt},get drawEllipseEdge(){return bt},get drawEllipseFillArc(){return Lt},get drawEllipseArc(){return vt},get getGeoJsonBounds(){return be},get interactiveCreateGeom(){return q},get drawArrow(){return Dt},get createLineTypePolyline(){return Ct},get createLineTypeCurve(){return St},get createHatch(){return kt},get getQueryGeomData(){return Ze},get createOutSymbol(){return xt},get drawText(){return It},get addFeaturesToDraw(){return H},get getPointOnePixelDrawStyleOption(){return Tt},get isTrackFeature(){return ee},get setTrackFeatureProperty(){return He},get getTrackFeatureProperty(){return V},get addExportRefInfoInText(){return ye},get editCadEntity(){return re},get deleteCadEntity(){return at},get modifyCadEntity(){return nt},get copyCadEntity(){return lt},get createGeomData(){return G},get loadDataToDraw(){return ut},get CacheDbStorage(){return ke},get cacheStorage(){return Q},get TsIndexDb(){return W},get initIndexDb(){return Ce},get getInstance(){return Se},get switchCadLayers(){return Ft},get switchVectorLayers(){return Ke},get setLayerOpacity(){return Et},get setLayerToLowest(){return Pt},get queryMapData(){return X},get toProperties(){return N},get ProcessDataToFeatureCollection(){return le},get requestChangeData(){return U},get convertArrayToGeoJson(){return ue},get evalDataConvert(){return xe},get runMeasureCmd(){return Mt},get addHighLightSourceLayer(){return ze},get clearHighLightSourceLayer(){return te},get getHighlightEntities(){return We},get clearHighlight(){return me},get selectFeatures(){return Ue},get getMapSnapPoints(){return Ae},get createUpdateMapStyleObj(){return Vt},get createUpdateMapStyleRasterObj(){return Qe},get createUpdateMapStyleVectorObj(){return qe},get listenKeyEvent(){return ce},get WmsOverlayMapType(){return Ee},get createMapStyleLayerName(){return $},get getWmsMapsBounds(){return Pe},get getWmsDirectTileUrl(){return Be},get getWmsAutoWebBaseMapTileUrl(){return Oe},get getWmsAutoCadBaseMapTileUrl(){return Re},get getWmsParamTileUrl(){return Ve},get getWmsTileUrl(){return je},get cad2webCoordinate(){return Ne},get web2cadCoordinate(){return tt},get overlay2BaseCoordinate(){return Ge},get base2OverlayCoordinate(){return rt},get getEpsgRange(){return st},get osmProviderTiles(){return et},get tiandituProviderTiles(){return Ie},get gaodeProviderTiles(){return Te},get loadWebMap(){return Fe},get toMapLayer(){return P},get sleep(){return oe},get execProgram(){return Le},get getShardsTileUrl(){return ae},get getTileShards(){return ve},get isAlphanumeric(){return ne},get isWebBaseMap(){return R},get getEntityObjectId(){return Y},get transformGeoJsonData(){return j}},Symbol.toStringTag,{value:"Module"}));function P(o,s){return{layerId:o.layerId,sourceId:o.sourceId,tag:o.tag,type:o.type,before:o.before,visibleOff:o.visibleOff,...s}}function oe(o){return new Promise(s=>setTimeout(s,o!=null?o:100))}async function Le(o,s,t,e){const r=Object.getPrototypeOf(async function(){}).constructor;return await new r("vjmap","map","mapApp","context","vjcommon",o)(u.default,s,t,e,Xe)}const ae=(o,s)=>{if(!o)return[o];if(s){let c=s.getService();o=o.replace("{serviceUrl}",c.serverUrl),o=o.replace("{accessToken}",c.accessToken)}let e=/{(\d+-\d+)}/g.exec(o);if(!e)return[o];let r=e[0];if(!r)return[o];r=r.replace("{",""),r=r.replace("}","");let i=r.split("-");if(i.length!=2)return[o];let a=+i[0],n=+i[1];if(n<=a)return[o];let l=[];for(let c=a;c<=n;c++)l.push(o.replace(e[0],c+""));return l},ve=o=>{if(!o)return{tileUrl:o,tileShards:""};let t=/{(\d+-\d+)}/g.exec(o);if(!t)return{tileUrl:o,tileShards:""};let e=t[0];if(!e)return{tileUrl:o,tileShards:""};const r=o.replace(e,"{s}");e=e.replace("{",""),e=e.replace("}","");let i=e.split("-");if(i.length!=2)return{tileUrl:o,tileShards:""};let a=+i[0],n=+i[1];if(n<=a)return{tileUrl:o,tileShards:""};let l=[];for(let c=a;c<=n;c++)l.push(c);return{tileUrl:r,tileShards:l.join(",")}},ne=o=>/^[a-zA-Z0-9]+$/.test(o),R=o=>!(o==""||o=="CAD"||o===void 0),Y=o=>{let s="",t=0;for(t=0;t<o.length&&ne(o[t]);t++)s+=o[t];return s},j=(o,s,t,e,r=1,i=0)=>u.default.transform.convert(s,a=>{let n=o.fromLngLat(u.default.geoPoint(a));return n.transform(t,e,r,i),o.toLngLat(n)});class x{constructor(){L(this,"map");L(this,"mapLayer");L(this,"visibleOff")}async addLayer(s,t){this.map=s,this.mapLayer=t}setLayerStyle(s,t,e,r){this.mapLayer=P(r,e),this.removeLayer(s,t),this.addLayer(s,P(r,e))}setVisible(s,t,e){this.visibleOff=e}removeLayer(s,t){}getLayerId(){return this.mapLayer.layerId}onSourceDataChange(s,t,e,r){!this.mapLayer||!this.map||t&&this.mapLayer.sourceId!=t||this.mapLayer.disableTimerUpdate||this.visibleOff!==!0&&(this.removeLayer(s,this.mapLayer.layerId),this.addLayer(s,this.mapLayer))}async loadUrlImage(s){return new Promise((t,e)=>{const r=new Image;r.src=s,r.onload=()=>{t(r)},r.onerror=()=>{e(`load image ${s} error`)}})}evalValue(s,t,e){if(typeof s=="string")try{return new Function("props","map","vjmap",s)(t,e,u.default)}catch{}else{let r={};for(let i in s){let a=s[i];if(typeof a=="string"&&a.indexOf("return ")>=0)try{a=new Function("props","map","vjmap",a)(t,e,u.default)}catch{}r[i]=a}return r}}async createAnimateImages(s,t){var a;let e,r=Object.keys(t).filter(n=>n.indexOf("animateImages_")==0),i={};for(let n of r)i[n.replace("animateImages_","")]=t[n];if(t.animateImagesType=="arrow")e=u.default.createArrowAnimateImages(i);else if(t.animateImagesType=="antpath")e=u.default.createAntPathAnimateImages(i);else if(t.animateImagesType=="customImage"){let n=await this.loadUrlImage(t.customImageUrl),l={...i,draw:(c,h,y,f)=>{f.fillColor&&(c.fillStyle=f.fillColor,c.fillRect(0,0,h,y)),c.drawImage(n,0,0,n.width,n.height,0,y/2-n.height/2,h,n.height)}};e=u.default.createAntPathAnimateImages(l)}else if(t.animateImagesType=="animateImages"){e=[];for(let n=0;n<((a=t.animateImageUrls)==null?void 0:a.length);n++){let l=`image_animate_${t.layerId}_${n}`;s.hasImage(l)&&s.removeImage(l),await s.loadImageEx(l,t.animateImageUrls[n]),e.push(l)}}else if(t.animateImagesType=="imageSprites"){let n=await this.loadUrlImage(t.imageSpriteUrl);e=u.default.createAntPathAnimateImages({fromImage:n,...i})}else e=u.default.createAnimateImages(i);return e}setMarkerOptions(s,t){(t==null?void 0:t.minZoom)!==void 0&&s.setMinZoom(t==null?void 0:t.minZoom),(t==null?void 0:t.maxZoom)!==void 0&&s.setMaxZoom(t==null?void 0:t.maxZoom),(t==null?void 0:t.scaleMaxZoom)!==void 0&&s.setScaleMaxZoom(t==null?void 0:t.scaleMaxZoom),(t==null?void 0:t.height)!==void 0&&s.setHeight(t==null?void 0:t.height),(t==null?void 0:t.removeWhenNoInMapView)!==void 0&&s.setRemoveWhenNoInMapView(t==null?void 0:t.removeWhenNoInMapView,t==null?void 0:t.removeWhenNoInMapViewPadding),(t==null?void 0:t.rotation)!==void 0&&s.setRotation(t==null?void 0:t.rotation),(t==null?void 0:t.animationType)!==void 0&&s.setAnimation(t==null?void 0:t.animationType),(t==null?void 0:t.draggable)!==void 0&&s.setDraggable(t==null?void 0:t.draggable),(t==null?void 0:t.rotationAlignment)!==void 0&&s.setRotationAlignment(t==null?void 0:t.rotationAlignment),(t==null?void 0:t.pitchAlignment)!==void 0&&s.setPitchAlignment(t==null?void 0:t.pitchAlignment)}}class Wt extends x{constructor(){super();L(this,"polyline")}async addLayer(t,e){super.addLayer(t,e),this.polyline=new u.default.Polyline(e),this.polyline.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.polyline.hide():this.polyline.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Ut extends x{constructor(){super();L(this,"polygon")}async addLayer(t,e){super.addLayer(t,e),this.polygon=new u.default.Polygon(e),this.polygon.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.polygon.hide():this.polygon.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class _t extends x{constructor(){super();L(this,"symbol")}async addLayer(t,e){super.addLayer(t,e),this.symbol=new u.default.Symbol(e),this.symbol.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.symbol.hide():this.symbol.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Zt extends x{constructor(){super();L(this,"circle")}async addLayer(t,e){super.addLayer(t,e),this.circle=new u.default.Circle(e),this.circle.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.circle.hide():this.circle.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Kt extends x{constructor(){super();L(this,"fillExtrusion")}async addLayer(t,e){super.addLayer(t,e),this.fillExtrusion=new u.default.FillExtrusion(e),this.fillExtrusion.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.fillExtrusion.hide():this.fillExtrusion.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Jt extends x{constructor(){super();L(this,"heatmap")}async addLayer(t,e){super.addLayer(t,e),this.heatmap=new u.default.Heatmap(e),this.heatmap.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.heatmap.hide():this.heatmap.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Yt extends x{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){var n,l,c;if(r=this.evalValue(r,e,i),r.customHtml){let h=this.evalValue(r.customHtml,e,i);r.element=h}else if(r.customImage){let h=document.createElement("div");h.className="marker",r.customImage.toLowerCase().indexOf("<svg")==0&&(r.customImage="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(r.customImage)))),h.style.backgroundImage=`url("${r.customImage}")`,h.style.width=((n=r.customImageWidth)!=null?n:40)+"px",h.style.height=((l=r.customImageHeight)!=null?l:40)+"px",h.style.backgroundSize="100%",r.element=h}let a=u.default.createMarker(r);if(a.setLngLat(t).addTo(i),r.animationType&&a.setAnimation(r.animationType),r.popupHtml){let h=new u.default.Popup({offset:(c=r.popupOffset)!=null?c:[0,0],anchor:r.popupAnchor,closeButton:r.closeButton,closeOnClick:r.closeOnClick,closeOnMove:r.closeOnMove,focusAfterOpen:r.focusAfterOpen,className:r.className,maxWidth:r.maxWidth}),y=r.popupHtml,f=this.evalValue("return `"+y+"`",e,i);h.setHTML(f),a.setPopup(h)}this.markers=this.markers||[],this.markers.push(a)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class Qt extends x{constructor(){super();L(this,"popups")}createPopup(t,e,r,i){var c;let a=new u.default.Popup({offset:(c=r.offset)!=null?c:[0,0],anchor:r.anchor,closeButton:r.closeButton,closeOnClick:r.closeOnClick,closeOnMove:r.closeOnMove,focusAfterOpen:r.focusAfterOpen,className:r.className,maxWidth:r.maxWidth}),n=r.html,l=this.evalValue("return `"+n+"`",e,i);a.setHTML(l).setLngLat(t).addTo(i),this.popups=this.popups||[],this.popups.push(a)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createPopup(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createPopup(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.popups)i.getElement().style.display=r?"none":""}removeLayer(t,e){if(!!this.popups){for(let r of this.popups)r.remove();this.popups=[],super.removeLayer(t,e)}}}class qt extends x{constructor(){super();L(this,"animateLine")}async addLayer(t,e){var n;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=await this.createAnimateImages(t,e),a={...e};delete a.layerId,delete a.sourceId,this.animateLine=u.default.createAnimateLineLayer(t,r,{animateImages:i,speed:(n=e.speed)!=null?n:1,...a})}getLayerId(){return this.animateLine.layerId}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.animateLine.stopAnimation(),this.animateLine.polyline.hide()):(this.animateLine.polyline.show(),this.animateLine.startAnimation())}removeLayer(t,e){this.animateLine.remove(),super.removeLayer(t,e)}}class Xt extends x{constructor(){super();L(this,"animateSymbol")}async addLayer(t,e){var n;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=await this.createAnimateImages(t,e),a={...e};delete a.layerId,delete a.sourceId,this.animateSymbol=u.default.createAnimateSymbolLayer(t,r,{animateImages:i,speed:(n=e.speed)!=null?n:1,...a})}getLayerId(){return this.animateSymbol.layerId}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.animateSymbol.stopAnimation(),this.animateSymbol.symbol.hide()):(this.animateSymbol.symbol.show(),this.animateSymbol.startAnimation())}removeLayer(t,e){this.animateSymbol.remove(),super.removeLayer(t,e)}}class $t extends x{constructor(){super();L(this,"animateFill")}async addLayer(t,e){var n;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=await this.createAnimateImages(t,e),a={...e};delete a.layerId,delete a.sourceId,this.animateFill=u.default.createAnimateFillLayer(t,r,{animateImages:i,speed:(n=e.speed)!=null?n:1,...a})}getLayerId(){return this.animateFill.layerId}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.animateFill.stopAnimation(),this.animateFill.polygon.hide()):(this.animateFill.polygon.show(),this.animateFill.startAnimation())}removeLayer(t,e){this.animateFill.remove(),super.removeLayer(t,e)}}class er extends x{constructor(){super();L(this,"sourceId");L(this,"events");this.events=[]}async createCluster(t,e){var h,y,f,d,m;this.sourceId="cluster-points"+u.default.RandomID();let r=t.getSourceData(e.sourceId);t.addSource(this.sourceId,{type:"geojson",data:r,cluster:!0,clusterMaxZoom:(h=e.clusterMaxZoom)!=null?h:10,clusterRadius:(y=e.clusterRadius)!=null?y:60});let i=(f=e.outerColors)!=null?f:[[1e3,"rgba(253, 156, 115, 0.6)"],[100,"rgba(241, 211, 87, 0.6)"],[0,"rgba(181, 226, 140, 0.6)"]];i.forEach((g,A)=>{var b;t.addLayer({id:"point-outer-cluster-"+this.sourceId+A,type:"circle",source:this.sourceId,paint:{"circle-color":g[1],"circle-radius":(b=e.outerCircleRadius)!=null?b:20},filter:A===0?[">=","point_count",g[0]]:["all",[">=","point_count",g[0]],["<","point_count",i[A-1][0]]]})});let a=(d=e.innerColors)!=null?d:[[1e3,"rgba(241, 128, 23, 0.6)"],[100,"rgba(240, 194, 12, 0.6)"],[0,"rgba(110, 204, 57, 0.6)"]];a.forEach((g,A)=>{var b;t.addLayer({id:"point-inner-cluster-"+this.sourceId+A,type:"circle",source:this.sourceId,paint:{"circle-color":g[1],"circle-radius":(b=e.innerCircleRadius)!=null?b:15},filter:A===0?[">=","point_count",g[0]]:["all",[">=","point_count",g[0]],["<","point_count",a[A-1][0]]]})}),t.addLayer({id:"cluster-count"+this.sourceId,type:"symbol",source:this.sourceId,filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["simsun"],"text-size":(m=e.clusterTextSize)!=null?m:12}}),t.addLayer({...t.properties({...e}),id:"unclustered-point"+this.sourceId,type:"symbol",source:this.sourceId,filter:["!",["has","point_count"]]});for(let g=0;g<i.length;g++){let A="point-outer-cluster-"+this.sourceId+g;const b=v=>{var k;let w=t.queryRenderedFeatures(v.point,{layers:[A]}),D=w[0].properties.cluster_id;(k=t.getSource(this.sourceId))==null||k.getClusterExpansionZoom(D,(T,I)=>{T||t.easeTo({center:w[0].geometry.coordinates,zoom:I})})};t.on("click",A,b),this.events.push(["click",A,b]);const C=v=>{t.getCanvas().style.cursor="pointer"};t.on("mouseenter",A,C),this.events.push(["mouseenter",A,C]);const S=v=>{t.getCanvas().style.cursor=""};t.on("mouseleave",A,S),this.events.push(["mouseleave",A,S])}const n=g=>{var b;let A=g.features[0].geometry.coordinates.slice();if(g.features[0].properties.index,e.popupHtml){let C=new u.default.Popup({offset:(b=e.popupOffset)!=null?b:[0,0],anchor:e.popupAnchor,closeButton:e.closeButton,closeOnClick:e.closeOnClick,closeOnMove:e.closeOnMove,focusAfterOpen:e.focusAfterOpen,className:e.className,maxWidth:e.maxWidth});C.setLngLat(A);let S=e.popupHtml,v=this.evalValue("return `"+S+"`",g.features[0].properties,this.map);C.setHTML(v).addTo(t)}};t.on("click","unclustered-point"+this.sourceId,n),this.events.push(["click","unclustered-point"+this.sourceId,n]);const l=()=>{t.getCanvas().style.cursor="pointer"};t.on("mouseenter","unclustered-point"+this.sourceId,l),this.events.push(["mouseenter","unclustered-point"+this.sourceId,l]);const c=()=>{t.getCanvas().style.cursor=""};t.on("mouseleave","unclustered-point"+this.sourceId,c),this.events.push(["mouseleave","unclustered-point"+this.sourceId,c])}async addLayer(t,e){super.addLayer(t,e),this.createCluster(t,e)}setVisible(t,e,r){super.setVisible(t,e,r),r?t.hideSource(this.sourceId):t.showSource(this.sourceId)}removeLayer(t,e){if(this.events){for(let r of this.events)t.off(r[0],r[1],r[1]);this.events=[]}t.removeSourceEx(this.sourceId),super.removeLayer(t,e)}}class tr extends x{constructor(){super();L(this,"markerCluster");L(this,"popupInfo");this.popupInfo=null}getColor(t,e,r){t=t!=null?t:[[0,"#00FFFF","#00FFFF"],[5,"#F0F","#80FF00"],[10,"#00F","#FFFF00"],[1e3,"#FFF","#FF3D3D"]];for(let i=0;i<t.length;i++)if(e<=t[i][0])return r?t[i][1]:t[i][2];return t.length==0?"#00FFFF":r?t[t.length-1][1]:t[t.length-1][2]}async addLayer(t,e){var c,h,y,f;super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features,a=[];for(let d=0;d<i.length;d++){let m=i[d].geometry;if(m.type=="Point"&&a.push({point:t.fromLngLat(m.coordinates),properties:{...i[d].properties}}),e.isDrawLinePoint){let g=[];m.type=="LineString"?g=m.coordinates:m.type=="Polygon"&&(g=m.coordinates[0]);for(let A of g)a.push({point:t.fromLngLat(A),properties:{...i[d].properties}})}}const n=(d,m)=>{if(m.length<=1){let g={...e};g=this.evalValue(g,d.properties,this.map);let A=new u.default.Marker({...e,color:this.getColor(g.textColors,m.length)}).setLngLat(this.map.toLngLat(d.point));return g.popupHtml&&A.on("click",b=>{var v;this.popupInfo?this.popupInfo.remove():this.popupInfo=new u.default.Popup({offset:(v=g.popupOffset)!=null?v:[0,0],anchor:g.popupAnchor,closeButton:g.closeButton,closeOnClick:g.closeOnClick,closeOnMove:g.closeOnMove,focusAfterOpen:g.focusAfterOpen,className:g.className,maxWidth:g.maxWidth});let C=g.popupHtml,S=this.evalValue("return `"+C+"`",A.clusterMarkersData[0].properties,this.map);this.popupInfo.setHTML(S),this.popupInfo.setLngLat(A.getLngLat()).addTo(this.map)}),A}else{let g=new u.default.Text({text:m.length+"",anchor:"center",offset:[0,0],style:{"background-color":this.getColor(e.textColors,m.length),color:this.getColor(e.textColors,m.length,!0),...e.textStyle}});return g.setLngLat(this.map.toLngLat(d.point)).addTo(this.map),g.on("click",A=>{if(g.clusterMarkersData.length===1)return;let b=g.clusterMarkersData.map(v=>v.point),C=u.default.geoBounds();C.update(b);let S=this.map.toLngLat(C);this.map.fitBounds(S,{padding:40})}),g}},l=(d,m,g)=>{if(g instanceof u.default.Text)if(m.length>1)g.setText(m.length+"");else return g.remove(),n(d,m);else if(m.length>1)return g.remove(),n(d,m)};this.markerCluster=new u.default.MarkerCluster({data:a,createMarker:n,updateMarker:l,allowOverlap:(c=e.allowOverlap)!=null?c:!1,allowOverlapMaxZoom:(h=e.allowOverlapMaxZoom)!=null?h:4,markerWidth:(y=e.markerWidth)!=null?y:28,markerHeight:(f=e.markerHeight)!=null?f:40}),this.markerCluster.addTo(t)}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?this.markerCluster.hide():this.markerCluster.show()}removeLayer(t,e){this.markerCluster.remove(),this.popupInfo&&(this.popupInfo.remove(),this.popupInfo=null),super.removeLayer(t,e)}}class rr extends x{constructor(){super();L(this,"texts")}createText(t,e,r,i){var c;r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.Text({...r,text:n});if(this.setMarkerOptions(l,r),l.setLngLat(t).addTo(i),r.animationType&&l.setAnimation(r.animationType),r.popupHtml){let h=new u.default.Popup({offset:(c=r.popupOffset)!=null?c:[0,0],anchor:r.popupAnchor,closeButton:r.closeButton,closeOnClick:r.closeOnClick,closeOnMove:r.closeOnMove,focusAfterOpen:r.focusAfterOpen,className:r.className,maxWidth:r.maxWidth}),y=r.popupHtml,f=this.evalValue("return `"+y+"`",e,i);h.setHTML(f),l.setPopup(h)}this.texts=this.texts||[],this.texts.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createText(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createText(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.texts)r?i.hide():i.show()}removeLayer(t,e){if(!!this.texts){for(let r of this.texts)r.remove();this.texts=[],super.removeLayer(t,e)}}}class sr extends x{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.BreathingApertureMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class ir extends x{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.RotatingApertureMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class or extends x{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.HaloRingMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class ar extends x{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.DiffusedApertureMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class nr extends x{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.RotatingTextBorderMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class lr extends x{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.FluorescenceMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class ur extends x{constructor(){super();L(this,"polyline")}async addLayer(t,e){super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=[],a=r.features;for(let l=0;l<a.length;l++){let c=a[l].geometry;if(c.type!="LineString")continue;let h=c.coordinates;if(c.coordinates.length>2){const y=u.default.polylineToBezierCurve(t.fromLngLat(c.coordinates).map(f=>[f.x,f.y]));h=u.default.bezierCurveToPolyline(y),i.push({points:t.toLngLat(h),properties:c.properties})}else i.push({points:h,properties:c.properties})}let n={...e};delete n.layerId,delete n.sourceId,this.polyline=new u.default.Polyline({data:i,...n}),this.polyline.addTo(t,e.before)}getLayerId(){return this.polyline.layerId}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?this.polyline.hide():this.polyline.show()}removeLayer(t,e){this.polyline&&this.polyline.remove(),super.removeLayer(t,e)}}class cr extends x{constructor(){super();L(this,"fillExtrusion");L(this,"anim")}async addLayer(t,e){var l,c;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=[],a=r.features;for(let h=0;h<a.length;h++){let y=a[h].geometry,f=[];if(y.type=="LineString")f.push(y.coordinates);else if(y.type=="MultiLineString")f.push(...y.coordinates);else continue;if(e.isBreakLine){let d=[];for(let m of f){for(let g=0;g<m.length-1;g++)d.push([m[g],m[g+1]]);f=d}}for(const d of f){let m=t.fromLngLat(d),g=u.default.polylineMarginToPolygon(m,{offset:(l=e.offsetLine)!=null?l:10});i.push({points:t.toLngLat(g),properties:{...a[h].properties,path:g}})}}let n={...e};if(delete n.layerId,delete n.sourceId,this.fillExtrusion=new u.default.FillExtrusion({data:i,...n}),this.fillExtrusion.addTo(t,e.before),e.anmiDuration){const h=u.default.cloneDeep(this.fillExtrusion.getData());this.anim=u.default.createAnimation({from:0,to:1,repeatType:(c=e.anmiRepeatType)!=null?c:"reverse",repeat:e.anmiRepeat||1/0,duration:e.anmiDuration*1e3,ease:u.default.linear,onUpdate:y=>{var d;const f=this.fillExtrusion.getData();for(let m=0;m<f.features.length;m++){const g=y,A=h.features[m].properties,b=u.default.interpolatePointsByRatio(A.path,g);if(b.length>1){const C=u.default.polylineMarginToPolygon(b,{offset:(d=e.offsetLine)!=null?d:10}),S=u.default.createPolygonGeoJson(t.toLngLat(C));S.features[0]&&S.features[0].geometry&&(f.features[m].geometry.coordinates=S.features[0].geometry.coordinates)}}this.fillExtrusion.setData(f)}})}}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.fillExtrusion.hide(),this.anim&&this.anim.stop()):(this.fillExtrusion.show(),this.anim&&this.anim.start())}removeLayer(t,e){this.fillExtrusion&&this.fillExtrusion.remove(),this.anim&&(this.anim.stop(),this.anim=null),super.removeLayer(t,e)}}class dr extends x{constructor(){super();L(this,"polylineArrows")}async addLayer(t,e){super.addLayer(t,e),this.polylineArrows=this.polylineArrows||[];let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type!="LineString")continue;await t.onLoad(!0);let l=n.coordinates,c=this.evalValue(e,i[a].properties,t);delete c.layerId,delete c.sourceId;let h=new u.default.PolylineArrow({...c,path:l});h.addTo(t,e.before),this.polylineArrows.push(h)}}getLayerId(){return this.polylineArrows.map(t=>t.id)}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){if(super.setVisible(t,e,r),this.polylineArrows&&this.polylineArrows.length)for(let i of this.polylineArrows)r?i.hide():i.show()}removeLayer(t,e){if(this.polylineArrows&&this.polylineArrows.length){for(let r of this.polylineArrows)r.remove();this.polylineArrows=[]}super.removeLayer(t,e)}}class fr extends x{constructor(){super();L(this,"polylineArrows");L(this,"symbolSourcedIds");L(this,"anims")}async addLayer(t,e){super.addLayer(t,e),this.polylineArrows=this.polylineArrows||[],this.symbolSourcedIds=this.symbolSourcedIds||[],this.anims=this.anims||[];let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type!="LineString")continue;await t.onLoad(!0);let l=n.coordinates,c=this.evalValue(e,i[a].properties,t);delete c.layerId,delete c.sourceId;let h=new u.default.PolylineArrow({...c,path:l});h.addTo(t,e.before),this.polylineArrows.push(h);let y;if(e.iconImage){let m=Object.keys(e).filter(b=>b.indexOf("symbol")==0||b.indexOf("icon")==0||b.indexOf("text")==0),g={};for(let b of m)g[b]=e[b];let A=u.default.RandomID();y="path_animi_source_"+A,t.addGeoJSONSource(y),t.addSymbolLayer("path_animi_layer_"+A,y,{iconRotate:["get","bearing"],iconRotationAlignment:"map",iconAllowOverlap:!0,iconIgnorePlacement:!0,...g}),this.symbolSourcedIds.push(y)}let f=c.fps||10;const d=h.animate(100,f,!0,m=>{},(m,g)=>{if(m!==u.default.FrameAnimationStatus.Run||!y)return;const A=u.default.geoPoint(g.endPnt).angleTo(u.default.geoPoint(g.startPnt)),b=u.default.createPointGeoJson({point:g.endPnt,properties:{...i[a].properties,bearing:u.default.radToDeg(-A)}});t.setData(y,b)});this.anims.push(d)}}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){if(super.setVisible(t,e,r),this.anims&&this.anims.length)for(let i of this.anims)r?i.stop():i.start();if(this.polylineArrows&&this.polylineArrows.length){for(let i of this.polylineArrows)r?i.hide():i.show();for(let i of this.symbolSourcedIds)r?t.hideSource(i):t.showSource(i)}}removeLayer(t,e){if(this.anims&&this.anims.length){for(let r of this.anims)r.stop();this.anims=[]}if(this.polylineArrows&&this.polylineArrows.length){for(let r of this.polylineArrows)r.remove();this.polylineArrows=[]}if(this.symbolSourcedIds&&this.symbolSourcedIds.length){for(let r of this.symbolSourcedIds)t.removeSourceEx(r);this.symbolSourcedIds=[]}super.removeLayer(t,e)}}class hr extends x{constructor(){super();L(this,"line");L(this,"symbol");L(this,"anim")}async addLayer(t,e){var f;super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features,a=[],n=[];for(let d=0;d<i.length;d++){let m=i[d].geometry;if(m.type!="LineString")continue;let g=t.fromLngLat(m.coordinates);e.drawPath&&n.push({points:t.toLngLat(g),properties:{...i[d].properties}});const A=u.default.geoPoint(g[1]).angleTo(u.default.geoPoint(g[0]));a.push({point:t.toLngLat(g[0]),properties:{...i[d].properties,bearing:u.default.radToDeg(-A),path:g}})}if(n.length>0){let d=Object.keys(e).filter(g=>g.indexOf("line")==0),m={};for(let g of d)m[g]=e[g];this.line=new u.default.Polyline({data:n,...m}),this.line.addTo(t)}let l=Object.keys(e).filter(d=>d.indexOf("symbol")==0||d.indexOf("icon")==0||d.indexOf("text")==0),c={};for(let d of l)c[d]=e[d];this.symbol=new u.default.Symbol({data:a,iconAllowOverlap:!0,iconRotationAlignment:"map",...c,iconRotate:["get","bearing"]}),this.symbol.addTo(t,e.before);const h=u.default.cloneDeep(this.symbol.getData());let y=0;this.anim=u.default.createAnimation({from:0,to:1,repeatType:(f=e.anmiRepeatType)!=null?f:"reverse",repeat:e.anmiRepeat||1/0,duration:e.anmiDuration*1e3,ease:u.default.linear,onUpdate:d=>{let m=y>d;y=d;const g=this.symbol.getData();for(let A=0;A<g.features.length;A++){const b=d,C=h.features[A].properties,S=u.default.interpolatePointsByRatio(C.path,b);if(S.length>1){let v=S[S.length-2],w=S[S.length-1],D=0;m?D=u.default.geoPoint(v).angleTo(u.default.geoPoint(w)):D=u.default.geoPoint(w).angleTo(u.default.geoPoint(v)),g.features[A].properties.bearing=u.default.radToDeg(-D);const k=u.default.createPointGeoJson(t.toLngLat(w));k.features[0]&&k.features[0].geometry&&(g.features[A].geometry.coordinates=k.features[0].geometry.coordinates)}}this.symbol.setData(g)}})}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.anim.stop(),this.symbol.hide(),this.line&&this.line.hide()):(this.line&&this.line.show(),this.symbol.show(),this.anim.start())}removeLayer(t,e){this.anim.stop(),this.symbol.remove(),this.line&&this.line.remove(),super.removeLayer(t,e)}}class gr extends x{constructor(){super();L(this,"fillExtrusion");L(this,"anim")}async addLayer(t,e){var l;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=[],a=r.features;for(let c=0;c<a.length;c++){let h=a[c].geometry;h.type=="Polygon"&&i.push({points:h.coordinates,properties:{...h.properties}})}let n={...e};if(delete n.layerId,delete n.sourceId,this.fillExtrusion=new u.default.FillExtrusion({data:i,...n,fillExtrusionHeight:["get","height"]}),this.fillExtrusion.addTo(t,e.before),e.anmiDuration){const c=u.default.cloneDeep(this.fillExtrusion.getData()),h=y=>u.default.interpolate([0,1],[{height:0},{height:c.features[y].properties.height||5e5}]);this.anim=u.default.createAnimation({from:0,to:1,repeatType:(l=e.anmiRepeatType)!=null?l:"loop",repeat:e.anmiRepeat||1/0,duration:e.anmiDuration*1e3,onUpdate:y=>{const f=this.fillExtrusion.getData();for(let d=0;d<f.features.length;d++){const m=h(d)(y);f.features[d].properties.height=m.height}this.fillExtrusion.setData(f)}})}}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.fillExtrusion.hide(),this.anim&&this.anim.stop()):(this.fillExtrusion.show(),this.anim&&this.anim.start())}removeLayer(t,e){this.fillExtrusion&&this.fillExtrusion.remove(),this.anim&&(this.anim.stop(),this.anim=null),super.removeLayer(t,e)}}class yr extends x{constructor(){super();L(this,"sourceId")}async addLayer(t,e){super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i="geojson_source_"+u.default.RandomID();this.sourceId=i,t.addGeoJSONSource(i,r);let a=Object.keys(e).filter(f=>f.indexOf("fill")==0),n={};for(let f of a)n[f]=e[f];t.addFillLayer(i+"-layer-polygons",i,{source:i,...n,filter:["==",["geometry-type"],"Polygon"]});let l=Object.keys(e).filter(f=>f.indexOf("line")==0),c={};for(let f of l)c[f]=e[f];t.addLineLayer(i+"-layer-lines",i,{source:i,...c,filter:["==",["geometry-type"],"LineString"]});let h=Object.keys(e).filter(f=>f.indexOf("circle")==0),y={};for(let f of h)y[f]=e[f];t.addCircleLayer(i+"-layer-points",i,{source:i,...y,filter:["==",["geometry-type"],"Point"]})}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),this.sourceId&&(r?t.hideSource(this.sourceId):t.showSource(this.sourceId))}removeLayer(t,e){this.sourceId&&(t.removeSourceEx(this.sourceId),this.sourceId=void 0),super.removeLayer(t,e)}}class mr extends x{constructor(){super();L(this,"draw");L(this,"sourceID")}async addLayer(t,e){super.addLayer(t,e),this.sourceID=e.sourceId;let r=t.getSourceData(e.sourceId);e.entColorToHtmlColor&&r&&r.features&&r.features.forEach(a=>{a.properties&&typeof a.properties.color=="number"&&(a.properties.color=t.entColorToHtmlColor(a.properties.color))});const i=u.default.cloneDeep(u.default.Draw.defaultOptions());i.isActionDrawMode=!0,this.draw=new u.default.Draw.Tool(i),t.addControl(this.draw,"top-right"),this.draw.set(r)}setVisible(t,e,r){if(super.setVisible(t,e,r),!!this.draw)if(r)this.draw.set({type:"FeatureCollection",features:[]});else{let i=t.getSourceData(this.sourceID);this.draw.set(i)}}removeLayer(t,e){this.draw&&(this.map.removeControl(this.draw),this.draw=null),super.removeLayer(t,e)}}class pr extends x{constructor(){super()}async addLayer(s,t){super.addLayer(s,t),s.addRasterLayer(t.layerId,t.sourceId,t,t.before)}setVisible(s,t,e){super.setVisible(s,t,e),e?s.hide(t):s.show(t)}removeLayer(s,t){s.removeLayerEx(t),super.removeLayer(s,t)}}class Ar extends x{constructor(){super();L(this,"layers")}async addLayer(t,e){super.addLayer(t,e);const r=t.getService().vectorStyle();this.layers=r.layers;for(let i of this.layers)i.source=e.sourceId,i.id=i.id.replace("vector-",e.layerId+"-"),t.addLayer(i)}setVisible(t,e,r){if(super.setVisible(t,e,r),r)for(let i of this.layers)t.hide(i.id);else for(let i of this.layers)t.show(i.id)}removeLayer(t,e){for(let r of this.layers)t.removeLayerEx(r.id);super.removeLayer(t,e)}}class wr extends x{constructor(){super();L(this,"overlay")}createDivOverlay(t,e,r){let i=this.evalValue(e,t,r);if(!!i.bounds&&!!i.width&&!!i.height){if(Array.isArray(i.bounds)&&i.bounds.length==2&&(i.bounds=new u.default.GeoBounds(u.default.geoPoint(i.bounds[0]),u.default.geoPoint(i.bounds[1]))),i.customHtml){let a=this.evalValue(e.customHtml,t,r);i.element=a}else if(i.customImage){i.customImage.toLowerCase().indexOf("<svg")==0&&(i.customImage="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(e.customImage))));const a=document.createElement("img");a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.width=i.width+"px",a.style.height=i.height+"px",a.src=i.customImage,a.style.pointerEvents="none",i.element=a}!i.element||(this.overlay=new u.default.DivOverlay(i),this.overlay.addTo(r))}}async addLayer(t,e){super.addLayer(t,e),this.createDivOverlay({},e,t)}setVisible(t,e,r){super.setVisible(t,e,r),this.overlay&&this.overlay.setVisible(!r)}removeLayer(t,e){this.overlay&&this.overlay.remove(),super.removeLayer(t,e)}}class br extends x{constructor(){super();L(this,"overlay")}async addLayer(t,e){super.addLayer(t,e),this.overlay=new u.default.SvgOverlay(e),this.overlay.addTo(t)}setVisible(t,e,r){super.setVisible(t,e,r),this.overlay&&this.overlay.divOverlay&&this.overlay.divOverlay.setVisible(!r)}removeLayer(t,e){this.overlay&&this.overlay.remove(),super.removeLayer(t,e)}}class Lr extends x{constructor(){super();L(this,"background")}async addLayer(t,e){super.addLayer(t,e),this.background=new u.default.BackgroundLayer(e),this.background.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.background.hide():this.background.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}}class vr extends x{constructor(){super();L(this,"sky")}async addLayer(t,e){super.addLayer(t,e),this.sky=new u.default.SkyLayer(e),this.sky.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.sky.hide():this.sky.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}}const De={line:Wt,fill:Ut,symbol:_t,marker:Yt,popup:Qt,circle:Zt,fillExtrusion:Kt,heatmap:Jt,animateLine:qt,animateSymbol:Xt,animateFill:$t,symbolCluster:er,markerCluster:tr,text:rr,breathingMarker:sr,rotatingMarker:ir,haloRingMarker:or,diffusedMarker:ar,textBorderMarker:nr,fluorescenceMarker:lr,curve:ur,lineExtrusions:cr,arrowLine:dr,pathAnimate:fr,symbolPathAnimate:hr,fillExtrusionsAnimate:gr,geojson:yr,draw:mr,raster:pr,vector:Ar,divOverlay:wr,svgOverlay:br,background:Lr,sky:vr},O=class{constructor({dbName:s,version:t,tables:e}){L(this,"dbName","");L(this,"version",1);L(this,"tableList",[]);L(this,"db",null);L(this,"queue",[]);this.dbName=s,this.version=t,this.tableList=e}static getInstance(s){var e,r;O._instance=(e=O._instance)!=null?e:{};const t=(r=s==null?void 0:s.dbName)!=null?r:"";return O._instance[t]||(O._instance[t]=new O(s)),O._instance[t]}queryAll({tableName:s}){const t=[];return this.commitDb(s,e=>e.openCursor(),"readonly",(e,r)=>{this.cursor_success(e,{condition:()=>!0,handler:({currentValue:i})=>t.push(i),success:()=>r(t)})})}query({tableName:s,condition:t}){const e=[];return this.commitDb(s,r=>r.openCursor(),"readonly",(r,i)=>{this.cursor_success(r,{condition:t,handler:({currentValue:a})=>e.push(a),success:()=>i(e)})})}query_by_keyValue({tableName:s,key:t,value:e}){return this.commitDb(s,r=>r.index(t).get(e),"readonly",(r,i)=>{i(r.target.result||null)})}query_by_primaryKey({tableName:s,value:t}){return this.commitDb(s,e=>e.get(t),"readonly",(e,r)=>{r(e.target.result||null)})}update({tableName:s,condition:t,handle:e}){const r=[];return this.commitDb(s,i=>i.openCursor(),"readwrite",(i,a)=>{this.cursor_success(i,{condition:t,handler:({currentValue:n,cursor:l})=>{const c=e(n);r.push(c),l.update(c)},success:()=>{a(r)}})})}update_by_primaryKey({tableName:s,value:t,handle:e}){return this.commitDb(s,r=>r.get(t),"readwrite",(r,i,a)=>{const n=r.target.result;if(!n){i(null);return}const l=e(n);a.put(l),i(l)})}insert({tableName:s,data:t}){return this.commitDb(s,void 0,"readwrite",(e,r,i)=>{t instanceof Array?t.forEach(a=>i.put(a)):i.put(t),r()})}delete({tableName:s,condition:t}){const e=[];return this.commitDb(s,r=>r.openCursor(),"readwrite",(r,i)=>{this.cursor_success(r,{condition:t,handler:({currentValue:a,cursor:n})=>{e.push(a),n.delete()},success:()=>{i(e)}})})}delete_by_primaryKey({tableName:s,value:t}){return this.commitDb(s,e=>e.delete(t),"readwrite",(e,r)=>{r()})}open_db(){return new Promise((s,t)=>{const e=window.indexedDB.open(this.dbName,this.version);e.onerror=r=>{t(r)},e.onsuccess=r=>{this.db=r.target.result;let i;for(;i=this.queue.pop();)i();s(this)},e.onupgradeneeded=r=>{this.tableList.forEach(i=>{this.create_table(r.target.result,i)})}})}close_db(){return new Promise((s,t)=>{try{if(!this.db){s("\u8BF7\u5F00\u542F\u6570\u636E\u5E93");return}this.db.close(),this.db=null,O._instance&&delete O._instance[this.dbName],s(!0)}catch(e){t(e)}})}delete_db(s){return new Promise((t,e)=>{const r=indexedDB.deleteDatabase(s);r.onerror=i=>{e(i)},r.onsuccess=i=>{t(i)}})}delete_table(s){return this.commitDb(s,t=>t.clear(),"readwrite",(t,e)=>{e()})}create_table(s,{tableName:t,option:e,indexs:r=[]}){if(!s.objectStoreNames.contains(t)){const i=s.createObjectStore(t,e);for(const{key:a,option:n}of r)i.createIndex(a,a,n)}}commitDb(s,t,e="readwrite",r){return new Promise((i,a)=>{const n=()=>{try{if(this.db){const l=this.db.transaction(s,e).objectStore(s);if(!t){r(null,i,l);return}const c=t(l);c.onsuccess=h=>{r?r(h,i,l):i(h)},c.onerror=h=>{a(h)}}else a(new Error("\u8BF7\u5F00\u542F\u6570\u636E\u5E93"))}catch(l){a(l)}};this.db?n():this.queue.push(n)})}cursor_success(s,{condition:t,handler:e,success:r}){const i=s.target.result;if(i){const a=i.value;t(a)&&e({cursor:i,currentValue:a}),i.continue()}else r()}};let W=O;L(W,"_instance",null);const Ce=({dbName:o,version:s=1,tables:t=[]})=>W.getInstance({dbName:o,version:s,tables:t}).open_db(),Se=o=>W.getInstance({dbName:o,version:1,tables:[]});class ke{constructor(){L(this,"dbName");L(this,"tableName");L(this,"isInitDb");this.dbName="vjmapCache",this.tableName="cache",this.isInitDb=!1}async init(){this.isInitDb||(await Ce({dbName:this.dbName,version:1,tables:[{tableName:this.tableName,option:{keyPath:"id",autoIncrement:!0},indexs:[{key:"id",option:{unique:!0}},{key:"key"},{key:"value"}]}]}),this.isInitDb=!0)}getInst(){return Se(this.dbName)}async getAll(){return await this.init(),await this.getInst().queryAll({tableName:this.tableName})}async getRecordByKey(s){return await this.init(),await this.getInst().query({tableName:this.tableName,condition:t=>t.key===s})}async getValueByKey(s,t){const e=await this.getRecordByKey(s);if(e.length!=0)return t===!0?JSON.parse(e[0].value):e[0].value}async setValueByKey(s,t,e){return await this.upsert({key:s,value:e===!0?JSON.stringify(t,null,0):t})}async upsert(s){return await this.init(),(await this.getRecordByKey(s.key)).length==0?await this.getInst().insert({tableName:this.tableName,data:s}):await this.getInst().update({tableName:this.tableName,condition:e=>e.key===s.key,handle:e=>(e.value=s.value,e)})}async deleteRecord(s){return await this.init(),await this.getInst().delete({tableName:this.tableName,condition:t=>t.key===s})}async deleteTable(){return await this.init(),await this.getInst().delete_table(this.tableName)}async deleteDb(){return await this.init(),await this.getInst().delete_db(this.dbName)}toStringKey(s,t){return t=t!=null?t:"",t+JSON.stringify(s,null,0)}}const Q=new ke;async function X(o,s,t){var y,f,d,m;let e=o.getService();const r={mapId:(y=e.currentMapParam())==null?void 0:y.mapid,version:(f=e.currentMapParam())==null?void 0:f.version,workspace:e.getCurWorkspaceName(),layername:(d=e.currentMapParam())==null?void 0:d.layer,...s,...t};if(s.disableCacheData===!0){let g=await Q.getValueByKey(Q.toStringKey(r,"query_"),!0);if(g)return g}let i;const a=[];let n=0;const l=5e4;let c;for(s.bounds&&(c=u.default.GeoBounds.fromString(s.bounds).toArray());;){const g=await e.conditionQueryFeature({condition:(m=s.condition)!=null?m:"",bounds:c,fields:"",includegeom:!0,realgeom:!0,isContains:s.isContains,beginpos:n,limit:l,...s});if(!g.result||(n+=l,a.push(...g.result||[]),a.length>=g.recordCount))break}i={result:a,recordCount:a.length};let h=le(o,i,s.coordType==1);return s.disableCacheData===!0&&await Q.setValueByKey(Q.toStringKey(r,"query_"),h,!0),h}const N=o=>{const s=new Set(["id","isEnvelop","envelop","geojson","geom","isPoint","isline","points"]),t={};for(const e in o)s.has(e)||(t[e]=o[e]);return t};function le(o,s,t){const e={features:[],type:"FeatureCollection"};if(s&&s.result&&s.result.length>0)for(const i of s.result)if(t){if(i.geom&&i.geom.geometries){let a={id:i.id,type:"Feature",properties:N(i)};i.geom.geometries.length==1?a={...a,geometry:i.geom.geometries[0]}:a={...a,geometry:{geometries:i.geom.geometries,type:"GeometryCollection"}},e.features.push(a)}}else{const a=i.points||i.positon||i.location||i.origin||i.center;if(a){const n=a.split(";"),l=[];for(let c of n)c.indexOf(",")>0&&l.push(o.toLngLat(u.default.GeoPoint.fromString(c)));if(l.length==1){const c={type:"Feature",id:i.id,properties:N(i),geometry:{type:"Point",coordinates:l[0]}};e.features.push(c)}else if(l.length>1){const c={type:"Feature",id:i.id,properties:N(i),geometry:{type:"LineString",coordinates:l}};e.features.push(c)}}}return o.fromLngLat(e)}async function U(o,s,t){let e;if(s.reqType=="SOURCE")s.fromSourceId&&(e=await t.getSourceData(s.fromSourceId));else{s.data&&typeof s.data=="string"&&(s.data=JSON.parse(s.data)),s.header&&typeof s.header=="string"&&(s.header=JSON.parse(s.header));let r={headers:{Accept:"application/json","Content-Type":"application/json",...s.header}};s.url&&(s.reqType=="POST"?e=await u.default.httpHelper.post(s.url,s.data,r):e=await u.default.httpHelper.get(s.url,s.data,r))}return s.processJS&&(e=await xe(e,s.processJS,o,t)),e}const ue=o=>{let s={type:"FeatureCollection",features:[]};for(let t=0;t<o.length;t++){let e=o[t];Array.isArray(e)&&e.length==2&&typeof e[0]=="number"?s.features.push({type:"Feature",id:t+1,properties:{index:t+1},geometry:{type:"Point",coordinates:e}}):Array.isArray(e)&&Array.isArray(e[0])&&typeof e[0][0]=="number"?s.features.push({type:"Feature",id:t+1,properties:{index:t+1},geometry:{type:"LineString",coordinates:o[t]}}):Array.isArray(e)&&Array.isArray(e[0])&&Array.isArray(e[0][0])&&typeof e[0][0][0]=="number"&&s.features.push({type:"Feature",id:t+1,properties:{index:t+1},geometry:{type:"Polygon",coordinates:o[t]}})}return s};async function xe(o,s,t,e){Array.isArray(o)&&(o=ue(o));const r=Object.getPrototypeOf(async function(){}).constructor,i=new r("data","vjmap","map","mapApp","utils",s),a={ProcessDataToFeatureCollection:le,convertArrayToGeoJson:ue};return await i(o,u.default,t,e,a)}const $e={scatterDot:(o,s={})=>{var r;const t=(r=s.size)!=null?r:100;return{width:t,height:t,data:new Uint8Array(t*t*4),onAdd:function(){let i=document.createElement("canvas");i.width=this.width,i.height=this.height,this.context=i.getContext("2d")},render:function(){var y,f;const i=(y=s.duration)!=null?y:1500,a=(f=s.rgb)!=null?f:[0,150,0];let n=performance.now()%i/i,l=t/2*.3,c=t/2*.7*n+l,h=this.context;return h.clearRect(0,0,this.width,this.height),h.beginPath(),h.arc(this.width/2,this.height/2,c,0,Math.PI*2),h.fillStyle="rgba("+a[0]+","+a[1]+","+a[2]+","+(1-n)+" )",h.fill(),h.beginPath(),h.arc(this.width/2,this.height/2,l,0,Math.PI*2),this.data=h.getImageData(0,0,this.width,this.height).data,o.triggerRepaint(),!0}}},pulsingDot:(o,s={})=>{var r;const t=(r=s.size)!=null?r:100;return{width:t,height:t,data:new Uint8Array(t*t*4),onAdd:function(){const i=document.createElement("canvas");i.width=this.width,i.height=this.height,this.context=i.getContext("2d")},render:function(){var f,d,m,g,A,b,C;const i=(f=s.duration)!=null?f:1e3,a=performance.now()%i/i,n=(d=s.outFillRgb)!=null?d:[255,200,200],l=(m=s.innerFillRgb)!=null?m:[255,100,100],c=t/2*((g=s.innerRadiusRatio)!=null?g:.3),h=t/2*((A=s.outerRadiusRatio)!=null?A:.7)*a+c,y=this.context;return y.clearRect(0,0,this.width,this.height),y.beginPath(),y.arc(this.width/2,this.height/2,h,0,Math.PI*2),y.fillStyle="rgba("+n[0]+","+n[1]+","+n[2]+","+(1-a)+" )",y.fill(),y.beginPath(),y.arc(this.width/2,this.height/2,c,0,Math.PI*2),y.fillStyle="rgba("+l[0]+","+l[1]+","+l[2]+",1)",y.strokeStyle=(b=s.innerStrokeStyle)!=null?b:"white",y.lineWidth=2+((C=s.innerLineWidth)!=null?C:4)*(1-a),y.fill(),y.stroke(),this.data=y.getImageData(0,0,this.width,this.height).data,o.triggerRepaint(),!0}}}},et=()=>["https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"],Ie=o=>{const s=["85c9d12d5d691d168ba5cb6ecaa749eb","583e63953a6ed6bf304e68120db4c512","93d1fdef41f93d2211deed6d22780c48","7e2ced6843b376a14f69a9f5885d3d2d","44964a97c8c44e4d04efdf3cba594467","57f1b8146ef867f14189f3f4bb1adc1c"],t=s[u.default.randInt(0,s.length-1)];return[o?"https://t{0-7}.tianditu.gov.cn/DataServer?T=img_w&X={x}&Y={y}&L={z}&tk="+t:"https://t{0-7}.tianditu.gov.cn/DataServer?T=vec_w&X={x}&Y={y}&L={z}&tk="+t,"https://t{0-7}.tianditu.gov.cn/DataServer?T=cva_w&X={x}&Y={y}&L={z}&tk="+t]},Te=o=>o?["https://webst0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}","https://webst0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"]:["https://webrd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"],Fe=(o,s)=>{let t=s.webMapTiles;if(t||(s.baseMapType=="WGS84"?t=Ie():s.baseMapType=="GCJ02"&&(t=Te())),!!t)for(let e=0;e<t.length;e++){const r=`${s.baseMapType}_base_webmap_source_${e}`;o.addRasterSource(r,{type:"raster",tiles:ae(t[e],o)});const i=`${s.baseMapType}_base_webmap_layer_${e}`;o.addRasterLayer(i,r,{})}},Dr={"FullscreenControl.Enter":"\u8FDB\u5165\u5168\u5C4F","FullscreenControl.Exit":"\u9000\u51FA\u5168\u5C4F","NavigationControl.ZoomIn":"\u653E\u5927","NavigationControl.ZoomOut":"\u7F29\u5C0F","NavigationControl.ResetBearing":"\u65B9\u4F4D\u89D2\u590D\u4F4D","ScaleControl.Meters":"","ScaleControl.Kilometers":"K"};var Ee=(o=>(o.None="none",o.Direct="direct",o.Auto="auto",o.Param="param",o))(Ee||{});const $=async(o,s,t,e)=>{if(Array.isArray(t)){for await(let r of t)if(!r.layer){r.style||(r.style={backcolor:e!=null?e:0});let i=await o.createStyle(r.style,r.mapid,r.version);r.layer=i.stylename}}else if(!t.layer){t.style||(t.style={backcolor:e!=null?e:0});let r=await o.createStyle(t.style,t.mapid,t.version);t.layer=r.stylename}return t},Pe=async(o,s,t,e)=>{let r;const i=async a=>{var c,h,y,f,d;if(!a.mapid)return;let n=await o.metadata(a.mapid,a.version),l=u.default.GeoBounds.fromString(n.bounds);if(s=="auto")if(R(t)){let m=a.fourParameterX!==void 0?[(c=a.fourParameterX)!=null?c:0,(h=a.fourParameterY)!=null?h:0,(y=a.fourParameterScale)!=null?y:1,(f=a.fourParameterRotate)!=null?f:0].join(","):void 0,g=l.toPointArray(),A=new u.default.GeoBounds;for await(let b of g){let C=await Ne(o,u.default.geoPoint(b),(d=a.crs)!=null?d:"",m,t=="WGS84");A.update([u.default.geoPoint(C)])}return A}else return;else if(s=="param"){if(R(a.baseMapType))return;let m=l.toPointArray(),g;for(let A of m)if(a.coordinates){let b=Ge(u.default.geoPoint(A),a.coordinates,a.isSetRotateZero,R(t));g||(g=new u.default.GeoBounds),g.update([u.default.geoPoint(b)])}return g}return l};if(Array.isArray(e))for await(let a of e){let n=await i(a);if(!n)return;r||(r=new u.default.GeoBounds),r.updateByBounds(n)}else{let a=await i(e);if(!a)return;r||(r=new u.default.GeoBounds),r.updateByBounds(a)}return r},Me=(o,s,t)=>{const e=r=>{var i,a,n,l,c,h;if(o=="param"){if(!r.coordinates||r.coordinates.length<=1)return;if(R(s.baseMapType)){let y=r.coordinates.map(m=>u.default.geoPoint(u.default.Projection.lngLat2Mercator([m.x1,m.y1]))),f=r.coordinates.map(m=>u.default.geoPoint([m.x2,m.y2])),d=u.default.coordTransfromGetFourParamter(y,f,(i=r.isSetRotateZero)!=null?i:!1,!0);return[d.dx,d.dy,d.scale,d.rotate]}else{let y=r.coordinates.map(m=>u.default.geoPoint([m.x1,m.y1])),f=r.coordinates.map(m=>u.default.geoPoint([m.x2,m.y2])),d=u.default.coordTransfromGetFourParamter(y,f,(a=r.isSetRotateZero)!=null?a:!1,!0);return[d.dx,d.dy,d.scale,d.rotate]}}else return r.fourParameterX!==void 0?[(n=r.fourParameterX)!=null?n:0,(l=r.fourParameterY)!=null?l:0,(c=r.fourParameterScale)!=null?c:1,(h=r.fourParameterRotate)!=null?h:0]:void 0};if(Array.isArray(t)){if(t.length==1)return{mapid:t[0].mapid,version:t[0].version,layers:t[0].layer,crs:t[0].crs,fourParameter:e(t[0])};{let r=[],i=[],a=[],n=[],l=[];for(let c=0;c<t.length;c++)r.push(t[c].mapid),i.push(t[c].version),a.push(t[c].layer),n.push(t[c].crs),l.push(e(t[c]));return{mapid:r,version:i,layers:a,crs:n,fourParameter:l}}}else return{mapid:t.mapid,version:t.version,layers:t.layer,crs:t.crs,fourParameter:e(t)}},Be=async(o,s,t,e,r)=>(await $(o,s,e),o.wmsTileUrl({...Me(s,t,e),mapbounds:t.mapbounds,...r})),Oe=async(o,s,t,e,r)=>{await $(o,s,e);const i=u.default.cloneDeep(Me(s,t,e));if(i.fourParameter)if(Array.isArray(i.mapid))for(let a=0;a<i.fourParameter.length;a++)typeof i.fourParameter[a][0]=="number"&&(i.fourParameter[a][0]=-i.fourParameter[a][0]),typeof i.fourParameter[a][1]=="number"&&(i.fourParameter[a][1]=-i.fourParameter[a][1]),i.fourParameter[a][0]=i.fourParameter[a][0]||0,i.fourParameter[a][1]=i.fourParameter[a][1]||0,i.fourParameter[a][2]=i.fourParameter[a][2]||1,i.fourParameter[a][3]=i.fourParameter[a][3]||0;else typeof i.fourParameter[0]=="number"&&(i.fourParameter[0]=-i.fourParameter[0]),typeof i.fourParameter[1]=="number"&&(i.fourParameter[1]=-i.fourParameter[1]),i.fourParameter[0]=i.fourParameter[0]||0,i.fourParameter[1]=i.fourParameter[1]||0,i.fourParameter[2]=i.fourParameter[2]||1,i.fourParameter[3]=i.fourParameter[3]||0;return o.wmsTileUrl({...i,srs:"EPSG:3857",webMapType:t.baseMapType,...r})},Re=async(o,s,t,e)=>{var a,n,l,c,h,y;let r;if(Array.isArray(t)?r=t.find(f=>R(f.baseMapType)):r=t,!r)return;const i=((a=r.webMapTiles)==null?void 0:a.map(f=>ve(f)))||[];return o.webMapUrl({tileCrs:r.baseMapType=="GCJ02"?"gcj02":"wgs84",tileUrl:(n=i==null?void 0:i.map(f=>f.tileUrl))!=null?n:"",tileSize:256,tileRetina:1,tileMaxZoom:18,tileShards:i.length>=0?i[0].tileShards:"",tileToken:"",tileFlipY:!1,mapbounds:s.mapbounds,srs:r.crs,fourParameterBefore:r.fourParameterX!==void 0?[(l=r.fourParameterX)!=null?l:0,(c=r.fourParameterY)!=null?c:0,(h=r.fourParameterScale)!=null?h:1,(y=r.fourParameterRotate)!=null?y:0].join(","):void 0})},Ve=async(o,s,t,e,r)=>{await $(o,s,e);let i;return R(t.baseMapType)||(i=t.mapbounds,i&&(i=i.replace("[",""),i=i.replace("]",""))),o.wmsTileUrl({...Me(s,t,e),mapbounds:i,...r})},je=async(o,s,t,e)=>{let r;if(t=="direct"?r=await Be(o,t,s,e.maps,e.layerProps):t=="auto"?R(s.baseMapType)?r=await Oe(o,t,s,e.maps,e.layerProps):r=await Re(o,s,e.maps,e.layerProps):t=="param"&&(r=await Ve(o,t,s,e.maps,e.layerProps)),!!r)return[r]},Ne=async(o,s,t,e,r)=>{if(e){let n=e.split(",");s=u.default.coordTransfromByFourParamter(s,{dx:+n[0],dy:+n[1],scale:+n[2],rotate:+n[3]})}let a=(await o.cmdTransform(t,"EPSG:4326",s))[0];return r===!1&&(a=u.default.transform.convert(a,u.default.transform.CRSTypes.EPSG4326,u.default.transform.CRSTypes.AMap)),a},tt=async(o,s,t,e,r)=>{r===!1&&(s=u.default.transform.convert(s,u.default.transform.CRSTypes.AMap,u.default.transform.CRSTypes.EPSG4326));let a=(await o.cmdTransform("EPSG:4326",t,u.default.geoPoint(s)))[0];if(e){let n=e.split(",");a=u.default.coordTransfromByFourParamter(u.default.geoPoint(a),{dx:+n[0],dy:+n[1],scale:+n[2],rotate:+n[3]})}return u.default.geoPoint(a).toArray()},Ge=(o,s,t,e)=>{let r;e?r=s.map(l=>u.default.geoPoint(u.default.Projection.lngLat2Mercator([l.x1,l.y1]))):r=s.map(l=>u.default.geoPoint([l.x1,l.y1]));let i=s.map(l=>u.default.geoPoint([l.x2,l.y2]));if(r.length==0||i.length==0)return u.default.geoPoint(o);let a=u.default.coordTransfromGetFourParamter(i,r,t!=null?t:!1,!0),n=u.default.coordTransfromByFourParamter(o,a);return e&&(n=u.default.geoPoint(u.default.Projection.mercator2LngLat(n))),n},rt=(o,s,t,e)=>{let r;e?r=s.map(n=>u.default.geoPoint(u.default.Projection.lngLat2Mercator([n.x1,n.y1]))):r=s.map(n=>u.default.geoPoint([n.x1,n.y1]));let i=s.map(n=>u.default.geoPoint([n.x2,n.y2]));if(r.length==0||i.length==0)return u.default.geoPoint(o);let a=u.default.coordTransfromGetFourParamter(r,i,t!=null?t:!1,!0);return e&&(o=u.default.geoPoint(u.default.Projection.lngLat2Mercator(o))),u.default.coordTransfromByFourParamter(o,a)},st=o=>{let s=[],t=0,e=0;o=="BEIJING54_3"?(t=2401,e=2442):o=="BEIJING54_6"?(t=21413,e=21483):o=="XIAN80_3"?(t=2327,e=2348):o=="XIAN80_6"?(t=2349,e=2390):o=="CGCS2000_3"?(t=4513,e=4554):o=="CGCS2000_6"&&(t=4491,e=4512);for(let r=t;r<=e;r++)s.push(`EPSG:${r}`);return s},ce=()=>{let o;const s=l=>{o=l};document.addEventListener("keydown",s);const t=l=>{o=void 0};return document.addEventListener("keyup",t),{removeEventListener:()=>{document.removeEventListener("keydown",s),document.removeEventListener("keyup",t)},isAltKey:()=>o==null?void 0:o.altKey,isCtrlKey:()=>o==null?void 0:o.ctrlKey,isShiftKey:()=>o==null?void 0:o.shiftKey,curKey:()=>o}};class it{constructor(s){L(this,"config");L(this,"svc");L(this,"map");L(this,"sources");L(this,"layers");L(this,"controls");L(this,"layersInst");L(this,"projectKey");L(this,"containerId");L(this,"timeMgr");L(this,"isEditorMode");L(this,"isDisableRunProgram");L(this,"context");L(this,"programCleaner");L(this,"oldCacheImages");L(this,"keyEvent");this.config=s||{},this.sources=[],this.layers=[],this.layersInst={},this.timeMgr={},this.config.mapSources=[],this.config.mapLayers=[]}mount(s,t){var a,n,l,c,h,y,f;if(this.svc)return;if(this.keyEvent||(this.keyEvent=ce()),this.containerId=s,(a=this.config)!=null&&a.backgroundColor){const d=document.getElementById(s);d&&(d.style.backgroundColor=(n=this.config)==null?void 0:n.backgroundColor)}this.svc=new u.default.Service((c=(l=this.config.serviceUrl)!=null?l:t==null?void 0:t.serviceUrl)!=null?c:"",(y=(h=this.config.serviceToken)!=null?h:t==null?void 0:t.serviceToken)!=null?y:""),this.config.workspace&&this.svc.switchWorkspace(this.config.workspace),this.config.accessKey&&this.config.accessKey.split(";").map(d=>this.svc.addAccessKey(d));const e=(f=this.config.mapInitBounds)!=null?f:"[-10000,-10000,10000,10000]",r=u.default.GeoBounds.fromString(e),i=new u.default.GeoProjection(r);this.map=new u.default.Map({container:s,style:{version:this.svc.styleVersion(),glyphs:this.svc.glyphsUrl(),sources:{},layers:[]},center:i.toLngLat(r.center()),zoom:2,renderWorldCopies:!1,preserveDrawingBuffer:this.isEditorMode?!0:void 0,doubleClickZoom:!1,locale:Dr,...this.config.mapOptions}),this.map.attach(this.svc,i)}attachMap(s){this.map=s,this.svc=this.map.getService(),this.keyEvent||(this.keyEvent=ce())}isWebBaseMap(s){var e;let t=(e=s!=null?s:this.config)!=null?e:{};return!(t.baseMapType==""||t.baseMapType=="CAD"||t.baseMapType===void 0)}async setConfig(s,t){var n,l,c,h,y,f,d,m,g,A,b,C,S,v;if(s||(s=u.default.cloneDeep(this.config)),!this.map)return;if(await this.map.onLoad(),this.clearData(),s&&(this.config=s),(n=this.config)!=null&&n.backgroundColor){const w=this.map.getContainer();w&&(w.style.backgroundColor=(l=this.config)==null?void 0:l.backgroundColor)}const e=[...(c=s==null?void 0:s.mapSources)!=null?c:[]],r=[...(h=s==null?void 0:s.mapLayers)!=null?h:[]];if(this.svc=new u.default.Service((d=(f=this.config.serviceUrl)!=null?f:(y=this.svc)==null?void 0:y.serverUrl)!=null?d:"",(A=(g=this.config.serviceToken)!=null?g:(m=this.svc)==null?void 0:m.accessToken)!=null?A:""),this.isWebBaseMap()){let w=new u.default.LnglatProjection;this.map.attach(this.svc,w),Fe(this.map,this.config)}else{if(!((b=this.config.mapOpenOptions)!=null&&b.mapid)&&this.config.mapInitBounds){const w=this.config.mapInitBounds,D=u.default.GeoBounds.fromString(w),k=new u.default.GeoProjection(D);this.map.setMapProjection(k)}this.map.attach(this.svc,this.map.getMapProjection())}if(this.config.workspace&&this.svc.switchWorkspace(this.config.workspace),this.config.accessKey&&this.config.accessKey.split(";").map(w=>this.svc.addAccessKey(w)),!this.isWebBaseMap()&&(this.config.mapOpenOptions=this.config.mapOpenOptions||{},(C=this.config.mapOpenOptions)!=null&&C.style||(this.config.mapOpenOptions.style=u.default.openMapDarkStyle()),(S=this.config.mapOpenOptions)!=null&&S.mapid)){const w=await this.switchMap(this.config.mapOpenOptions);if(w!=null&&w.error)return{error:w.error}}t||this.setMapOptions((v=this.config.mapOptions)!=null?v:{}),await this.map.onLoad(!0),await this.addMapImages();let i=[],a=[];e.filter(w=>!(w.tag=="change"&&w.change&&w.change.reqType=="SOURCE")).forEach(w=>i.push(this.addSource(w,!0))),await Promise.all(i),e.filter(w=>w.tag=="change"&&w.change&&w.change.reqType=="SOURCE").forEach(w=>a.push(this.addSource(w,!0))),await Promise.all(a);for(let w of r)await this.addLayer(w,!0);this.addControls(),await this.execProgram()}async setMapOpenOptions(s){this.config.mapOpenOptions={...this.config.mapOpenOptions,...s},await this.setConfig()}setMapOptions(s){this.config.mapOptions={...this.config.mapOptions,...s},this.map&&(s.center?this.map.setCenter(s.center):this.isWebBaseMap()&&this.map.setCenter([116.3912,39.9073]),s.zoom!==void 0?this.map.setZoom(s.zoom):this.isWebBaseMap()&&this.map.setZoom(8),s.bearing!==void 0&&this.map.setBearing(s.bearing),s.pitch!==void 0&&this.map.setPitch(s.pitch),s.dragRotate===!1&&this.map.dragRotate.isEnabled()?(this.map.dragRotate.disable(),this.map.touchZoomRotate.disableRotation(),this.map.getCanvasContainer().oncontextmenu=t=>{t.preventDefault()}):s.dragRotate&&!this.map.dragRotate.isEnabled()&&(this.map.dragRotate.enable(),this.map.touchZoomRotate.enableRotation(),this.map.getCanvasContainer().oncontextmenu=()=>{}),s.pitchWithRotate===!1?this.map.setMaxPitch(0):this.map.setMaxPitch(85))}async addMapImages(){try{if(!this.config.mapImages)return;this.oldCacheImages=this.oldCacheImages||{};let s=[...this.config.mapImages];s=s.filter(e=>e.key&&e.value),s=s.filter(e=>{const r=e.value+"_"+e.options;return this.oldCacheImages[e.key]!=r});for(let e of s)this.map.hasImage(e.key)&&this.map.removeImage(e.key);let t=[];for(let e of s){let r;if(this.oldCacheImages[e.key]=e.value+"_"+e.options,typeof e.options=="string")try{r=JSON.parse(e.options)}catch(a){console.error(a)}let i=$e[e.value];i?t.push(this.map.addImage(e.key,i(this.map,r),r)):t.push(this.map.loadImageEx(e.key,e.value,r))}await Promise.all(t)}catch(s){console.error(s)}}async clearData(){if(!this.map)return;const{sources:s}=this.map.getStyle();this.removePrograms();for(const t in this.layersInst){const e=this.layersInst[t];e&&e.removeLayer(this.map,t)}for(const t in s)this.map.removeSourceEx(t);this.map.removeMarkers(),this.map.removePopups(),this.removeControls(),this.sources=[],this.layers=[],this.layersInst=[],this.config.mapSources=[],this.config.mapLayers=[],this.oldCacheImages={};for(let t in this.timeMgr)clearInterval(this.timeMgr[t]);this.timeMgr={}}removePrograms(){if(this.programCleaner){for(let s of this.programCleaner)s&&s();this.programCleaner=[]}}async execProgram(){if(!this.isDisableRunProgram&&(this.removePrograms(),this.config.program&&this.config.program.onMapLoaded)){let s=await Le(this.config.program.onMapLoaded,this.map,this,this.context);typeof s=="function"&&(this.programCleaner=this.programCleaner||[],this.programCleaner.push(s))}}async destory(){this.clearData(),this.map&&(this.map.remove(),this.map=null),this.keyEvent&&this.keyEvent.removeEventListener()}async switchMap(s){this.config.mapOpenOptions=s;const t=await this.map.switchMap(s,s.isKeepOldLayers,s.isVectorStyle,s.isSetCenter,s.isFitBounds);return t!=null&&t.error?{error:t.error}:t}async addSource(s,t){var i,a;const e=u.default.cloneDeep(s);if(this.sources.findIndex(n=>n.id===e.id)>=0)return!1;if(this.sources.push(u.default.cloneDeep(e)),t&&((i=this.config.mapSources)==null?void 0:i.findIndex(l=>l.id===e.id))==-1&&((a=this.config.mapSources)==null||a.push(u.default.cloneDeep(e))),e.tag==="query"){let n=await X(this.map,e.query);e.source.data=n}else if(e.tag==="change"){let n=await U(this.map,e.change,this);e.source.data=n,this.addTimer(e)}if(e.source.type==="geojson"){const n=u.default.cloneDeep(e.source);n.data=this.map.toLngLat(n.data);for(let l in e.props)n[l]=e.props[l];this.map.addSourceEx(e.id,n)}else await this.updateSource(e);return!0}async getSourceData(s){const t=this.sources.findIndex(r=>r.id===s);if(t<0)return;const e=this.sources[t];if(e.tag==="query")return await X(this.map,e.query);if(e.tag==="change")return await U(this.map,e.change,this);if(e.source.type==="geojson")return u.default.cloneDeep(e.source).data}async setSourceData(s,t,e){var n,l;const r=this.sources.findIndex(c=>c.id===s);if(r<0)return;let i=-1;e&&(i=(l=(n=this.config.mapSources)==null?void 0:n.findIndex(c=>c.id===s))!=null?l:-1);let a=!0;if(this.sources[r].tag==="query")this.sources[r].query=t,i>=0&&this.config.mapSources&&(this.config.mapSources[i].query=u.default.cloneDeep(t)),t=await X(this.map,this.sources[r].query);else if(this.sources[r].tag==="change")this.sources[r].change=t,i>=0&&this.config.mapSources&&(this.config.mapSources[i].change=u.default.cloneDeep(t)),t=await U(this.map,this.sources[r].change,this),this.addTimer(this.sources[r]);else if(this.sources[r].source.type==="geojson")this.sources[r].source.data=t,i>=0&&this.config.mapSources&&(this.config.mapSources[i].source.data=u.default.cloneDeep(t));else{if(this.sources[r].tag==="wms"){const c=this.sources[r].source.type;this.sources[r].wms=t.wms,this.sources[r].source={...t.source},c&&(this.sources[r].source.type=c),i>=0&&this.config.mapSources&&(this.config.mapSources[i].wms=u.default.cloneDeep(t.wms),this.config.mapSources[i].source={type:this.sources[i].source.type,...t.source},c&&(this.config.mapSources[i].source.type=c))}else{const c=this.sources[r].source.type;this.sources[r].source=u.default.cloneDeep(t),c&&(this.sources[r].source.type=c),i>=0&&this.config.mapSources&&(this.config.mapSources[i].source=u.default.cloneDeep(t),c&&(this.config.mapSources[i].source.type=c))}await this.updateSource(this.sources[r],!0),a=!1}a&&this.map.setData(s,this.map.toLngLat(t)),await this.notifySourceDataChange(s,!a)}async updateSource(s,t){var r,i,a,n,l,c,h,y;let e=u.default.cloneDeep(s);if(t&&this.map.removeSourceEx(e.id),e.source.type==="raster"||e.source.type==="vector"){if(e.source.bounds){const f=this.map.toLngLat([e.source.bounds[0],e.source.bounds[1]]),d=this.map.toLngLat([e.source.bounds[2],e.source.bounds[3]]);e.source.bounds=[f[0],f[1],d[0],d[1]]}if(e.tag=="wms"&&(e.source.tiles=await je(this.svc,{baseMapType:this.config.baseMapType,mapid:(r=this.config.mapOpenOptions)==null?void 0:r.mapid,version:(i=this.config.mapOpenOptions)==null?void 0:i.version,mapbounds:this.map.getGeoBounds(1).toString()},(a=e.wms)==null?void 0:a.overlayType,(n=e.wms)==null?void 0:n.param),!e.source.bounds)){let f=await Pe(this.svc,(l=e.wms)==null?void 0:l.overlayType,(c=this.config.baseMapType)!=null?c:"",(y=(h=e.wms)==null?void 0:h.param)==null?void 0:y.maps);if(f){let d=this.map.toLngLat(f).toArray();e.source.bounds=[d[0][0],d[0][1],d[1][0],d[1][1]]}}e.source.tiles||(e.source.tiles=ae(e.source.tiles,this.map)),e.source.type==="raster"?this.map.addRasterSource(e.id,e.source):this.map.addVectorSource(e.id,e.source,{})}else e.source.type==="image"||e.source.type==="video"?(e.source.coordinates&&(e.source.coordinates=this.map.toLngLat(e.source.coordinates)),e.source.type==="image"?this.map.addImageSource(e.id,e.source):this.map.addVideoSource(e.id,e.source)):this.map.addSourceEx(e.id,e.source)}removeSource(s,t){var r,i;for(let a=this.layers.length-1;a>=0;a--)this.layers[a].sourceId==s&&this.removeLayer(this.layers[a].layerId,!0);this.map.removeSourceEx(s);const e=this.sources.findIndex(a=>a.id===s);if(e>=0&&this.sources.splice(e,1),t){const a=(r=this.config.mapSources)==null?void 0:r.findIndex(n=>n.id===s);a!==void 0&&a>=0&&((i=this.config.mapSources)==null||i.splice(a,1))}this.clearTimer(s)}async addLayer(s,t){var n,l,c;const e=u.default.cloneDeep(s);if(this.layers.findIndex(h=>h.layerId===e.layerId)<0&&this.layers.push(u.default.cloneDeep(e)),t&&((n=this.config.mapLayers)==null?void 0:n.findIndex(y=>y.layerId===e.layerId))==-1&&((l=this.config.mapLayers)==null||l.push(u.default.cloneDeep(e))),e.visibleOff||this.layersInst[e.layerId])return;let i=De[e.type];i||console.error(`\u56FE\u5C42\u7C7B\u578B ${e.type} \u672A\u6CE8\u518C`);let a=new i;if(await a.addLayer(this.map,e),this.layersInst[e.layerId]=a,s.isLowest&&a.getLayerId()){let h=this.map.getStyle().layers,y=(c=a.getLayerId())!=null?c:[];Array.isArray(y)||(y=[y]);for(let f=0;f<h.length-1;f++)h.findIndex(d=>d.id==y[f])>=0&&this.map.moveLayer(y[f],h[0].id)}}async setLayerStyle(s,t,e){var i;const r=this.layers.findIndex(a=>a.layerId===s);if(!(r<0)&&(this.layersInst[s]?(this.layersInst[s].setLayerStyle(this.map,s,t,this.layers[r]),this.layers[r]=P(this.layers[r],t)):(this.layers[r]=P(this.layers[r],t),await this.addLayer(this.layers[r],e)),e)){const a=(i=this.config.mapLayers)==null?void 0:i.findIndex(n=>n.layerId===s);a!==void 0&&a>=0&&this.config.mapLayers&&(this.config.mapLayers[a]=u.default.cloneDeep(this.layers[r]))}}async setLayerVisible(s,t,e){var i;const r=this.layers.findIndex(a=>a.layerId===s);if(!(r<0)&&(this.layers[r].visibleOff=t,this.layersInst[s]||await this.addLayer(this.layers[r],e),this.layersInst[s].setVisible(this.map,s,t),e)){const a=(i=this.config.mapLayers)==null?void 0:i.findIndex(n=>n.layerId===s);a!==void 0&&a>=0&&this.config.mapLayers&&(this.config.mapLayers[a].visibleOff=t)}}async setSourceVisible(s,t,e){for(let r of this.layers)r.sourceId==s&&await this.setLayerVisible(r.layerId,t)}removeLayer(s,t){var r,i;if(!this.layersInst[s])return;this.layersInst[s].removeLayer(this.map,s),delete this.layersInst[s];const e=this.layers.findIndex(a=>a.layerId===s);if(e>=0&&this.layers.splice(e,1),t){const a=(r=this.config.mapLayers)==null?void 0:r.findIndex(n=>n.layerId===s);a!==void 0&&a>=0&&((i=this.config.mapLayers)==null||i.splice(a,1))}}addTimer(s){this.clearTimer(s.id),s.change.interval>0&&(this.timeMgr[s.id]=setInterval(async()=>{if(!this.map)return;let t=await U(this.map,s.change,this);this.map.getSource(s.id)!==void 0&&(this.map.setData(s.id,this.map.toLngLat(t)),await this.notifySourceDataChange(s.id,!1,!0))},s.change.interval*1e3))}clearTimer(s){this.timeMgr[s]&&(clearInterval(this.timeMgr[s]),delete this.timeMgr[s])}removeControls(){if(this.controls){for(let s of this.controls)s&&this.map.removeControl(s);this.controls=[]}}addControls(){if(this.removeControls(),!!this.config.controls){this.controls=this.controls||[];for(let s of this.config.controls){let t,e=s.name,r=s.options?JSON.parse(s.options):{};if(e=="DrawTool")t=new u.default.Draw.Tool(r);else{if(e=="Custom"){if(e=r.controlName,!e){console.warn("custom control options need include controlName field "),this.controls.push(null);continue}}else e=="MiniMapControl"&&(r.containerStyle||(r.containerStyle={background:this.config.backgroundColor,transform:"scale(0.6)",transformOrigin:`${s.position.indexOf("left")>=0?"0%":"100%"} ${s.position.indexOf("top")>=0?"0%":"100%"}`}));if(!e)continue;if(!u.default[e]){console.warn(`${e} is not vjmap class`),this.controls.push(null);continue}t=new u.default[e](r)}r!=null&&r.locale&&(this.map._locale={...this.map._locale,...r==null?void 0:r.locale}),this.map.addControl(t,s.position),this.controls.push(t)}}}getConfig(){return this.config}findDepsSourceId(s,t){var e;if(!!s){for(let r=0;r<this.sources.length;r++)if(this.sources[r].tag==="change"&&((e=this.sources[r].change)==null?void 0:e.fromSourceId)==s){let i=this.sources[r].id;i&&!t.has(i)&&(t.add(i),this.findDepsSourceId(i,t))}}}async notifySourceDataChange(s,t,e){var i,a;if(!s)return;let r=new Set;r.add(s),this.findDepsSourceId(s,r);for(let n of r){const l=this.sources.findIndex(c=>c.id===n);if(l>=0&&this.sources[l].tag==="change"&&((i=this.sources[l].change)==null?void 0:i.fromSourceId)){const c=await U(this.map,this.sources[l].change,this);this.map.setData(n,this.map.toLngLat(c))}}for(let n in this.layersInst)for(let l of r)(a=this.layersInst[n])==null||a.onSourceDataChange(this.map,l,t,e)}getSysImages(){return Object.keys($e)}static guid(s=8){return"x".repeat(s).replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}}const de=(o,s,t,e,r)=>{var a;if(s.symbol&&s.text&&r)return Cr(o,s,r);const i=new u.default.DbLine({color:s.color?parseInt(s.color.substring(1),16):0,start:o,end:o,alpha:((a=s.opacity)!=null?a:1)*255});return _(i),[i]},fe=(o,s,t)=>{const e=[0,5,9,13,15,18,20,25,30,35,40,50,53,60,70,80,90,100,106,120,140,158,200,211];let r=s.line_width?s.line_width*10:void 0;if(r){for(let n=1;n<e.length;n++)if(r<e[n]){r=e[n-1];break}}let i=t?s.line_opacity:s.opacity;if(s.center&&s.pointInCircle)return Sr(o,s,r,i);const a=new u.default.Db2dPolyline({color:s.color?parseInt(s.color.substring(1),16):0,points:o,lineWidth:r,alpha:(i!=null?i:1)*255,elevation:s.elevation});return _(a),[a]},he=(o,s,t)=>{var a,n;let e=[],r=t?s.fillColor:s.color,i=new u.default.DbHatch({color:r?parseInt(r.substring(1),16):0,points:o.length==1?o[0]:o,pattern:"SOLID",alpha:((a=s.opacity)!=null?a:1)*255});if(_(i),e.push(i),!t&&!s.noneOutline&&s.color!=s.outlineColor){let l=new u.default.Db2dPolyline({color:s.outlineColor?parseInt(s.outlineColor.substring(1),16):0,points:o,alpha:((n=s.opacity)!=null?n:1)*255});_(l),e.push(l)}return e},Cr=(o,s,t)=>{const e=s.text_size_zoom1?t.pixelToGeoLength(s.text_size_zoom1,1):t.getGeoBounds().height()/80;o[1]-=e/2;const r=new u.default.DbMText({color:s.color?parseInt(s.color.substring(1),16):0,location:[o[0],o[1]],attachment:2,contents:s.text,rotation:u.default.degreesToRadians(-parseFloat(s.text_rotate)),textHeight:e});return _(r),[r]},ge=(o,s,t)=>{var d,m;let e=s.export||{};if(!e.refCo1||!e.refCo2||!e.height||!e.position)return;let r,i,a,n,l;if(o.geometry.type=="Polygon")n=o.geometry.coordinates[0][0],l=o.geometry.coordinates[o.geometry.coordinates.length-1][1];else if(o.geometry.type=="MultiPolygon"){n=o.geometry.coordinates[0][0][0];let g=o.geometry.coordinates[o.geometry.coordinates.length-1];l=g[g.length-1][1]}else if(o.geometry.type=="MultiLineString")n=o.geometry.coordinates[0][0],l=o.geometry.coordinates[o.geometry.coordinates.length-1][1];else if(o.geometry.type=="GeometryCollection"){let g=o.geometry.geometries[0];g.type=="LineString"?n=g.coordinates[0]:g.type=="Polygon"&&(n=g.coordinates[0][0]);let A=o.geometry.geometries[o.geometry.geometries.length-1];A.type=="LineString"?l=A.coordinates[1]:A.type=="Polygon"&&(l=A.coordinates[A.coordinates.length-1][1])}if(!n||!l)return;let c=u.default.coordTransfromGetFourParamter([u.default.geoPoint(e.refCo1),u.default.geoPoint(e.refCo2)],[u.default.geoPoint(n),u.default.geoPoint(l)],!1,!0),h=u.default.coordTransfromByFourParamter(u.default.geoPoint(e.position),c);r=h.x,i=h.y,a=e.height*c.scale;let y,f={...e,rotation:((d=c.rotate)!=null?d:0)+((m=e.textRotate)!=null?m:0),color:s.color?parseInt(s.color.substring(1),16):0};return e.isMText?y=new u.default.DbMText({...f,location:[r,i],textHeight:a}):y=new u.default.DbText({...f,position:[r,i],height:a}),_(y),[y]},Sr=(o,s,t,e)=>{const r=o[0],i=o[o.length/2],a=new u.default.DbCircle({color:s.color?parseInt(s.color.substring(1),16):0,center:[(r[0]+i[0])/2,(r[1]+i[1])/2],radius:u.default.geoPoint(r).distanceTo(u.default.geoPoint(i))/2,lineWidth:t,alpha:(e!=null?e:1)*255});return _(a),[a]},_=o=>((o.color==0||o.color==16777215)&&(o.colorIndex=7,delete o.color),o),ot=async(o,s,t)=>{let e=s.getAll();e=o.fromLngLat(e);const i=o.getGeoBounds().width()/200;let a=[];for(let f=0;f<e.features.length;f++){let d=e.features[f];if(ee(d)){const m=V(s,"deleteEntitys");m&&Array.from(new Set(m)).forEach(g=>{a.push({objectid:g,delete:!0})});continue}if(d.geometry.type=="Point")a.push(...de(d.geometry.coordinates,d.properties,i,!1,o));else if(d.geometry.type=="LineString")a.push(...fe(d.geometry.coordinates,d.properties));else if(d.geometry.type=="Polygon"){if(d.properties.export){const m=ge(d,d.properties);if(m&&m.length>0){a.push(...m);continue}}a.push(...he(d.geometry.coordinates,d.properties))}else if(d.geometry.type=="MultiPoint")for(let m of d.geometry.coordinates)a.push(...de(m,d.properties,i,!1,o));else if(d.geometry.type=="MultiLineString"){if(d.properties.export){const m=ge(d,d.properties);if(m&&m.length>0){a.push(...m);continue}}for(let m of d.geometry.coordinates)a.push(...fe(m,d.properties))}else if(d.geometry.type=="MultiPolygon"){if(d.properties.export){const m=ge(d,d.properties);if(m&&m.length>0){a.push(...m);continue}}for(let m of d.geometry.coordinates)a.push(...he(m,d.properties))}else if(d.geometry.type=="GeometryCollection"){if(d.properties.export){const m=ge(d,d.properties);if(m&&m.length>0){a.push(...m);continue}}for(let m=0;m<d.geometry.geometries.length;m++){let g=d.geometry.geometries[m];if(g.type=="Polygon")a.push(...he(g.coordinates,d.properties,!0));else if(g.type=="MultiPolygon")for(let A of g.coordinates)a.push(...he(A,d.properties,!0))}for(let m=0;m<d.geometry.geometries.length;m++){let g=d.geometry.geometries[m];if(g.type=="Point")a.push(...de(g.coordinates,d.properties,i,!0,o));else if(g.type=="LineString")a.push(...fe(g.coordinates,d.properties,!0));else if(g.type=="MultiPoint")for(let A of g.coordinates)a.push(...de(A,d.properties,i,!0,o));else if(g.type=="MultiLineString")for(let A of g.coordinates)a.push(...fe(A,d.properties,!0))}}else console.warn("unknow FeatureCollection type:"+d.geometry.type)}let n=new u.default.DbDocument,l=o.getService(),c=l.currentMapParam();return c!=null&&c.mapid&&(c.maptype||(n.from=`${c==null?void 0:c.mapid}/${c==null?void 0:c.version}`)),n.appendEntity(a),await l.clone().updateMap({mapid:t||u.default.getTempMapId(60,!0),filedoc:n.toDoc(),mapopenway:u.default.MapOpenWay.Memory,style:{backcolor:0}})},ee=o=>o?o.id=="__data_track__":!1,He=(o,s)=>{let e=o.getAll().features.find(r=>ee(r));if(!e)o.add({id:"__data_track__",type:"Feature",properties:{...s,radius_inactive:1,radius_static:1,opacity:0,_hover_opacity:0,isOff:!0,isLocked:!0},geometry:{coordinates:[0,0],type:"Point"}});else if(e!=null&&e.id)for(let r in s)o.setFeatureProperty(e==null?void 0:e.id,r,s[r])},V=(o,s)=>{let e=o.getAll().features.find(r=>ee(r));if(e&&e.properties)return s?e.properties[s]:e.properties},ye=(o,s)=>{let t={};if(s.features.length>0){let e=s.features[0];e.geometry.type=="Polygon"?t.refCo1=o.fromLngLat(e.geometry.coordinates[0][0]):e.geometry.type=="LineString"&&(t.refCo1=o.fromLngLat(e.geometry.coordinates[0])),e=s.features[s.features.length-1],e.geometry.type=="Polygon"?t.refCo2=o.fromLngLat(e.geometry.coordinates[e.geometry.coordinates.length-1][1]):e.geometry.type=="LineString"&&(t.refCo2=o.fromLngLat(e.geometry.coordinates[1]))}return t},ze=(o,s,t)=>{const e=s!=null?s:"myhighlight";t=t!=null?t:"#FF8957",o.addGeoJSONSource(`${e}-source`,{type:"FeatureCollection",features:[]}),o.addCircleLayer(`${e}-point-layer`,`${e}-source`,{circleColor:t,circleOpacity:.8,circleRadius:1,filter:["==",["geometry-type"],"Point"]}),o.addLineLayer(`${e}-line-layer`,`${e}-source`,{lineJoin:"round",lineCap:"round",lineColor:t,lineWidth:3,lineOpacity:.8,filter:["==",["geometry-type"],"LineString"]}),o.addFillLayer(`${e}-fill-layer`,`${e}-source`,{fillColor:t,fillOpacity:1,filter:["==",["geometry-type"],"Polygon"]})},te=(o,s)=>{const t=s!=null?s:"myhighlight";o.getSource(`${t}-source`)&&o.getSource(`${t}-source`).setData({type:"FeatureCollection",features:[]})},kr=async(o,s,t,e)=>{const r=o.getService(),i=s&&u.default.geoPoint([s[0],s[1]]).equals(u.default.geoPoint([s[2],s[3]]));let a;if(i)a=await r.pointQueryFeature({zoom:o.getZoom(),x:s[0],y:s[1],limit:100,...t,fields:"objectid"});else{const y=[];let f=0;const d=5e4;for(;;){const m=await r.conditionQueryFeature({condition:"",bounds:s,fields:"objectid",includegeom:!0,realgeom:!0,isContains:s&&s[0]>s[2],beginpos:f,limit:d,...t});if(!m.result||(f+=d,y.push(...m.result||[]),y.length>=m.recordCount))break}a={result:y,recordCount:y.length}}let n=new Set,l=new Set;if(a.result){for(const y of a.result)if(y.objectid){if(e&&e.has(y.objectid)){l.add("1 != 1");continue}let f="",d=0;for(d=0;d<y.objectid.length&&ne(y.objectid[d]);d++)f+=y.objectid[d];if(f)if(f==y.objectid)n.add(f);else{const m=["_"];for(const g of m)l.add(`objectid like '${f}${g}%'`)}}}let c,h;return n.size>0&&(c=` objectid in (${Array.from(n).map(f=>`"${f}"`).join(",")}) `),l.size>0&&(h=Array.from(l).join(" or ")),c&&h?c+" or "+h:c||(h!=null?h:"")},We=async(o,s,t,e,r,i,a,n,l)=>{var A,b,C,S;const c=n!=null?n:"myhighlight",h=o.getService(),y=s&&u.default.geoPoint([s[0],s[1]]).equals(u.default.geoPoint([s[2],s[3]]));let f;r&&(f=await kr(o,s,e,i));let d;if(y&&!f)d=await h.pointQueryFeature({zoom:o.getZoom(),x:s[0],y:s[1],limit:100,...e});else{let v=[],w=0;const D=5e4;for(;;){let k;if(f?k=await h.conditionQueryFeature({condition:f,fields:"",includegeom:!0,realgeom:!0,beginpos:w,limit:D,...e}):k=await h.conditionQueryFeature({condition:"",bounds:s,fields:"",includegeom:!0,realgeom:!0,isContains:s&&s[0]>s[2],beginpos:w,limit:D,...e}),!k.result||(w+=D,v.push(...k.result||[]),v.length>=k.recordCount))break}d={result:v,recordCount:v.length}}i&&d.result&&(d.result=d.result.filter(v=>!i.has(v.objectid)),d.recordCount=d.result.length);const m={features:[],type:"FeatureCollection"},g={features:[],type:"FeatureCollection"};if(d&&d.result&&d.result.length>0){o.getSource(`${c}-source`)||ze(o,n,l);for(const w of d.result){if(w.geom&&w.geom.geometries)for(const D in w.geom.geometries){const k={type:"Feature",id:w.id+"_"+D,properties:N(w),geometry:w.geom.geometries[D]};m.features.push(k)}if(!t){const D=w.points||w.positon||w.location||w.origin||w.center;if(D){const T=D.split(";").map(I=>o.toLngLat(u.default.GeoPoint.fromString(I)));if(T.length==1){const I={type:"Feature",id:w.id,properties:N(w),geometry:{type:"Point",coordinates:T[0]}};g.features.push(I)}else if(T.length>1){const I={type:"Feature",id:w.id,properties:N(w),geometry:{type:"LineString",coordinates:T}};g.features.push(I)}}}}const v=t?m:g;v.features.length>0?!a&&((b=(A=o.getSource(`${c}-source`))==null?void 0:A._data)==null?void 0:b.features)?o.getSource(`${c}-source`).setData({features:[...(S=(C=o.getSource(`${c}-source`))==null?void 0:C._data)==null?void 0:S.features,...v.features],type:"FeatureCollection"}):o.getSource(`${c}-source`).setData(v):a&&te(o,c)}else a&&te(o,c);return o.triggerRepaint(),t?m:g},me=(o,s)=>{const t=s!=null?s:"myhighlight";te(o,t),o.triggerRepaint()},pe={},Ae=async(o,s,t)=>{var l,c;if(t===0){s.features=[];return}const e=o.getService(),r=(l=e.currentMapParam())==null?void 0:l.mapid,i=(c=e.currentMapParam())==null?void 0:c.version;if(!r)return;const a=`${r}_${i}${e.getCurWorkspaceName()}`;if(a in pe){s.features=[...pe[a].features];return}else{const h=localStorage.getItem("snap_"+a);if(h)try{const y=JSON.parse(h);if(Array.isArray(y)){s.features=[...y],pe[a]=s;return}}catch{}}let n=await e.conditionQueryFeature({fields:"s3",condition:"s3 != ''",limit:t!=null?t:1e5});if(!!n.result){n=n.result.map(h=>h.s3.split(";")),s.features=[];for(const h of n){const y=[];for(const f of h){const d=f.split(",");d.length>=2&&y.push(o.toLngLat([+d[0],+d[1]]))}y.length==1?s.features.push({type:"Feature",geometry:{type:"Point",coordinates:y[0]}}):y.length>1&&s.features.push({type:"Feature",geometry:{type:"LineString",coordinates:y}})}pe[a]=s;try{localStorage.setItem("snap_"+a,JSON.stringify(s.features))}catch{}}},Ue=async(o,s,t,e,r,i)=>{var n;if(((n=o.getService().currentMapParam())==null?void 0:n.mapopenway)==u.default.MapOpenWay.Memory){console.error("\u5185\u5B58\u6253\u5F00\u6A21\u5F0F\u4E0D\u652F\u6301\u9009\u62E9\u5B9E\u4F53\uFF0C\u8BF7\u5207\u6362\u81F3\u51E0\u4F55\u6805\u683C\u6216\u51E0\u4F55\u77E2\u91CF\u65B9\u5F0F\u6253\u5F00\u56FE\u5F62");return}const a={};for(r||Ae(o,a),o._selectFeatures=[];;){let l;if(e!=null?e:o._isPointSel){const h=await u.default.Draw.actionDrawPoint(o,{api:{getSnapFeatures:a},contextMenu:y=>{o.fire("keyup",{keyCode:13})}});if(h.cancel)break;l=[h.features[0].geometry.coordinates,h.features[0].geometry.coordinates,h.features[0].geometry.coordinates,h.features[0].geometry.coordinates]}else{const h=await u.default.Draw.actionDrawRectangle(o,{api:{getSnapFeatures:a},contextMenu:y=>{o.fire("keyup",{keyCode:13})}});if(h.cancel)break;l=h.features[0].geometry.coordinates[0]}l=o.fromLngLat(l);const c=await We(o,[l[0].x,l[0].y,l[2].x,l[1].y],s,void 0,t!=null?t:o._includeWholeEntity,i);o._selectFeatures.push(...c.features)}return o._selectFeatures},re=async(o,s,t,e,r,i,a,n)=>{const l=e=="delete"?"\u5220\u9664":e=="modify"?"\u4FEE\u6539":"\u590D\u5236";r&&r(`\u8BF7\u9009\u62E9\u8981 ${l} \u7684CAD\u5B9E\u4F53\u5BF9\u8C61\uFF0C\u6309\u53F3\u952E\u7ED3\u675F`),_e(o);const c=V(s,"hideEntityObjectIds"),h=await Ue(o,!0,!0,!a,!0,c?new Set(c):void 0);if(!h||h.length==0)return;const y=new Set,f=new Set,d=new Set;h.forEach(b=>{b.properties.objectid&&f.add(b.properties.objectid),b.id&&d.add(parseInt(b.id));const C=Y(b.properties.objectid);C&&y.add(C)});const m=async(b,C)=>{var S;if(e!="copy"){o.hasVectorLayer()?await t.addHideObjectIds(Array.from(d)):await t.addHideObjectIds(Array.from(f));const v=V(s,"deleteEntitys")||[];v.push(...Array.from(y));const w=V(s,"hideEntityObjectIds")||[];w.push(...Array.from(f));const D=V(s,"hideEntityIds")||[];D.push(...Array.from(d)),He(s,{deleteEntitys:Array.from(new Set(v)),hideEntityObjectIds:Array.from(new Set(w)),hideEntityIds:Array.from(new Set(D))})}if(e!="delete"){let v=o.getService().currentMapParam(),w={};C&&b&&(w=b[0]);const D=await G(o,Array.from(y).map(T=>({objectid:T,...w})),t==null?void 0:t.getClipBounds(),null,null,`${v.mapid}/${v.version}`);let k=s.getAll().features.length;if(H(D,s,!0),b){const T=s.getAll().features,I=new Set;for(let E=k;E<T.length;E++){const z=Y((S=T[E].properties)==null?void 0:S.objectid);I.has(z)||I.add(z);let jt=I.size-1;if(!b[jt])continue;const Nt=T[E].id;s.setFeatureProperty(Nt,"disableDirectEdit",!0),s.setFeatureProperty(Nt,"export",{...b[jt].export,...ye(o,{features:D.features.filter(Hr=>{var Gt,Ht,zt;return((Gt=Hr.properties)==null?void 0:Gt.objectid)==((zt=(Ht=T[E])==null?void 0:Ht.properties)==null?void 0:zt.objectid)})})})}}if(e=="copy"){let T={type:"FeatureCollection",features:[]};const I=s.getAll().features;for(let z=k;z<I.length;z++)T.features.push(I[z]);s.delete(T.features.map(z=>z.id));let E=await q(T,o,{},r,{drawInitPixelLength:0});E&&s.add(E.feature)}}me(o)},g=()=>{me(o)},A=(b,C)=>{let S;const v=new Set;for(let w=0;w<b.length;w++){const D=b[w].properties,k=Y(D.objectid);if(v.has(k)||(v.add(k),!(D.name=="AcDbText"||D.name=="AcDbMText")))continue;const I=D.name=="AcDbText"?{text:C!=null?C:D.text,isText:!0}:{contents:C!=null?C:D.text,isMText:!0};I.export={position:u.default.GeoPoint.fromString(D.location||D.position),height:D.height||D.textHeight,contents:C,cloneObjectId:Y(D.objectid),textRotate:D.rotate||0},S=S!=null?S:{},S[v.size-1]=I}return S};if(e!="delete"&&y.size==1&&(h[0].properties.name=="AcDbText"||h[0].properties.name=="AcDbMText")){let b;if(n?b=await n(h[0].properties.text):b=prompt("\u8BF7\u8F93\u5165\u8981\u4FEE\u6539\u7684\u6587\u5B57\u5185\u5BB9",h[0].properties.text),b==""||b==null){g();return}else await m(A(h,b),!0)}else i?await i(`\u4F60\u786E\u5B9A\u8981${l} \u8FD9 ${y.size} \u4E2Acad\u5B9E\u4F53\u5BF9\u8C61 ?`)?await m(A(h)):g():await m()},at=async(o,s,t,e,r,i,a)=>{try{await re(o,s,t,"delete",e,r,i,a)}catch(n){e&&e(n)}},nt=async(o,s,t,e,r,i,a)=>{try{await re(o,s,t,"modify",e,r,i,a)}catch(n){e&&e(n)}},lt=async(o,s,t,e,r,i,a)=>{try{await re(o,s,t,"copy",e,r,i,a)}catch(n){e&&e(n)}},G=async(o,s=[],t=null,e=null,r=null,i=null,a)=>{let n,l;if(Array.isArray(s)){n=new u.default.DbDocument,e&&(n.environment=e),r&&(n.linetypes=r);let f=o.getService().currentMapParam();t?i&&(n.from=i,n.pickEntitys=s.map(d=>d.objectid)):(i?n.from=typeof i=="string"?i:`${i.mapid}/${i.version}`:f.mapid&&(n.from=`${f.mapid}/${f.version}`),n.pickEntitys=s.map(d=>d.objectid)),n.appendEntity(s),l=t||f.bounds.toArray(),!n.from&&!t&&(l=void 0)}else n=s,l=t;let h=await o.getService().cmdCreateEntitiesGeomData({filedoc:n.toDoc(),mapBounds:l});if(h.error)throw h.error;const y=[];if(h&&h.result&&h.result.length>0){for(let f of h.result)if(f.geom&&f.geom.geometries){let d=o.entColorToHtmlColor(f.color),m={};f.isPolygon?(m.color=d,m.noneOutline=!0):(m.color=d,m.line_width=f.lineWidth);for(let g=0;g<f.geom.geometries.length;g++)f.geom.geometries[g].type=="Point"&&(f.geom.geometries[g].type="LineString",f.geom.geometries[g].coordinates=[f.geom.geometries[g].coordinates,f.geom.geometries[g].coordinates]);if(a){let g={id:f.id,type:"Feature",properties:{objectid:f.objectid,opacity:f.alpha/255,...m}};f.geom.geometries.length==1?g={...g,geometry:f.geom.geometries[0]}:g={...g,geometry:{geometries:f.geom.geometries,type:"GeometryCollection"}},y.push(g)}else for(let g=0;g<f.geom.geometries.length;g++)y.push({id:u.default.RandomID(10),type:"Feature",properties:{objectid:f.objectid,opacity:f.alpha/255,...m},geometry:f.geom.geometries[g]})}}return{type:"FeatureCollection",features:y}},ut=async(o,s,t,e)=>{if(t=JSON.parse(t),s.set(o.toLngLat(t)),o.hasVectorLayer()){const r=V(s,"hideEntityIds")||[];r&&await e.addHideObjectIds(r)}else{const r=V(s,"hideEntityObjectIds")||[];r&&await e.addHideObjectIds(r)}},B=(o,s)=>{if(!!s)for(let t in s)o.properties[t]=s[t]},_e=o=>{o.fire("keyup",{keyCode:27})},ct=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawPoint(o,t);r.cancel||(B(r.features[0],e),s.add(r.features[0]))},dt=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawLineSting(o,t);r.cancel||(B(r.features[0],e),s.add(r.features[0]))},ft=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawPolygon(o,t);r.cancel||(B(r.features[0],e),s.add(r.features[0]))},ht=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawPolygon(o,t);r.cancel||(B(r.features[0],e),s.add(r.features[0]))},se=o=>{if(o.geometry.type=="Polygon")return o.geometry.type="LineString",o.geometry.coordinates=o.geometry.coordinates[0],o},gt=async(o,s,t,e,r)=>{let i=await u.default.Draw.actionDrawCircle(o,t);i.cancel||(B(i.features[0],e),r||(i.features[0]=se(i.features[0]),B(i.features[0],{isCircle:void 0})),s.add(i.features[0]))},yt=async(o,s,t,e,r)=>{let i=await u.default.Draw.actionDrawRectangle(o,t);i.cancel||(B(i.features[0],e),r||(i.features[0]=se(i.features[0])),s.add(i.features[0]))},mt=async(o,s,t,e,r)=>{let i=await u.default.Draw.actionDrawSlantRectangle(o,t);i.cancel||(B(i.features[0],e),r||(i.features[0]=se(i.features[0])),s.add(i.features[0]))},pt=async(o,s,t,e)=>{let r=await u.default.Draw.actionSelect(o,s);if(r.features.length==0)return;e&&e("\u8BF7\u6307\u5B9A\u7684\u65CB\u8F6C\u7684\u57FA\u70B9");let i=await u.default.Draw.actionDrawPoint(o,{});if(i.cancel)return;e&&e("\u8BF7\u6307\u5B9A\u8981\u65CB\u8F6C\u7684\u89D2\u5EA6");let a=i.features[0].geometry.coordinates,n=a,l=new u.default.Polyline({data:[a,n],lineColor:"yellow",lineWidth:1,lineDasharray:[2,2]});l.addTo(o);let c=u.default.cloneDeep(r.features),h=await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:y=>{if(!y.lnglat)return;n=y.lnglat,l.setData([a,n]);let f=o.fromLngLat(n).angleTo(o.fromLngLat(a)),d=u.default.cloneDeep(c);for(let m=0;m<d.length;m++){let g=u.default.transform.convert(d[m],A=>{let C=o.fromLngLat(A).roateAround(f,o.fromLngLat(a));return o.toLngLat(C)});s.setFeatureProperty(d[m].id,"coordinates",g)}s.forceRefresh()}});if(l.remove(),h.cancel){for(let y=0;y<c.length;y++)s.setFeatureProperty(c[y].id,"coordinates",c[y]);s.forceRefresh();return}},At=(o,s)=>{let t=s.getSelected().features.filter(i=>i.geometry.type=="LineString"||i.geometry.type=="Polygon");if(t.length==0)return;let e=u.default.cloneDeep(t);for(let i=0;i<t.length;i++){let a=t[i];if(a.geometry.type=="LineString"){const n=u.default.polylineToBezierCurve(o.fromLngLat(a.geometry.coordinates).map(c=>[c.x,c.y])),l=u.default.bezierCurveToPolyline(n,100);s.setFeatureProperty(a.id,"coordinates",o.toLngLat(l))}else{let n=[];for(let l=0;l<a.geometry.coordinates.length;l++){const c=u.default.polylineToBezierCurve(o.fromLngLat(a.geometry.coordinates[l]).map(y=>[y.x,y.y])),h=u.default.bezierCurveToPolyline(c,1e3);n.push(o.toLngLat(h))}s.setFeatureProperty(a.id,"coordinates",n)}}let r=s.getSelected().features.filter(i=>i.geometry.type=="LineString"||i.geometry.type=="Polygon");o.fire("draw.update",{action:"toBezierCurve",features:u.default.cloneDeep(r),prevFeatures:e,styleId:s.options.styleId}),s.changeMode("simple_select")},we=async(o,s,t,e,r,i,a)=>{var g,A,b,C,S;let n=await u.default.Draw.actionDrawPoint(o,{...t});if(n.cancel)return;let l=o.fromLngLat(n.features[0].geometry.coordinates),c;if(i?c=new u.default.EllipseFill({center:l,majorAxisRadius:0,minorAxisRadius:0,fillColor:(g=e==null?void 0:e.color)!=null?g:"green",fillOpacity:(A=e==null?void 0:e.opacity)!=null?A:.8,fillOutlineColor:(b=e==null?void 0:e.outlineColor)!=null?b:"#f00"}):c=new u.default.EllipseEdge({center:l,majorAxisRadius:0,minorAxisRadius:0,lineColor:(C=e==null?void 0:e.outlineColor)!=null?C:"red",lineWidth:(S=e==null?void 0:e.line_width)!=null?S:3}),c.addTo(o),(await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:v=>{if(!v.lnglat)return;const w=o.fromLngLat(v.lnglat);c.setMinorAxisRadius(l.distanceTo(w)),c.setMajorAxisRadius(l.distanceTo(w))}})).cancel){c.remove();return}if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:v=>{if(!v.lnglat)return;const w=o.fromLngLat(v.lnglat);c.setMinorAxisRadius(l.distanceTo(w))}})).cancel){c.remove();return}if(a){if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:D=>{if(!D.lnglat)return;const k=o.fromLngLat(D.lnglat);c.setStartAngle(u.default.radiansToDegrees(k.angleTo(l)))}})).cancel){c.remove();return}if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:D=>{if(!D.lnglat)return;const k=o.fromLngLat(D.lnglat);c.setEndAngle(u.default.radiansToDegrees(k.angleTo(l)))}})).cancel){c.remove();return}}let f=c.getData();if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:v=>{if(!v.lnglat)return;let D=o.fromLngLat(v.lnglat).angleTo(l),k=u.default.cloneDeep(f),T;i?T=k.features[0].geometry.coordinates[0]:T=k.features[0].geometry.coordinates;for(let I=0;I<T.length;I++){let E=o.fromLngLat(T[I]);E=E.roateAround(D,l),E=o.toLngLat(E),T[I]=E}c.setData(k)}})).cancel){c.remove();return}let m=c.getData().features[0];m.id=u.default.RandomID(10),m.properties={...e},s.add(m),c.remove()},wt=(o,s,t,e,r)=>{we(o,s,t,e,r,!0)},bt=(o,s,t,e,r)=>{we(o,s,t,e,r,!1)},Lt=(o,s,t,e,r)=>{we(o,s,t,e,r,!0,!0)},vt=(o,s,t,e,r)=>{we(o,s,t,e,r,!1,!0)},be=o=>{let s=[];u.default.transform.convert(o,e=>(s.push(u.default.geoPoint(e)),e));let t=new u.default.GeoBounds;return t.update(s),t},q=async(o,s,t,e,r)=>{var n,l,c;const i=s.createDrawLayer();r=r!=null?r:{};const a=()=>{i&&s.removeDrawLayer(i),s.setIsInteracting(!1)};try{let h=be(o),y,f;if(r.keepGeoSize!==!0){let v=s.fromLngLat(s.getCenter()),w=s.pixelToGeoLength((n=r.drawInitPixelLength)!=null?n:100,s.getZoom()),D=s.fromLngLat(h),k=w/D.width(),T=w/D.height(),I=Math.min(k,T);u.default.isZero(I)&&(I=1);let E=h.center();r.baseAlign=="leftBottom"?E=h.min:r.baseAlign=="leftTop"&&(E=u.default.geoPoint([h.min.x,h.max.y])),f=j(s,u.default.cloneDeep(o),s.fromLngLat(E),v,I)}else f=o;y=s.fromLngLat(be(f));let d=y.center();r.baseAlign=="leftBottom"?d=y.min:r.baseAlign=="leftTop"&&(d=u.default.geoPoint([y.min.x,y.max.y])),H(f,i);let m=u.default.cloneDeep(i.getAll()),g;if(r.position){const v=r.position;let w=j(s,u.default.cloneDeep(m),d,v);i.set(w),g=r.position}else{e&&e("\u8BF7\u79FB\u52A8\u9F20\u6807\u81F3\u6307\u5B9A\u4F4D\u7F6E\u70B9\u51FB\u8FDB\u884C\u7ED8\u5236"),s.setIsInteracting(!0);let v=await u.default.Draw.actionDrawPoint(s,{...t,updatecoordinate:w=>{if(!w.lnglat)return;i.deleteAll();const D=s.fromLngLat(w.lnglat);let k=j(s,u.default.cloneDeep(m),d,D);i.set(k)}});if(v.cancel){a();return}g=s.fromLngLat(v.features[0].geometry.coordinates)}let A;(!r.disableScale||!r.disableRotate)&&(A=new u.default.Polyline({data:s.toLngLat([g,g]),lineColor:(l=r.tempLineColor)!=null?l:"yellow",lineWidth:1,lineDasharray:[2,2]}),A.addTo(s));let b=1;if(!r.disableScale){let v=await u.default.Draw.actionDrawPoint(s,{...t,updatecoordinate:w=>{if(i.deleteAll(),!w.lnglat)return;const D=s.fromLngLat(w.lnglat);let T=D.distanceTo(g)/(y.width()/2),I=j(s,u.default.cloneDeep(m),d,g,T);i.set(I),A.setData(s.toLngLat([g,D]))}});if(v.cancel)if(v.isEnterKey)b=1;else{a(),A.remove();return}else b=s.fromLngLat(v.features[0].geometry.coordinates).distanceTo(g)/(y.width()/2),b<1e-4&&(b=.1);A.setData(s.toLngLat([g,g]))}let C=0;if(!r.disableRotate){let v=await u.default.Draw.actionDrawPoint(s,{...t,updatecoordinate:w=>{if(i.deleteAll(),!w.lnglat)return;const D=s.fromLngLat(w.lnglat);C=D.angleTo(g)*180/Math.PI;let k=j(s,u.default.cloneDeep(m),d,g,b,C);i.set(k),A.setData(s.toLngLat([g,D]))}});if(A.remove(),v.cancel){if(!v.isEnterKey){a();return}C=0;let w=j(s,u.default.cloneDeep(m),d,g,b,C);i.set(w)}}s.setIsInteracting(!1);let S=i.getAll();return s.removeDrawLayer(i),{feature:S,rotation:C}}catch(h){a(),e&&e((c=h==null?void 0:h.message)!=null?c:h)}},Dt=async(o,s,t,e,r,i)=>{var b,C,S,v,w,D,k,T;i=i||{};let a=new u.default.DbLineType;a.name="my_arrow_dash",a.comments="\u865A\u7EBF",a.style=[{method:"numDashes",parameter:4},{method:"patternLength",parameter:1},{method:"dashLengthAt",parameter:[0,.5]},{method:"dashLengthAt",parameter:[1,-.2]},{method:"dashLengthAt",parameter:[2,.1]},{method:"dashLengthAt",parameter:[3,-.2]}];let n=[],l=(b=i.arrowShape)!=null?b:[[10,60],[150,20],[140,40],[190,0],[140,-40],[150,-20],[10,-40],[10,60]],h=u.default.getGeoBounds(l.map(I=>u.default.geoPoint(I))).scale(3).toArray(),y=new u.default.DbPolyline;y.lineWidth=(C=i.lineWidth)!=null?C:50,y.points=l,i.noLineType||(y.linetype="my_arrow_dash",y.linetypeScale=30),y.color=o.htmlColorToEntColor((S=e==null?void 0:e.outlineColor)!=null?S:u.default.randomColor());let f=(v=e==null?void 0:e.color)!=null?v:u.default.randomColor(),d=new u.default.DbHatch;if(d.pattern="SOLID",d.color=o.htmlColorToEntColor(f),d.points=l,d.alpha=100*((w=e==null?void 0:e.opacity)!=null?w:1),n.push(y,d),!i.noText){let I=new u.default.DbText({position:(D=i.textPositon)!=null?D:[100,70],contents:(k=i.contents)!=null?k:"\u7BAD\u5934",color:o.htmlColorToEntColor(f),horizontalMode:4,height:(T=i.textHeight)!=null?T:20});n.push(I)}let g=await G(o,n,h,{LWDISPLAY:!0},[a]),A=await q(g,o,t,r);!A||s.add(A==null?void 0:A.feature)},Ct=async(o,s,t,e,r,i)=>{var c,h,y,f,d;i=i||{};let a=await u.default.Draw.actionDrawLineSting(o,{...t});if(a.cancel)return;let n=o.fromLngLat(a.features[0].geometry.coordinates),l=new u.default.DbPolyline;if(l.objectid=(c=i.objectid)!=null?c:"40D",l.color=u.default.htmlColorToEntColor((h=e==null?void 0:e.color)!=null?h:u.default.randomColor()),l.linetypeScale=(y=i.linetypeScale)!=null?y:100,l.points=n.map(m=>[m.x,m.y]),l){let m=await G(o,[l],null,null,null,{mapid:(f=i.mapid)!=null?f:"sys_symbols",version:(d=i.version)!=null?d:"v1"});H(m,s)}},xr=(o,s,t)=>{let e=null,r=new Date;return function(){let i=this,a=arguments,n=new Date;clearTimeout(e),n-r>=t?(o.apply(i,a),r=n):e=setTimeout(function(){o.apply(i,a)},s)}},St=async(o,s,t,e,r,i)=>{var f;i=i!=null?i:{};let a=u.default.htmlColorToEntColor((f=e==null?void 0:e.color)!=null?f:u.default.randomColor());const n=async(d,m)=>{var A,b,C,S;let g={};if(g.objectid=(A=i==null?void 0:i.objectid)!=null?A:"40E",g.color=m,g.linetypeScale=(b=i==null?void 0:i.linetypeScale)!=null?b:100,g.fitPoints=d.map(v=>[v.x,v.y]),g)return await G(o,[g],null,null,null,{mapid:(C=i==null?void 0:i.mapid)!=null?C:"sys_symbols",version:(S=i==null?void 0:i.version)!=null?S:"v1"})};let l=o.createDrawLayer(),c=await u.default.Draw.actionDrawLineSting(o,{...t,updatecoordinate:xr(async d=>{let m=o.fromLngLat(d.feature.coordinates),g=await n(m,a);l&&l.set(g)},200,300)});if(o.removeDrawLayer(l),l=null,c.cancel)return;let h=o.fromLngLat(c.features[0].geometry.coordinates),y=await n(h,a);y&&H(y,s)},kt=async(o,s,t,e,r,i)=>{var c,h,y,f,d;i=i!=null?i:{};let a=await u.default.Draw.actionDrawPolygon(o,{...t});if(a.cancel)return;let n=o.fromLngLat(a.features[0].geometry.coordinates[0]),l=new u.default.DbHatch;if(l.objectid=(c=i.objectid)!=null?c:"42F",l.color=u.default.htmlColorToEntColor((h=e==null?void 0:e.color)!=null?h:u.default.randomColor()),l.patternScale=(y=i.patternScale)!=null?y:400,l.points=n.map(m=>[m.x,m.y]),l){let m=await G(o,[l],null,null,null,{mapid:(f=i.mapid)!=null?f:"sys_symbols",version:(d=i.version)!=null?d:"v1"});H(m,s)}},Ze=async(o,s,t)=>{t=t!=null?t:{};let e=await o.getService().conditionQueryFeature({fields:"",includegeom:!0,realgeom:!0,limit:1e4,...s});const r=[];if(e&&e.result&&e.result.length>0){for(let i of e.result)if(i.geom&&i.geom.geometries){let a=o.entColorToHtmlColor(i.color);for(let n=0;n<i.geom.geometries.length;n++)r.push({id:u.default.RandomID(10),type:"Feature",properties:{objectid:i.objectid+"_"+n,color:a,alpha:i.alpha/255,lineWidth:1,name:i.name,isline:i.isline,layerindex:i.layerindex,...t},geometry:i.geom.geometries[n]})}}return{type:"FeatureCollection",features:r}},xt=async(o,s,t,e,r,i)=>{var m,g,A;i=i!=null?i:{},r&&r("\u8BF7\u79FB\u52A8\u9F20\u6807\u5C06\u8981\u7ED8\u5236\u7684\u7B26\u53F7\u79FB\u52A8\u81F3\u6307\u5B9A\u4F4D\u7F6E\u70B9\u51FB\u8FDB\u884C\u7ED8\u5236");let a=(m=i.mapid)!=null?m:"sys_symbols",n=(g=i.version)!=null?g:"v1",c=await o.getService().getStyleLayerName(a,n,!0),h=await Ze(o,{mapid:a,version:n,layer:c,condition:(A=i.condition)!=null?A:"layerindex=1"},{symbolId:u.default.RandomID()}),y=await q(h,o,t,r,{...e,baseAlign:"center"});if(!y)return;H(y.feature,s);let f=s.getAll().features,d=f[f.length-1].id;for(let b in e)s.setFeatureProperty(d,b,e[b])},It=async(o,s,t,e,r)=>{var d,m;if(e=e||{},!e.text)return;let i=[-1e3,-1e3,1e3,1e3],a=[],n={position:[0,0],contents:e.text,color:o.htmlColorToEntColor(e.color),horizontalMode:u.default.DbTextHorzMode.kTextLeft,verticalMode:u.default.DbTextVertMode.kTextBottom,height:10},l=new u.default.DbText(n);a.push(l);let c=await G(o,a,i);const h=new u.default.GeoProjection(u.default.GeoBounds.fromArray(i));let y=ye(h,c);n={...n,...y};let f=await q(c,o,t,r,{...e,baseAlign:"leftBottom",drawInitPixelLength:(d=e.height)!=null?d:50,disableRotate:e==null?void 0:e.disableRotate,disableScale:e==null?void 0:e.disableScale});!f||(f.feature.features[0].properties=(m=f.feature.features[0].properties)!=null?m:{},f.feature.features[0].properties.export=n,s.add(f.feature))},H=(o,s,t)=>{const e=new Set;if(t&&o.features.forEach(r=>{r&&r.properties&&r.properties.objectid&&e.add(r.properties.objectid)}),!t||e.size==0){let r=[];o.features.forEach(i=>{r.push(...s.add(i))}),s.changeMode("simple_select",{featureIds:r});try{s.combineFeatures()}catch{}return r.length}else{let r=s.getAll().features.length;for(let n of e){let l=[];if(o.features.forEach(c=>{c.properties.objectid==n&&l.push(...s.add(c))}),l.length!=0){s.changeMode("simple_select",{featureIds:l});try{s.combineFeatures()}catch{}}}let i=[],a=s.getAll().features;for(let n=r;n<a.length;n++)i.push(a[n].id);return s.changeMode("simple_select",{featureIds:i}),e.size}},Tt=()=>{const o=u.default.Draw.defaultOptions();let s=o.styles.findIndex(t=>t.id==="gl-draw-point-point-stroke-inactive");return s>=0&&(o.styles[s].paint["circle-radius"][3][3]=0),s=o.styles.findIndex(t=>t.id==="gl-draw-point-inactive"),s>=0&&(o.styles[s].paint["circle-radius"][3][3]=1),s=o.styles.findIndex(t=>t.id==="gl-draw-point-stroke-active"),s>=0&&(o.styles[s].paint["circle-radius"][3]=0),s=o.styles.findIndex(t=>t.id==="gl-draw-point-active"),s>=0&&(o.styles[s].paint["circle-radius"][3]=1),o},Ft=async(o,s,t)=>{let e=o.getService();if(t){let r=s.reduce((i,a)=>(a.isOff||i.push(a.name),i),[]);Ke(o,r)}else await o.switchLayers(e,s.reduce((r,i)=>(i.isOff||r.push(i.name),r),[]))},Ke=(o,s)=>{const t=c=>i.getMapLayers().findIndex(h=>h.name===c),e=(c,h)=>{Array.isArray(c)||(c=[c]);let y=[];return h||(y=c.map(f=>t(f))),y.length==0&&(y=[-1]),["match",["get","layer"],y,!0,!1]};let r=o.getStyle(),i=o.getService(),n=i.vectorStyle().layers.map(c=>c.id),l=e(s,!1);for(let c=0;c<r.layers.length;c++)n.includes(r.layers[c].id)&&(r.layers[c].filter=l);o.setStyle(r)},Et=(o,s,t)=>{if(o.hasVectorLayer()){const e=o.layersBySource("vector-source");for(let r of e){const i=o.getLayer(r);i.type=="fill"?o.setFillOpacity(r,s):i.type=="line"?o.setLineOpacity(r,s):i.type=="circle"&&o.setCircleOpacity(r,s)}}if(t){const r=o.getStyle().layers.filter(i=>i.id.indexOf(t)>=0);for(let i of r)o.setRasterOpacity(i.id,s)}else{const e=o.getService().rasterLayerId();o.getLayer(e)&&o.setRasterOpacity(o.getService().rasterLayerId(),s)}},Pt=(o,s)=>{const t=o.getStyle().layers;t.length!=0&&o.moveLayer(s,t[0].id)};let Z,ie;async function Mt(o,s){switch(ie=s,s!="measureCancel"&&(await Bt(o),Z||(Z={},Ae(o,Z))),s){case"measureDist":Ir(o,Z);break;case"measureArea":Pr(o,Z);break;case"measureAngle":Or(o,Z);break;case"measureCoordinate":jr(o,Z);break;case"measureCancel":await Bt(o);break}}const Bt=async o=>{o.fire("keyup",{keyCode:27}),await oe(100),o.fire("keyup",{keyCode:27}),await oe(100),o.setIsInteracting(!1)};let K;const F=(o,s)=>{o?K?K.setHTML(o):K=new u.default.Popup({className:"my-custom-popup",closeOnClick:!1,closeButton:!1}).setHTML(o).setMaxWidth("500px").trackPointer().addTo(s):K&&(K.setLngLat([0,0]),K.remove(),K=null)},Ir=async(o,s)=>{for(;!((await Tr(o,s)).exit===!0||ie!="measureDist"););},Tr=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawLineSting(o,{api:{getSnapFeatures:s},updatecoordinate:a=>{if(!a.lnglat)return;t=!0;const n=o.fromLngLat(a.feature.coordinates[a.feature.coordinates.length-1]);let l=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u8DDD\u79BB\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${n.x.toFixed(2)}, ${n.y.toFixed(2)}</span>`;if(a.feature.coordinates.length==1)l+="<br/>\u8BF7\u6307\u5B9A\u8981\u6D4B\u91CF\u7684\u7B2C\u4E00\u70B9\u7684\u5750\u6807\u4F4D\u7F6E";else{let c=a.feature.coordinates.length;l+="<br/>\u6309Alt\u952E\u53D6\u6355\u6349; Ctrl\u952E\u542F\u7528\u6B63\u4EA4; \u9000\u683C\u952E\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",l+=`<br/>\u8DDD\u4E0A\u4E00\u70B9\u8DDD\u79BB: <span style="color: #ff0000">${Je(o,[a.feature.coordinates[c-2],a.feature.coordinates[c-1]])}</span>`,l+=`;  \u5F53\u524D\u603B\u7684\u8DDD\u79BB: <span style="color: #ff0000">${Je(o,a.feature.coordinates)}</span></span>`}F(l,o)},contextMenu:a=>{new u.default.ContextMenu({event:a.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",onClick:()=>{o.fire("keyup",{keyCode:8})}},{label:"\u7ED3\u675F\u6D4B\u8DDD",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});if(e.cancel)return F("",o),{cancel:!0,exit:t===!1};let r=u.default.randomColor(),i=new u.default.Polyline({data:e.features[0].geometry.coordinates,lineColor:r,lineWidth:2});return i.addTo(o),Fr(o,e.features[0].geometry.coordinates,r,i.sourceId||"",s),{polyline:i}},Fr=(o,s,t,e,r)=>{let i=[];for(let c=1;c<s.length;c++){let h=new u.default.Text({text:Je(o,s.slice(0,c+1)),anchor:"left",offset:[3,0],style:{cursor:"pointer",opacity:.8,padding:"6px","border-radius":"12px","background-color":t,"border-width":0,"box-shadow":"0px 2px 6px 0px rgba(97,113,166,0.2)","text-align":"center","font-size":"14px",color:`#${t.substring(1).split("").map(y=>(15-parseInt(y,16)).toString(16)).join("")}`}});h.setLngLat(s[c]).addTo(o),i.push(h)}const a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let n=document.createElement("div");n.className="marker",n.style.backgroundImage=`url(${a})`,n.style.width="20px",n.style.height="20px",n.style.backgroundSize="100%",n.style.cursor="pointer",n.addEventListener("click",function(c){o.removeSourceEx(e),i.forEach(h=>h.remove()),i=[],o.fire("keyup",{keyCode:8})});let l=new u.default.Marker({element:n,anchor:"right"});l.setLngLat(s[0]).setOffset([-5,0]).addTo(o),i.push(l),Ye(r,s)},Je=(o,s)=>{let t=u.default.Math2D.lineDist(o.fromLngLat(s)),e="m";return t>=1e3?(t/=1e3,e="km"):t<.01&&(t*=100,e="cm"),t.toFixed(2)+" "+e},Ye=(o,s)=>{o.features.push({type:"Feature",geometry:{type:"LineString",coordinates:[...s]}})},Er=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawPolygon(o,{api:{getSnapFeatures:s},updatecoordinate:a=>{if(!a.lnglat)return;t=!0;const n=o.fromLngLat(a.feature.coordinates[0][a.feature.coordinates.length-1]);let l=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u9762\u79EF\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${n.x.toFixed(2)}, ${n.y.toFixed(2)}</span>`;a.feature.coordinates[0].length==1?l+="<br/>\u8BF7\u6307\u5B9A\u8981\u6D4B\u91CF\u7684\u7B2C\u4E00\u70B9\u7684\u5750\u6807\u4F4D\u7F6E":(l+="<br/>\u6309Alt\u952E\u53D6\u6355\u6349; Ctrl\u952E\u542F\u7528\u6B63\u4EA4; \u9000\u683C\u952E\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",l+=`<br/>\u5F53\u524D\u9762\u79EF: <span style="color: #ff0000">${Ot(o,a.feature.coordinates[0])}</span></span>`),F(l,o)},contextMenu:a=>{new u.default.ContextMenu({event:a.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",onClick:()=>{o.fire("keyup",{keyCode:8})}},{label:"\u7ED3\u675F\u6D4B\u9762\u79EF",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});if(e.cancel)return F("",o),{cancel:!0,exit:t===!1};let r=u.default.randomColor(),i=new u.default.Polygon({data:e.features[0].geometry.coordinates[0],fillColor:r,fillOpacity:.4,fillOutlineColor:r});return i.addTo(o),Mr(o,e.features[0].geometry.coordinates[0],r,i.sourceId||"",s),{polygon:i}},Pr=async(o,s)=>{for(;!((await Er(o,s)).exit===!0||ie!="measureArea"););},Mr=(o,s,t,e,r)=>{let i=[];const a=u.default.polygonCentroid(o.fromLngLat(s));let n=new u.default.Text({text:Ot(o,s),anchor:"center",offset:[0,0],style:{cursor:"pointer",opacity:.8,padding:"6px","border-radius":"12px","background-color":`#${t.substring(1).split("").map(y=>(15-parseInt(y,16)).toString(16)).join("")}`,"border-width":0,"box-shadow":"0px 2px 6px 0px rgba(97,113,166,0.2)","text-align":"center","font-size":"14px",color:t}});n.setLngLat(o.toLngLat(a)).addTo(o),i.push(n);const l="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let c=document.createElement("div");c.className="marker",c.style.backgroundImage=`url(${l})`,c.style.width="20px",c.style.height="20px",c.style.backgroundSize="100%",c.style.cursor="pointer",c.addEventListener("click",function(y){o.removeSourceEx(e),i.forEach(f=>f.remove()),i=[]});let h=new u.default.Marker({element:c,anchor:"right"});h.setLngLat(s[0]).setOffset([-5,0]).addTo(o),i.push(h),Ye(r,s)},Ot=(o,s)=>{let t=u.default.calcPolygonArea(o.fromLngLat(s)),e="m\xB2";return t>=1e6?(t/=1e6,e="km\xB2"):t<1/1e4&&(t*=1e4,e="cm\xB2"),t.toFixed(2)+" "+e},Br=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawLineSting(o,{pointCount:3,api:{getSnapFeatures:s},updatecoordinate:a=>{if(!a.lnglat)return;t=!0;const n=o.fromLngLat(a.feature.coordinates[a.feature.coordinates.length-1]);let l=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u89D2\u5EA6\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${n.x.toFixed(2)}, ${n.y.toFixed(2)}</span>`;a.feature.coordinates.length==1?l+="<br/>\u8BF7\u6307\u5B9A\u8981\u6D4B\u91CF\u7684\u7B2C\u4E00\u70B9\u7684\u5750\u6807\u4F4D\u7F6E":(a.feature.coordinates.length,l+="<br/>\u6309Alt\u952E\u53D6\u6355\u6349; Ctrl\u952E\u542F\u7528\u6B63\u4EA4; \u9000\u683C\u952E\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",l+=`<br/>\u5F53\u524D\u89D2\u5EA6: <span style="color: #ff0000">${Rt(o,a.feature.coordinates).angle}</span></span>`),F(l,o)},contextMenu:a=>{new u.default.ContextMenu({event:a.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",onClick:()=>{o.fire("keyup",{keyCode:8})}},{label:"\u7ED3\u675F\u6D4B\u89D2\u5EA6",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});if(e.cancel)return F("",o),{cancel:!0,exit:t===!1};let r=u.default.randomColor(),i=new u.default.Polyline({data:e.features[0].geometry.coordinates,lineColor:r,lineWidth:2});return i.addTo(o),Rr(o,e.features[0].geometry.coordinates,r,i.sourceId||"",s),{polyline:i}},Or=async(o,s)=>{for(;!((await Br(o,s)).exit===!0||ie!="measureAngle"););},Rr=(o,s,t,e,r)=>{if(s.length<3)return;let i=[],a=o.fromLngLat(s);s[1];let n=Rt(o,s);const l=u.default.getCirclePolygonCoordinates(a[1],a[1].distanceTo(a[0])/4,36,n.startAngle,n.endAngle,!1);let c=new u.default.Polyline({data:o.toLngLat(l),lineColor:t,lineWidth:2});c.addTo(o),i.push(c);let h=c.getData().features[0].geometry.coordinates,y=h[Math.ceil(h.length/2)],f=u.default.radiansToDegrees(-o.fromLngLat(y).angleTo(a[1]))+90;f>90?f+=180:f>270&&(f-=180);let d=new u.default.Text({text:n.angle,anchor:"center",rotation:f,offset:[0,0],style:{cursor:"pointer",opacity:.8,padding:"6px","border-radius":"12px","background-color":t,"border-width":0,"box-shadow":"0px 2px 6px 0px rgba(97,113,166,0.2)","text-align":"center","font-size":"14px",color:`#${t.substring(1).split("").map(b=>(15-parseInt(b,16)).toString(16)).join("")}`}});d.setLngLat(y).addTo(o),i.push(d);const m="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let g=document.createElement("div");g.className="marker",g.style.backgroundImage=`url(${m})`,g.style.width="20px",g.style.height="20px",g.style.backgroundSize="100%",g.style.cursor="pointer",g.addEventListener("click",function(b){o.removeSourceEx(e),i.forEach(C=>C.remove()),i=[]});let A=new u.default.Marker({element:g,anchor:"right"});A.setLngLat(s[1]).setOffset([-5,0]).addTo(o),i.push(A),Ye(r,s)},Rt=(o,s)=>{let t=o.fromLngLat(s);if(t.length<3)return{angle:0};let e=t[0].angleTo(t[1]),r=t[2].angleTo(t[1]),i=e-r,a=u.default.radiansToDegrees(i),n=!0;a<0&&(a=-a,n=!n),a>180&&(a=360-a,n=!n);let l=n?u.default.radiansToDegrees(r):u.default.radiansToDegrees(e),c=n?u.default.radiansToDegrees(e):u.default.radiansToDegrees(r);return l=l<0?360+l:l,c=c<0?360+c:c,c<l&&(c+=360),{angle:a.toFixed(2)+"\xB0",dir:n,startAngle:l,endAngle:c}},Vr=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawPoint(o,{api:{getSnapFeatures:s},updatecoordinate:r=>{if(!r.lnglat)return;t=!0;const i=o.fromLngLat(r.lnglat);let a=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u5750\u6807\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${i.x.toFixed(2)}, ${i.y.toFixed(2)}</span></span>`;F(a,o)},contextMenu:r=>{new u.default.ContextMenu({event:r.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u7ED3\u675F\u6D4B\u5750\u6807",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});return e.cancel?(F("",o),{cancel:!0,exit:t===!1}):(Nr(o,e.features[0].geometry.coordinates),{point:e})},jr=async(o,s)=>{for(;!((await Vr(o,s)).exit===!0||ie!="measureCoordinate"););},Nr=(o,s)=>{let t=[],e=o.fromLngLat(s),r=`X: ${e.x.toFixed(2)}, Y: ${e.y.toFixed(2)}`,i=Gr(o,s,r);t.push(i);const a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let n=document.createElement("div");n.className="marker",n.style.backgroundImage=`url(${a})`,n.style.width="20px",n.style.height="20px",n.style.backgroundSize="100%",n.style.cursor="pointer",n.addEventListener("click",function(c){t.forEach(h=>h.remove()),t=[]});let l=new u.default.Marker({element:n,anchor:"right"});l.setLngLat(s).setOffset([-5,0]).addTo(o),t.push(l)},Gr=(o,s,t)=>{let e=document.createElement("div");e.className="marker",e.style.position="absolute";let r=document.createElement("div");r.style.backgroundImage='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAB4AAAAAlCAYAAACj1PQVAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTJFMTU1RjExN0UzMTFFOTg3RTBFODdGNTY0NThGQkUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTJFMTU1RjIxN0UzMTFFOTg3RTBFODdGNTY0NThGQkUiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMkUxNTVFRjE3RTMxMUU5ODdFMEU4N0Y1NjQ1OEZCRSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMkUxNTVGMDE3RTMxMUU5ODdFMEU4N0Y1NjQ1OEZCRSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pj97JFoAAAV9SURBVHja7N1faJ1nHQfw33nzpuekaZfWNFmbLHXWdf7DWgvebF4M0SEZhTG8mKvFyzG9UJFKh9peVGnd0DkE/10Ic6s6BBEGbshggho3BVGnRnC2s1n/ras2J2uzc05PXp+3yZzSm7XJkvfi84HveZ9z3ve8F7/bL8/71oqiiMs8NhCLsCllfcpfAwAAAAAAAIDlsXM68jfgtl9K2Z3Sa8IAAAAAAAAAb7hjKW8uF9kS3/jdKR9PaZkxAAAAAAAAwPJa6h3A96X0pBxK+bLxAgAAAAAAACyfpSyAP5jy4ZQXUh747687p00ZAAAAAAAAYBlkS3if+xfW+1MuGC0AAAAAAADA8lqqAnh3yvaUZ1MeMlYAAAAAAACA5bcUBXBfyoGF9edSusYKAAAAAAAAsPyWogD+VMpYypMpTxgpAAAAAAAAwMpYbAG8IWVvylzKHuMEAAAAAAAAWDmLLYC/mDKQ8nDKH4wTAAAAAAAAYOUspgC+IeWelNmYL4IBAAAAAAAAWEGLKYAPpfSmfD1lyigBAAAAAAAAVtbVFsA3pdyR8lLMF8EAAAAAAAAArLCrKYBrKfcvHA+kNI0RAAAAAAAAYOVdTQFc7vwtdwA/l/ItIwQAAAAAAACohistgMt3/h5cWO9N6RghAAAAAAAAQDVcaQF8d8rWlImUnxgfAAAAAAAAQHVcSQF8Tcq+lCJlz8IRAAAAAAAAgIq4kgK4fOTzUMzv/J0wOgAAAAAAAIBqeb0F8FjKp2P+nb97jQ0AAAAAAACgel5vAXwgpS/l2ynPGRsAAAAAAABA9eSjd370sh+P7/q/r9tTdqc0Y74IBgAAAAAAAKCC8v9Zl7uB6yn9o4fHG+lYS2n/867Hv5bXivLcoZQzRgYAAAAAAABQTfnw5nvjxWMHe9N6cP+OyVtv2nj2ruFG6209WbGqM5c181rx9m5RO/ngn2/4zlf/tLV2fNfPCmMDAAAAAAAAqJ68LH+HGq2xRz7wu2+8a31zvCgiLs5FlC3vqp4YKS8638mzqZf7tqXlb1MuGBsAAAAAAABA9ZSPdh58tfyd7UScOh9xYjqLszNZlGVwN6U/71z7hR1/e/g9g9NbRg+P9xobAAAAAAAAQPVk+3ZMfujV8vf0TC3WXWzE9ZveHyNjt0UxOxCnp7NotiPWr2pfl67dk/6zxtgAAAAAAAAAqie7eePZXeVO33OtiOGsHqtvfjDi1scibnkkesafipHVI3HuQi3a3Yh3rpsZT/+5ZvTweM3oAAAAAAAAAKolH2q0byzf+dtuZ9G/8b0RW+587ezat0a84xPR+8z+aHU7MVDvbLhl05lrf3FyaGr08Hj5muA4/qMfmiIAAAAAAABABWS1KPJLTW75UR+8/Ir6uksvCi6K+a/Dfa26sQEAAAAAAABUT/ZyJz+Z19IiL6J7eiLi/NRrZ4tuxNEfRzvmorcnoj2XvfL41MZTMV8XAwAAAAAAAFAh2eS5tU9kWcRAo4ipC9MRP98ZMfnNiH/8IOLJO+LMC7+ORl83Gj0RR5r9z8x08nOhAAYAAAAAAAConPyzT2976H1D//7YYL21ZW5NN442n4/ep/ddeuxzK+air68bb2pEdCN75dEj192Xfp4xNgAAAAAAAIDqyWY6+akHnt16d7Oz6uRAPWJkoIi1azuxek0nhge6MdQXUatlrZ8+P/L5706+ZSLKXhgAAAAAAACAyik3+s5+/++bJ+751fbbfv/S+kc7c/l0WQSva0TUe2rtIzNrJr7yxxs/8pnfbPteurY5vPlej38GAAAAAAAAqKC8LHRfPHZw9penNvwl5ZP1nrmB268/MdafX+x96sTQ8aMz/f9K102ntJS/AAAAAAAAANX1HwEGAM75MhcANnAkAAAAAElFTkSuQmCC")',r.style.backgroundRepeat="no-repeat",r.style.height="37px",r.style.width="100px",r.style.position="absolute",r.style.left="-3px",r.style.bottom="-3px",r.style.right="0px",e.appendChild(r);let i=document.createElement("div");i.style.height="50px",i.style.width="350px",i.style.position="absolute",i.style.left="97px",i.style.top="-60px",i.style.border="solid 1px #8E0EFF",i.style.background="linear-gradient(#00ffff, #00ffff) left top,  linear-gradient(#00ffff, #00ffff) left top,     linear-gradient(#00ffff, #00ffff) right bottom,    linear-gradient(#00ffff, #00ffff) right bottom",i.style.backgroundRepeat="no-repeat",i.style.backgroundColor="rgba(87,255,255, 0.3)",i.style.backgroundSize="1px 6px, 6px 1px",i.style.fontSize="18px",i.style.color="#ffffff",i.innerHTML=`<div style='margin: 15px 5px 15px 5px'>${t}</div>`,e.appendChild(i);let a=new u.default.Marker({element:e,anchor:"bottom-left"});return a.setLngLat(s).addTo(o),a},Vt=(o,s)=>o.hasVectorLayer()?qe(o,s):Qe(o,s),Qe=(o,s)=>{s=s||{};const t=o.getService(),e=new Set;let r="",i={};const a=f=>{var d,m;i={backcolor:(d=t.currentMapParam())!=null&&d.darkMode?0:16777215,expression:r,...f,...s==null?void 0:s.style},o.updateStyle(t,{name:(m=s==null?void 0:s.styleName)!=null?m:"myCustomStyle_temp",...i})},n=f=>{let d="";return f!==void 0&&(d+=`gOutVisible:=${f?1:0};`),d},l=f=>(Array.isArray(f)||(f=[f]),`gInObjectId  in  '${f.join("||")}'`),c=async()=>{if(e.size==0)r="",await a();else{let f=l(Array.from(e)),d=n(!1);r=`if(${f}) {${d} } `,await a()}};return{addHideObjectIds:async(f,d,m)=>{m&&e.clear(),f.forEach(g=>e.add(g)),d||await c()},refresh:c,hideObjectIds:e,getClipBounds:()=>{var f,d;if((f=s==null?void 0:s.style)!=null&&f.clipbounds)return(d=s==null?void 0:s.style)==null?void 0:d.clipbounds}}},qe=(o,s)=>{const t=o.getService(),e=new Set,r=l=>(Array.isArray(l)||(l=[l]),["match",["id"],l,!0,!1]),i=async()=>{let l=t.vectorStyle().layers.map(h=>h.id),c=Array.from(e);o.setFilterEx(l,["!",r(c)])};return{addHideObjectIds:async(l,c,h)=>{h&&e.clear(),l.forEach(y=>e.add(y)),c||await i()},refresh:i,hideObjectIds:e,getClipBounds:()=>{var l,c;if((l=s==null?void 0:s.style)!=null&&l.clipbounds)return(c=s==null?void 0:s.style)==null?void 0:c.clipbounds}}};p.CacheDbStorage=ke,p.LayerBase=x,p.MapApp=it,p.ProcessDataToFeatureCollection=le,p.TsIndexDb=W,p.WmsOverlayMapType=Ee,p.addExportRefInfoInText=ye,p.addFeaturesToDraw=H,p.addHighLightSourceLayer=ze,p.base2OverlayCoordinate=rt,p.cacheStorage=Q,p.cad2webCoordinate=Ne,p.cancelDraw=_e,p.clearHighLightSourceLayer=te,p.clearHighlight=me,p.convertArrayToGeoJson=ue,p.copyCadEntity=lt,p.createGeomData=G,p.createHatch=kt,p.createLineTypeCurve=St,p.createLineTypePolyline=Ct,p.createMapStyleLayerName=$,p.createOutSymbol=xt,p.createUpdateMapStyleObj=Vt,p.createUpdateMapStyleRasterObj=Qe,p.createUpdateMapStyleVectorObj=qe,p.default=Xe,p.deleteCadEntity=at,p.drawArrow=Dt,p.drawCircle=gt,p.drawEllipseArc=vt,p.drawEllipseEdge=bt,p.drawEllipseFill=wt,p.drawEllipseFillArc=Lt,p.drawFillExrusion=ht,p.drawLineSting=dt,p.drawPoint=ct,p.drawPolygon=ft,p.drawRectangle=yt,p.drawSlantRectangle=mt,p.drawText=It,p.editCadEntity=re,p.evalDataConvert=xe,p.execProgram=Le,p.exportDwg=ot,p.gaodeProviderTiles=Te,p.getEntityObjectId=Y,p.getEpsgRange=st,p.getGeoJsonBounds=be,p.getHighlightEntities=We,p.getInstance=Se,p.getMapSnapPoints=Ae,p.getPointOnePixelDrawStyleOption=Tt,p.getQueryGeomData=Ze,p.getShardsTileUrl=ae,p.getTileShards=ve,p.getTrackFeatureProperty=V,p.getWmsAutoCadBaseMapTileUrl=Re,p.getWmsAutoWebBaseMapTileUrl=Oe,p.getWmsDirectTileUrl=Be,p.getWmsMapsBounds=Pe,p.getWmsParamTileUrl=Ve,p.getWmsTileUrl=je,p.initIndexDb=Ce,p.interactiveCreateGeom=q,p.isAlphanumeric=ne,p.isTrackFeature=ee,p.isWebBaseMap=R,p.listenKeyEvent=ce,p.loadDataToDraw=ut,p.loadWebMap=Fe,p.modifyCadEntity=nt,p.osmProviderTiles=et,p.overlay2BaseCoordinate=Ge,p.polygonToPolyline=se,p.providerLayers=De,p.queryMapData=X,p.requestChangeData=U,p.runMeasureCmd=Mt,p.selectFeatures=Ue,p.selectRotate=pt,p.setFeatureProperty=B,p.setLayerOpacity=Et,p.setLayerToLowest=Pt,p.setTrackFeatureProperty=He,p.sleep=oe,p.switchCadLayers=Ft,p.switchVectorLayers=Ke,p.tiandituProviderTiles=Ie,p.toBezierCurve=At,p.toMapLayer=P,p.toProperties=N,p.transformGeoJsonData=j,p.web2cadCoordinate=tt,Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=vjcommon.min.js.map
